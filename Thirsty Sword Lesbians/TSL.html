<script type="text/worker">

	// data

	var codeVersion = "1.001";
	var xpmax = 5;
	
	// For TSL, all playbooks have identical advancement options, so that's the reduced-case I'll implement here.
	// Advances model will need to be expanded for other playbooks when supporting other PBTA
	
	// English data here, translation will occur internal to functions
	
	var advances = [
		{
			text: "Take another move from your playbook",
		},
		{
			text: "Take another move from your playbook",
		},
		{
			text: "Take a move from any playbook",
		},
		{
			text: "Take a move from any playbook",
		},
		{
			text: "Add 1 to a stat (max stat of 3)",
		},
		{
			text: "Add 1 to a stat (max stat of 3)",
		},
		{
			text: "Switch to a new playbook",
			preamble: "Your first five Advances must be from the top six on the list. After you take your fifth Advance, you can choose to switch to another playbook or live happily ever after. Choose one of these last two options when the emotional conflict at the core of your playbook has been resolved or eclipsed by a new conflict corresponding to a new playbook.",
		},
		{
			text: "Live happily ever after",
		}
	];

	var looks = {
		demeanor: "Demeanor",
		clothes: "Clothes",
		sword: "Sword"
	};
	
	// Do I want to process the internationalization outside of various handlers? I feel like keeping them inside the handlers means it doesn't try until it's needed, and most of the translation only happens during a one-time setup, with a few small exceptions. 

	/*
	for(var [k,v] of Object.entries(looks)) {
		looks[k] = gTBK(v);
	}
	*/

	var stats = {
		daring: "Daring",
		grace: "Grace",
		heart: "Heart",
		wit: "Wit",
		spirit: "Spirit"
	};
	
	var sdesc = {
		daring: "skill at arms, forcefulness",
		grace: "elegance, agility",
		heart: "emotional awareness, expression",
		wit: "cleverness, knowledge",
		spirit: "integrity, metaphysical power"
	};

	var conditions = {
		angry: {
			name: "Angry",
			penalty: -2,
			penalized: "Figure Out a Person",
			clearwhen: "To clear, break something important to you or someone you care about",
			marked: ""
		},
		frightened: {
			name: "Frightened",
			penalty: -2,
			penalized: "Fight",
			clearwhen: "To clear, run away and leave something important behind",
			marked: ""
		},
		guilty: {
			name: "Guilty",
			penalty: -2,
			penalized: "Emotional Support",
			clearwhen: "To clear, sacrifice something important just to hurt yourself for what you did",
			marked: ""
		},
		hopeless: {
			name: "Hopeless",
			penalty: -2,
			penalized: "Defy Disaster",
			clearwhen: "To clear, lose yourself in escapism or pleasure when you should be doing something important",
			marked: ""
		},
		insecure: {
			name: "Insecure",
			penalty: -2,
			penalized: "Entice",
			clearwhen: "To clear, take rash action to confront the object of your jealousy and prove your worth without any plan or advice",
			marked: ""
		}
	};
	
	// Basic moves array, essentially the same as a playbook's, tho with those 'header' and 'subheader' bits. (Subheader bits might get deployed for playbook moves tho!)

	var basicmoves = [
		{
			header: "Basic Moves"
		},
		{
			subheader: "Danger Moves"
		},
		{
			name: "Fight",
			body: "When you seek to incapacitate someone with violence, roll +Daring or +Grace:",
			hit: "Choose 3 and your opponent chooses 1 to apply to you in response",
			mixed: "Choose 2 and your opponent chooses 1",
			mixedbullets: [
				"Flirt with or provoke your opponent and gain a String on them",
				"Through violence or cutting words, inflict a Condition",
				"Create an opportunity for an ally through prowess or distraction",
				"Take an object from your opponent or seize a superior position"
			],
			rolled: "yes"
		},
		{
			name: "Defy Disaster",
			body: "When you push your limits to achieve something extraordinary that’s not covered by another move, or to avert an imminent danger to yourself or someone else, say what you’re willing to sacrifice and pick your approach:",
			bullets: [
				"Might, endurance, or courage. +Daring",
				"Swiftness or elegance. +Grace",
				"Charm or social insight. +Heart",
				"Cleverness or knowledge. +Wit",
				"Willpower or metaphysical skill. +Spirit"
			],
			hit: "Do it with style. At the GM’s discretion, you may also learn new information, discover a new opportunity, or gain a String on someone.",
			mixed: "The GM will offer you a hard choice or success with a sacrifice.",
			rolled: "yes", // default no; if yes, there will be a roll button
		},
		{
			name: "Stagger (Reactive Move)",
			body: "When you suffer a staggering physical or emotional blow, choose an option from the following based on the number of Conditions you have marked.",
			preamble: "4 or 5 Conditions:", // a second paragraph usually introducing a set of options
			bullets: [
				"You’re rendered helpless for the scene",
				"You’re utterly humiliated and news will spread; this could be a consequence of a setback in the confrontation, or might be caused by something you confess in the heat of the moment",
				'Choose 2 from the "0–3 Conditions" options'
			],
			alternative: "0-3 Conditions:", // a second section introducing a second set of options
			altbullets: [
				"You lash out at someone whose regard matters to you: provoke them to do something foolish or harmful and take advantage of a String on them if you have one",
				"You hesitate or stumble and the opposition gains an opportunity",
				"You grin and bear the blow; mark two Conditions"
			],
			rolled: "no", // default no; if yes, there will be a roll button
		},
		{
			subheader: "Heartstring Moves"
		},
		{
			name: "Entice",
			body: "When you appeal to someone’s physical or romantic sensibilities, roll +Heart:",
			hit: "Gain a String on them and they choose 1",
			mixed: "Gain a String on them, unless they decide instead to choose 1",
			mixedbullets: [
				"Get flustered and awkward",
				"Promise something they think you want",
				"Give in to desire"
			],
			rolled: "yes", // default no; if yes, there will be a roll button
			rolldefault: "heart" 
		},
		{
			name: "Figure Out a Person",
			body: "When you try to understand a person, roll +Wit (+3 more if you spend a String on them):",
			hit: "You may ask 2 questions, now or later in the scene",
			mixed: "You may ask 2 questions, but they may ask 1 of you",
			mixedbullets: [
				"What are your feelings towards _____?",
				"What do you hope to get from _____?",
				"How could I get you to _____?",
				"What do you love most?",
				"How would you feel if I _____?"
			],
			rolled: "yes", // default no; if yes, there will be a roll button
			rolldefault: "wit" 
		},
		{
			name: "Emotional Support",
			body: "When you offer someone support in a way that could be meaningful to them, roll +Heart or +Spirit (+3 more if you spend a String on them):",
			hit: "If they open up to you, they choose 1, and you either choose 1 or take a String on them",
			mixed: "If they open up to you, they choose 1",
			mixedbullets: [
				"Clear a Condition",
				"Mark XP",
				"+1 forward",
				"Gain insight from the GM about an obstacle facing one of you"
			],
			alternative: "If they’re Smitten with you, they may choose an additional option.", 
			end: "If you’re Smitten with them and they refuse to open up to you, it stings. You mark a Condition.", // a closing paragraph
			rolled: "yes"
		},
		{
			name: "Finally Kiss, in a Dangerous Situation",
			body: "When people finally kiss after a period of tension, each takes +1 ongoing to get to safety and protect the other for the rest of the scene.",
			preamble: "If more than two people finally kiss in these circumstances, they all get the bonus. Each participant must be enthusiastic about kissing to trigger this move.", // a second paragraph usually introducing a set of options
			rolled: "no"
		},
		{
			name: "Influence With a String",
			body: "At any time, spend a String on someone to do one of the following:",
			bullets: [
				"Offer them an XP to do something (don’t spend the String if they refuse the temptation)",
				"Find out what it will take to get them to do what you want (for an NPC, spending the String means they may simply agree)",
				"Add 1 to your roll against them (after rolling)",
				"Add or subtract 1 from any roll they make (after rolling)"
			],
			end: "Each character may only spend one String to add or subtract from a given roll.", // a closing paragraph
			rolled: "no", // default no; if yes, there will be a roll button
		},
		{
			name: "String Advance",
			body: "If you gain a fourth String on someone, you have a profound insight and learn something about them that even they don’t know; the player tells you what you learn, possibly asking the GM for ideas. It’s up to you whether you share that insight with the character or not. In addition, clear all but one of your Strings on them and gain 2 XP.",
			rolled: "no"
		},
		{
			name: "Smitten",
			body: "When you become Smitten with someone (always your choice), say why, give them a String on you, and answer the question in the Truths of Heart and Blade section of your playbook.",
			rolled: "no", // default no; if yes, there will be a roll button
			rolldefault: "It gains a String on you" 
		},
		{
			subheader: "Special Moves"
		},
		{
			name: "Call on a Toxic Power",
			body: "When you parley with a Toxic Power, ask it your question and roll +Spirit:",
			hit: "It answers the question and grants you +1 forward to act on the information",
			mixed: "It answers the question and the GM chooses 1",
			mixedbullets: [
				"It takes something from you, either knowledge, reputation, or something physical",
				"You mark a Condition",
				"It gains a String on you"
			],
			rolled: "yes", // default no; if yes, there will be a roll button
			rolldefault: "spirit" 
		},
		{
			name: "End of Session",
			body: "Each player marks XP if, during the session:",
			bullets: [
				"Any PC confessed their love",
				"Any PC struck a blow against oppression or de-escalated a violent situation",
				"Any PC leapt into danger with daring and panache",
				"Any player used a safety tool such as the palette or Check-In Card"
			],
			rolled: "no"
		}
	];

	var moveoptions = ["alternative", "altbullet0", "altbullet1", "altbullet2", "altbullet3", "altbullet4", "althit", "althitbullet0", "althitbullet1", "althitbullet2", "althitbullet3", "althitbullet4", "altmiss", "altmissbullet0", "altmissbullet1", "altmissbullet2", "altmissbullet3", "altmissbullet4", "altmixed", "altmixedbullet0", "altmixedbullet1", "altmixedbullet2", "altmixedbullet3", "altmixedbullet4", "blankname0", "blankname1", "blankname2", "blankname3", "blankname4", "bullet0", "bullet1", "bullet2", "bullet3", "bullet4", "end", "hit", "hitbullet0", "hitbullet1", "hitbullet2", "hitbullet3", "hitbullet4", "miss", "missbullet0", "missbullet1", "missbullet2", "missbullet3", "missbullet4", "mixed", "mixedbullet0", "mixedbullet1", "mixedbullet2", "mixedbullet3", "mixedbullet4", "preamble"]; // special cases: "blank0", "blank1", "blank2", "blank3", "blank4"

	// =============================================================================

	// BIG playbooks data set
	
	var playbooks = {
		"beast": { 
			name: "The Beast",
			bio: "The Beast follows their truth and their passions, which puts them in conflict with civilization and civilized norms. Unless they give up what makes them special and powerful, they cannot make themself acceptable to that civilized society. Their central conflict is living their truth versus fitting in with a dominant social order. Example Archetypes: Ranger Between Worlds, Bitten, Raised by Beasts",
			relationships: [
				"Who most reminds you of a beast?",
				"Who most reminds you of prey?",
				"Who has seen you at your most bestial?"
			],
			look: {
				demeanor: "wild demeanor, hungry demeanor, piercing demeanor",
				clothes: "torn clothes, practical clothes, chitinous clothes, raider's clothes",
				sword: "a cold-wrought sword, a sword of teeth, a found sword"
			},
			startstats: [
				{ daring: 1, grace: 0, heart: 1, wit: -1, spirit: 0 },
				{ daring: 1, grace: 1, heart: -1, wit: 0, spirit: 0 }
			],
			moves: [
				{
					subheader: "Feral",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Feral",
					tracklabel: "Feral",
					body: "You may walk in civilized circles, but sooner or later your feral truth will come to the fore. Your Feral score starts at 1. If it hits 4, you can't hold back the beast any longer and you Transform. If your Feral drops to 0, you lose access to all your Beast playbook moves until it increases again. On the plus side, you're fitting in. You blend. You've assimilated.",
					preamble: "Increase Feral when:",
					bullets: [
						"You express yourself in a shocking way through your appearance",
						"You display intense emotion that society wants you to conceal"
					],
					alternative: "Decrease Feral when:",
					altbullets: [
						"You feel that your bestial nature has hurt someone you care about",
						"You go along with an uncomfortable interaction to fit in"
					],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					subheader: "Playbook Moves",
					instructions: "(start with the move marked and choose two more)",
					pbdefault: "yes"
				},
				{
					name: "Transform",
					body: "You have a bestial form, which you can assume at will and must assume whenever your Feral hits 4. When you do, tell everyone what the beast in you looks like, increase your Feral to 4 if it’s not there already, and roll +Daring:",
					hit: "Choose 2",
					mixed: "Choose 1",
					rolled: "yes",
					rolldefault: "daring",
					mixedbullets: [
						"You are in harmony with your beast and may clear a Condition",
						"You are magnificent and little escapes your notice; you gain leverage or an opportunity with a monster",
						"Pain is nothing to you; ignore the next time you would Stagger while transformed",
						"You can move in ways no ordinary person could"
					],
					end: "You revert to your usual form when your Feral drops below 4. While transformed, you may mark a Condition to avoid reducing your Feral, as often as you like.",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Big Dyke Energy",
					body: "When you make it clear to your foes that you’re the biggest threat, then for the rest of the scene, whenever you roll a 10+, you may choose someone present to be impressed or intrigued with you. Once during the scene, when you gain a String on someone, gain an additional String on someone else who considers you an enemy"
				},
				{
					name: "Ferocious",
					body: "When you Fight, you may mark a Condition to choose an additional option, even on a 6-."
				},
				{
					name: "Shameless",
					body: "When you say aloud what you want from an NPC, you may give them a String on you to ask a question about them from the Figure Out move."
				},
				{
					name: "Tenacious Purpose",
					body: "When you commit yourself to a specific goal, you may ask the GM once per scene how you could advance that goal in a way that violates “civilized” norms. Take +1 forward to act on the answer. If you refrain, it counts as an uncomfortable situation that reduces your Feral by 1 and you must mark a Condition.",
					pbother: "no"
				},
				{
					name: "Tracker",
					body: "When you investigate a person’s living space, camp, or trail, or an object important to them, you can roll +Heart instead of +Wit to Figure Them Out, and may do so even when they’re not present. You can also ask the question, “Where did they go?” as if it were an option on the list for that move. On a 7–9, they take a String on you instead of asking a question back. Say why. Do they just smell that good or that fearsome?",
					rolled: "yes",
					rolldefault: "heart"
				},
				{
					subheader: "Truths of Heart and Blade",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Smitten Kitten",
					body: "When you become Smitten with someone, say why, give them a String, and answer this question:",
					bullets: [
						"What have you done that you are sure they view as inappropriate?"
					],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "The Bloody Truth",
					body: "When you Figure Out a Person in physical conflict, you may additionally ask one of these questions, even on a 6-:",
					bullets: [
						"What awakens the beast inside you?", "How could I get you to kiss me?"
					],
					pbdefault: "yes",
					pbother: "no"
				}
			]
		},
		"chosen": { 
			name: "The Chosen",
			bio: "The Chosen playbook revolves around special status, relationships across social strata, and the crushing expectations of fate, family, or the adoring public. Their central conflict is inner truth versus crushing social expectations. Example Archetypes: Magical Princess, Pop Idol, Chosen One",
			relationships: [
				"Who believes in the importance of your Destiny?",
				"Who makes you feel like an ordinary person?",
				"Who is just as important to you as your Destiny?"
			],
			look: {
				demeanor: "Stoic demeanor, benevolent demeanor, authoritative demeanor",
				clothes: "Fancy clothes, holy vestments, clothes denoting status",
				sword: "A bejeweled sword, an ancestral sword, a holy sword"
			},
			startstats: [
				{ daring: -1, grace: 1, heart: 1, wit: 0, spirit: 0 },
				{ daring: 0, grace: 1, heart: 0, wit: 1, spirit: -1 }
			],
			moves: [
				{
					subheader: "Destiny",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Destiny",
					body: "They keep telling you that you have a Destiny, but it’s not what your heart truly desires. What is it?",
					preamble: "Destiny Examples:",
					bullets: [
						"Marry the Prince of Heteronormia",
						"Be sacrificed to appease the Horror",
						"Banish magic from the world",
						"Melt the heart of the Undying One"
					],
					alternative: "Choose two Heroic Aspects and two Tragic Aspects from the following lists. When you act in accordance with one of your Aspects, check it off and take +1 forward. If it’s a Tragic Aspect, also mark XP. When all four Aspects are checked off, describe how your Destiny grows ever nearer, then erase the check marks and begin again.",
					end: "You may fulfill your Destiny in the course of play, or reject it so firmly that you no longer feel pressure to fulfill it. This deserves a climactic scene either way, and trying to reject your Destiny draws the full wrath of your Aspects and those pressing you to fulfill it. Afterwards, choose a new Destiny, adopt a new playbook, or live happily ever after.",
					blanks: [
						{
							name: "Heroic Aspect",
							suggestions: "Portents & Prophecies, Spiritual Prowess, Heir to a Mystic Power, Prominent Suitors, Save Your World, Soother of Monsters, Help of the Masses, Chosen by a God, Legendary Skill",
							checkbox: "yes"
						},
						{
							name: "Heroic Aspect",
							suggestions: "Portents & Prophecies, Spiritual Prowess, Heir to a Mystic Power, Prominent Suitors, Save Your World, Soother of Monsters, Help of the Masses, Chosen by a God, Legendary Skill",
							checkbox: "yes"
						},
						{
							name: "Tragic Aspect",
							suggestions: "Love that Cannot Be, End of the Universe, Lose Those You Love, Arch-Nemesis, Bitter Rival, Betrayal, Seduced by Evil, Coveted Destiny, The End of Love Itself",
							checkbox: "yes"
						},
						{
							name: "Tragic Aspect",
							suggestions: "Love that Cannot Be, End of the Universe, Lose Those You Love, Arch-Nemesis, Bitter Rival, Betrayal, Seduced by Evil, Coveted Destiny, The End of Love Itself",
							checkbox: "yes"
						}
					],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					subheader: "Playbook Moves",
					pbdefault: "yes",
					instructions: "(start with the move marked and choose two more)"
				},
				{
					name: "The Fated Day Approaches",
					body: "Whenever you miss an opportunity to make progress towards your Destiny, choose 1:",
					bullets: [
						"Someone with power over you makes an uncomfortable demand in furtherance of your Destiny, backed by a threat",
						"The PC you care about the most receives bad news or has an accident serious enough to make them Stagger"
					],
					end: "The GM will tell you the details, inspired by your Destiny. They may wait until a lull in the action to drop the consequences on you.",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Don’t You Know Who I Am?",
					body: "When you meet someone who knows you by reputation (you decide), roll +Heart:",
					hit: "Say two things they’ve heard about you",
					mixed: "You say one, the GM says one",
					rolled: "yes",
					rolldefault: "heart",
					pbdefault: "no"
				},
				{
					name: "Entourage",
					body: "You have a group of loyal attendants. Name three of them who accompany you and choose a trait for them: Dangerous, Fanatical, Resourceful, Charming",
					preamble: "Choose a basic move. Your entourage grants you a +1 on rolls for this move when present. When you would Stagger, you may choose instead for one of your named Entourage to die. If you do, your Entourage gains a String on you.",
					blanks: [
						{
							name: "Member Names"
						},
						{
							name: "Entourage Trait",
							suggestions: "Dangerous, Fanatical, Resourceful, Charming"
						},
						{
							name: "Basic Move Receiving +1",
							suggestions: "Fight, Defy Disaster, Entice, Figure Out a Person, Emotional Support, Call on a Toxic Power"
						}
					],
					pbdefault: "no"
				},
				{
					name: "Gossip",
					body: "When you seek insight about a person by spending some time gossiping with those who know them, roll +Wit:",
					hit: "You learn a dangerous secret and gain a String on the target. You may also ask a question from the Figure Out a Person move.",
					mixed: "You may ask a question from the Figure Out a Person move.",
					end: "Someone you speak to who is dangerous to you may ask a question of you from the same list.",
					rolled: "yes",
					rolldefault: "wit",
					pbdefault: "no"
				},
				{
					name: "Guidance from Above",
					body: "When you petition a superior for guidance, they give you instructions and useful information. Mark XP or clear a Condition if you do as commanded. They gain a String on you if you do otherwise.",
					pbdefault: "no"
				},
				{
					name: "Help Me~~!",
					body: "You’re a magnet for trouble and hunted by those who would use you for their own purposes. Others mark XP when they Defy Disaster that would otherwise befall you. In addition, whenever you’re captured, your captor reveals something they hope to achieve; gain a String on them and mark XP.",
					pbdefault: "no"
				},
				{
					name: "Know Your Place!",
					body: "When someone dares insult you and you deliver a scathing retort, roll +Wit",
					hit: "Word spreads of your sharp wit, take +1 forward, and they choose 1",
					mixed: "They choose 1",
					mixedbullets: [
						"Back down",
						"Make a fool of themself",
						"Attack you"
					],
					rolled: "yes",
					rolldefault: "wit",
					pbdefault: "no"
				},
				{
					subheader: "Truths of Heart and Blade",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Love Is Not My Destiny",
					body: "When you become Smitten with someone, say why, give them a String, and answer this question:",
					bullets: [ "How do our respective stations make it impossible to be together?" ],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Inescapable Conclusions",
					body: "When you Figure Out a Person during a physical conflict, you may ask one additional question from this list, even on a 6-:",
					bullets: [
						"What do you hope for your future?", "What do you fear is your destiny?"
					],
					pbdefault: "yes",
					pbother: "no"
				}
			]
		},
		"devoted": { 
			name: "The Devoted",
			bio: "The Devoted is a selfless protector, committed to a person or a cause. Their central conflict lies in pitting this devotion against self-care. Example Archetypes: Sidekick, Champion, Protective Friend",
			relationships: [
				"Is another PC an object of your Devotion?",
				"Who looks out for you even when you don’t look out for yourself?",
				"Who did you save from a terrible fate?"
			],
			look: {
				demeanor: "Hard demeanor, affectionate demeanor, alert demeanor",
				clothes: "Armor, uniform, sturdy clothes",
				sword: "A bestowed sword, a well-worn sword, a defensive sword"
			},
			startstats: [
				{ daring: 1, grace: 0, heart: 0, wit: -1, spirit: 1 },
				{ daring: 1, grace: 1, heart: -1, wit: 0, spirit: 0 }
			],
			moves: [
				{
					subheader: "Devotion",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Devotion",
					body: "Choose a Devotion from the example lists or invent one of your own. What three tenets of your Devotion have you found yourself tempted to violate?",
					preamble: "Mark a Condition if you act contrary to your Devotion, for instance by violating its tenets or disobeying a superior.",
					end: "When you Defy Disaster, you may bring a subject of your Devotion with you safely.",
					blanks: [
						{
							name: "My Devotion",
							suggestions: "To a cause: Freedom, vengeance, justice, love, the gay agenda. To a person: A PC, a liege, an idol. To a higher power: A god, a sexy dragon, a sentient planet."
						},
						{
							name: "Tenet 1" 
						},
						{
							name: "Tenet 2" 
						},
						{
							name: "Tenet 3" 
						}
					],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Last Stand",
					body: "When you face a superior foe on behalf of your Devotion, you may roll +Conditions (the number of Conditions you have marked) instead of the normal stat to Fight or to Defy Disaster that’s about to befall someone else.",
					rolled: "yes",
					rolldefault: "conditions-marked",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "What’s Best for Them",
					body: "When you’re Smitten with someone, you may treat them as a subject of your Devotion. Also, when you take action to help them be romantic with someone other than you, mark XP.",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					subheader: "Playbook Moves",
					pbdefault: "yes",
					instructions: "(start with the move marked and choose two more)"
				},
				{
					name: "Fanatical Self-Sacrifice",
					body: "You may mark a Condition to prevent a Condition being inflicted on another. When you do, mark XP, and you may only clear that Condition by taking the associated destructive action. Mark it with an asterisk to remind yourself. Also, your Conditions only cause a –1 penalty to the associated basic moves (instead of –2).",
					pbdefault: "yes"
				},
				{
					name: "For the Cause!",
					body: "When you Fight the enemy of your Devotion, you can suffer a Condition to choose an additional option from the Fight move, even if you roll a 6-. You can inflict a Condition a second time within a single Fight move this way.",
					pbother: "no"
				},
				{
					name: "Gallant Rescue",
					body: "When you Defy Disaster that’s about to befall someone else, you can either gain a String on them or ask one of the following questions, even if you roll a 6-. You can only gain one String per scene in this way on any given person.",
					rolled: "yes",
					bullets: [
						"How do you feel about my Devotion?",
						"What secret pain lies in your heart?"
					]
				},
				{
					name: "Power of Conviction",
					body: "When you Entice someone while extolling the virtues of your Devotion or invoking its authority, you may roll +Spirit instead of +Heart. A superior in your Devotion gains a String on you, representing your dependence.",
					rolled: "yes",
					rolldefault: "spirit",
					pbother: "no"
				},
				{
					name: "Lay on Hands",
					body: "When you touch someone as part of Emotional Support, you heal their physical ailments. Tell them how your Devotion sustains you; they mark an XP if they validate your Devotion, and you gain a String on them if they criticize it.",
					rolled: "yes",
					pbother: "no"
				},
				{
					name: "Loyal Steed",
					body: "Name your steed and detail two strengths and two weaknesses from the lists given. When riding your steed, you may roll +Spirit to Fight and may take a person with you whenever you Defy Disaster.",
					rolled: "yes",
					rolldefault: "spirit",
					blanks: [
						{
							name: "Strengths",
							suggestions: "unthreatening, fast and agile, dangerous attack, hardy, stealthy, mental bond, flying (counts as both strength choices unless flight is common)"
						},
						{
							name: "Weaknesses",
							suggestions: "unusual diet, conspicuous, plodding, harmless, stubborn, collateral damage, vulnerable to something common"
						}
					]
				},
				{
					name: "Toxic Devotion",
					body: "Once per scene, when you forgive your Devotion for abusing you or make excuses for obvious problems with your Devotion, take +1 forward or mark XP. Also, once per scene, when you learn that another PC thinks your Devotion is problematic and you don’t defend it, mark a Condition and give them a String on you.",
					pbother: "no"
				},
				{
					subheader: "Truths of Heart and Blade",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "My Heart is Not Mine to Give",
					body: "When you become Smitten with someone, say why, give them a String, and answer this question:",
					bullets: [ "How does pursuing them conflict with your Devotion?" ],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "What Will You Fight For?",
					body: "When you Figure Out a Person during a physical conflict, you may additionally ask one of these questions, even on a 6-:",
					bullets: [ "What are you willing to risk death for?", "What kind of deeds earn your loyalty?" ],
					pbdefault: "yes",
					pbother: "no"
				}
			]
		},
		"infamous": { 
			name: "The Infamous",
			bio: "The Infamous once participated in wicked deeds, but they’ve become fiercely righteous in trying to atone. Their central conflict arises from the lasting consequences of their past actions and beliefs versus their new convictions. Will they repair the harm they caused, will they seek forgiveness, or will they despair? Will they find a new place to belong? Example Archetypes: Former Villain, Escaped Henchperson, Veteran of Dishonor",
			relationships: [
				"Whom have you wronged the most? Do they know it was you?",
				"Who believes in you more than you believe in yourself?",
				"Who talks to you about things they wouldn’t discuss with others because of your past?"
			],
			look: {
				demeanor: "Haunted demeanor, challenging demeanor, disdainful demeanor",
				clothes: "Dangerous clothes, unremarkable clothes, transgressive clothes",
				sword: "A broken sword, a wicked sword, an enemy’s sword"
			},
			startstats: [
				{ daring: 1, grace: -1, heart: 0, wit: 0, spirit: 1 },
				{ daring: 1, grace: 0, heart: 0, wit: 1, spirit: -1 }
			],
			moves: [
				{
					subheader: "What Cannot Be Undone",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "What Cannot Be Undone",
					body: "You’ve hurt people, and they have no obligation to forgive you or engage with you.",
					preamble: "Before defining Relationships in character creation, propose a wicked past that you think could be forgiven, and ask each PC this question:",
					bullets: [
						"What circumstances or subsequent deeds could make it possible to forgive this past?"
					],
					alternative: "If anyone hesitates or can’t answer the question, revisit your past and tone it down. You can tone down the gravity of your backstory by reducing the severity of your deeds or the agency you had in enacting them. Afterwards, answer these questions:",
					altbullets: [
						"What personal growth are you proud of?",
						"What about your past causes you the most grief?",
						"You swore to never again perform certain actions that could lead to harm. What are they? Examples include: Lying, stealing, accepting someone’s love, drawing blood, or breaking a promise. If you break your vow, you Stagger. Then decide whether to keep the vow or abandon it."
					],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					subheader: "Playbook Moves",
					pbdefault: "yes",
					instructions: "(start with the moves marked and choose two more)"
				},
				{
					name: "Wicked Past",
					body: "When you hear about a villain for the first time, you may decide that you know them from your past. If so, give them a String on you to ask a question from the Figure Out a Person list and take +1 forward against them.",
					pbdefault: "yes"
				},
				{
					name: "Make It Right",
					body: "When you allow yourself to be vulnerable to someone you hurt during your villainous past, they choose 1",
					bullets: [
						"Decline to engage; they gain a String on you",
						"Lash out; you Stagger",
						"Guide you; they mark XP and give you a task to help make amends",
						"Show vulnerability; you take +1 forward to interact with them",
						"Forgive you; you each clear a Condition and this move no longer triggers with this person"
					],
					pbdefault: "yes"
				},
				{
					name: "Always Suspect",
					body: "When you pretend to be a villain to win a villain’s trust, they trust you enough to offer you an opportunity and you gain a String on them. You must choose one of the following options:",
					bullets: [ 
						"Someone watching comes to the worst possible conclusion",
						"The villain requires an act of villainy to prove your intentions first",
						"The villain is only pretending to trust you and the opportunity is a trap"
					]
				},
				{
					name: "Talons of the Past",
					body: "When you gain a String on someone associated with your villainous past, or vice versa, mark XP. The first time this happens for a given person, you each can define a secret or vulnerability you know about the other."
				},
				{
					name: "They Can Change, Too",
					body: "When you give up an advantage on someone dangerous because you believe they can mend their wicked ways, you can ask a question as if you’d Figured Them Out."
				},
				{
					name: "Used to Disappointment",
					body: "When you rely upon or trust someone else with something important, say how you expect them to let you down.",
					bullets: [
						"If they pleasantly surprise you, they gain a String on you",
						"If they do as you expect, choose 1: they lose a String on you, or you gain a String on them",
						"If they are somehow even worse than you expected, you have a choice: berate them and inflict a Condition, or swallow your loneliness and take a Condition yourself"
					]
				},
				{
					name: "What Makes a Home",
					body: "If every other PC in a scene has a String on you, your Conditions cause you only a –1 penalty instead of a –2 to the associated basic moves."
				},
				{
					name: "Who’s the Monster?",
					body: "When you expose the hypocrisy of someone who is supposedly virtuous, roll +Daring:",
					rolled: "yes",
					rolldefault: "daring",
					hit: "Gain a String on them and choose 1",
					mixed: "Choose 1",
					mixedbullets: [
						"The wrongness of their act is exposed to all; they mark XP if they change their mind. If they don’t, they must attack you or take a Condition.",
						"Your words sting; they take a Condition.",
						"You impress an onlooker; gain a String on them."
					]
				},
				{
					subheader: "Truths of Heart and Blade",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Undeserving",
					body: "When you become Smitten with someone, say why, give them a String, and answer this question:",
					bullets: [
						"Why do you think they would be wrong to forgive you?"
					],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Your Wicked Heart",
					body: "When you Figure Out a Person during physical conflict, you may additionally ask one of these questions, even on a 6-:",
					bullets: [
						"What are you most ashamed of?", "How could I get you to betray your ideals?"
					],
					pbdefault: "yes",
					pbother: "no"
				}
			]
		},
		"nature witch": { 
			name: "The Nature Witch",
			bio: "The Nature Witch is deeply connected to their environment and less experienced when it comes to people. They’re either new to socializing or are newly exploring what it feels like to socialize as their true self. Their central conflict revolves around the growth that their explorations will require from them and those who love them. Example Archetypes: Oblivious Horse Girl, Beacon of Kindness, Plant Geek Babygay",
			relationships: [
				"Who sees your potential?",
				"Who thinks you’re perfect the way you are?",
				"Who thought they took you on a date when you thought it was just a fun, friendly time?"
			],
			look: {
				demeanor: "Innocent demeanor, wise demeanor, sad demeanor",
				clothes: "Modest clothes, rough clothes, simple clothes",
				sword: "A wooden sword, a harmless sword, an elemental sword"
			},
			startstats: [
				{ daring: -1, grace: 0, heart: 1, wit: 0, spirit: 1 },
				{ daring: -1, grace: 1, heart: 0, wit: 0, spirit: 1 }
			],
			moves: [
				{
					subheader: "Curiosity",
					pbdefault: "yes"
				},
				{
					name: "Curiosity",
					body: "Dealing with people feels new to you and you might be awkward, but you want to learn. What better way to learn than by doing?",
					preamble: "Choose four Trials from the list. When you complete a chosen Trial, mark it and choose one: mark XP, clear a Condition, or take a String on someone involved. When your four chosen Trials are all fulfilled, reflect on what you’ve learned about yourself and pick four more. If you complete the entire list, choose the ones that meant the most to you and then evolve into a new form of life inspired by those experiences. Adopt a new playbook, remain a Nature Witch, or retire to live happily ever after.",
					blanks: [
						{
							name: "Trial 1",
							checkbox: "yes",
							suggestions: "Ride a fantastical creature. Win a duel. Go somewhere no person has tread before. Fall in love. Stick up for yourself, though it breaks someone’s heart. Lose someone you care about. Befriend someone very different from you. Liberate something dangerous. Receive a rare gift from someone you respect. Experience an altered state with a friend. Fail at something that means the world to you. Reject a conviction you once held. Extend kindness to someone who doesn’t deserve it. Achieve a lost cause. Throw away something comfortable to pursue a dream. Kiss someone dangerous. Forgive someone who deserves forgiveness. Trust someone with your secrets, only to be betrayed. Shock someone with an unwelcome truth. Earn forgiveness for a misdeed."
						},
						{
							name: "Trial 2",
							checkbox: "yes",
							suggestions: "Ride a fantastical creature. Win a duel. Go somewhere no person has tread before. Fall in love. Stick up for yourself, though it breaks someone’s heart. Lose someone you care about. Befriend someone very different from you. Liberate something dangerous. Receive a rare gift from someone you respect. Experience an altered state with a friend. Fail at something that means the world to you. Reject a conviction you once held. Extend kindness to someone who doesn’t deserve it. Achieve a lost cause. Throw away something comfortable to pursue a dream. Kiss someone dangerous. Forgive someone who deserves forgiveness. Trust someone with your secrets, only to be betrayed. Shock someone with an unwelcome truth. Earn forgiveness for a misdeed."
						},
						{
							name: "Trial 3",
							checkbox: "yes",
							suggestions: "Ride a fantastical creature. Win a duel. Go somewhere no person has tread before. Fall in love. Stick up for yourself, though it breaks someone’s heart. Lose someone you care about. Befriend someone very different from you. Liberate something dangerous. Receive a rare gift from someone you respect. Experience an altered state with a friend. Fail at something that means the world to you. Reject a conviction you once held. Extend kindness to someone who doesn’t deserve it. Achieve a lost cause. Throw away something comfortable to pursue a dream. Kiss someone dangerous. Forgive someone who deserves forgiveness. Trust someone with your secrets, only to be betrayed. Shock someone with an unwelcome truth. Earn forgiveness for a misdeed."
						},
						{
							name: "Trial 4",
							checkbox: "yes",
							suggestions: "Ride a fantastical creature. Win a duel. Go somewhere no person has tread before. Fall in love. Stick up for yourself, though it breaks someone’s heart. Lose someone you care about. Befriend someone very different from you. Liberate something dangerous. Receive a rare gift from someone you respect. Experience an altered state with a friend. Fail at something that means the world to you. Reject a conviction you once held. Extend kindness to someone who doesn’t deserve it. Achieve a lost cause. Throw away something comfortable to pursue a dream. Kiss someone dangerous. Forgive someone who deserves forgiveness. Trust someone with your secrets, only to be betrayed. Shock someone with an unwelcome truth. Earn forgiveness for a misdeed."
						}
					],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					subheader: "Playbook Moves",
					pbdefault: "yes",
					instructions: "(start with the move marked and choose two more)"
				},
				{
					name: "Wild Friends",
					body: "You can speak with animals and plants and may Influence them with Strings just like other NPCs. Near your home, or anywhere you have spent a long period of time, animal and plant friends are always nearby when you want them.",
					pbdefault: "yes"
				},
				{
					name: "Awaken the Wild",
					body: "When you are in a safe position and attempt to commune with a place or non-sentient creature, roll +Spirit:",
					rolled: "yes",
					rolldefault: "spirit",
					hit: "Choose 1",
					mixed: "Choose 1, GM will offer you a hard choice or success at a cost",
					mixedbullets: [
						"You cleanse it of hurt, corruption, or sickness",
						"You alter its behavior, ecosystem, or atmosphere to one you choose",
						"You make it dangerous to a certain person or creature, or a type of person or creature"
					],
					end: "If you attempt this move while rushed or while distressed to the point of having three or more Conditions, it works as above, briefly, but afterwards the place or creature will fall dead and barren."
				},
				{
					name: "Familiar",
					body: "You have a cute animal as your loyal familiar. You can perceive the world through its senses whenever you choose and communicate with it at any distance. In addition, choose a basic move. When the familiar helps with that basic move or with Emotional Support, take +1 to your roll.",
					blanks: [
						{ 
							name: "Basic Move",
							suggestions: "Fight, Defy Disaster, Entice, Figure Out a Person, Call on a Toxic Power"
						}
					]
				},
				{
					name: "I Ship It",
					body: "When you want to make a match between two other people and talk up one to the other, roll +Heart:",
					rolled: "yes",
					rolldefault: "heart",
					hit: "You may give the listener a String on the other person or give the other person a String on the listener",
					mixed: "As above, and the listener can either take a String on you or give the other person a String on you",
					end: "Anyone involved may mark XP if they become Smitten with anyone else involved, including the Witch (immediately or later this session, maximum of 1 XP per PC)."
				},
				{
					name: "The Magic of Love",
					body: "When you’re Smitten with someone and proudly extol the power of love, either of you may spend a String on the other to gain the use of one of their playbook moves for one scene."
				},
				{
					name: "Nature’s Touch",
					body: "When you touch someone and let the power of the natural world flow into them, roll +Spirit:",
					rolled: "yes",
					rolldefault: "spirit",
					hit: "Choose 2",
					mixed: "Choose 1",
					mixedbullets: [
						"They may give you a String on them to clear a Condition",
						"They gain the ability to speak with plants and animals for the rest of the scene",
						"They must answer one of the Figure Out a Person questions of your choice or else they take a Condition"
					]
				},
				{
					subheader: "Truths of Heart and Blade",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Love Conquers All",
					body: "When you become Smitten with someone, say why, give them a String, and answer this question:",
					bullets: ["What is a clear challenge to being with them that you’re overlooking because of your naivete?"],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Clear-Hearted Insight",
					body: "When you Figure Out a Person during a physical conflict, you may additionally ask one of these questions, even on a 6-:",
					bullets: ["What makes you feel loved?","What do you hope for the future?"],
					pbdefault: "yes",
					pbother: "no"
				}
			]
		},
		"scoundrel": { 
			name: "The Scoundrel",
			bio: "The Scoundrel is a hero of action and intense physicality. Their sword fights are punctuated by banter and flirtation and end in kisses as often as they end in bloodshed. Their central conflict lies in their urge to explore new horizons versus committing to purpose or security. Example Archetypes: Shimbo Pirate, Diva Fencing Champion, Dashing Jewel Thief",
			relationships: [
				"Who were you Smitten with until recently?",
				"Who replaced them in your desire?",
				"Who has almost as much flair as you?"
			],
			look: {
				demeanor: "Playful demeanor, provocative demeanor, eyes only for you",
				clothes: "Revealing clothes, flowing clothes, tight clothes, gaudy costume",
				sword: "A flashy sword, a famous sword, a delicate sword"
			},
			startstats: [
				{ daring: 1, grace: 1, heart: 0, wit: -1, spirit: 0 },
				{ daring: 1, grace: 0, heart: -1, wit: 1, spirit: 0 }
			],
			moves: [
				{
					subheader: "Living in the Moment",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Living in the Moment",
					body: "Why are you so fickle? Is there something you need to figure out about yourself, and you keep looking for it in other people instead? Are you afraid of the vulnerability that comes from investing in a relationship? Is your true love unattainable? Are you just that oblivious?",
					preamble: "Choose something that you’ll be able to grow past to give your character an emotional story arc. You don’t need to figure it out immediately, and the Scoundrel themself may not know at all.",
					blanks: [{name: "I may grow past"}],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					subheader: "Playbook Moves",
					pbdefault: "yes",
					instructions: "(start with the moves marked and choose two more)"
				},
				{
					name: "Heat of the Moment",
					body: "When you taunt someone into doing something they want to do but find unwise, roll +Daring:",
					rolled: "yes",
					rolldefault: "daring",
					preamble: "If the target is an NPC:",
					hit: "They'll do it in exchange for a small concession or reassurance",
					mixed: "They choose 1",
					mixedbullets: [
						"Create an opportunity for you or your allies",
						"They give you a String on them",
					],
					alternative: "If the target is a PC:",
					althit: "They mark XP if they do it, and must take a Condition if they don't",
					altmixed: "You choose 1",
					altmixedbullets: [
						"They mark XP if they do it",
						"They take a Condition if they don't"
					],
					end: "For either a PC or an NPC, if you aren’t already Smitten with them, you may choose to treat a 7–9 result as a 10+ by choosing to become Smitten with the target.",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Lust at First Sight",
					body: "When you become Smitten with someone you barely know, declare your undying love and give them a String on you. Lose your Smitten status with anyone who has no Strings on you. Take +1 forward to any act you think might impress your new interest.",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Shiny and New",
					body: "When you give or receive Emotional Support in an intimate moment with someone new, you each mark XP or clear a Condition.",
					pbdefault: "yes"
				},
				{
					name: "Better to Seek Forgiveness",
					body: "When you apologize to someone for your outrageous conduct and put yourself at their mercy, roll +Daring:",
					rolled: "yes",
					rolldefault: "daring",
					hit: "You find out what it will take for them to forgive you and you each gain a String on the other. If they forgive you, you each clear a Condition.",
					mixed: "You find out what it will take for them to forgive you. If you do it, you either take Strings on each other or they may clear a Condition, your choice."
				},
				{
					name: "Fools Rush In",
					body: "When you vault into a situation without forethought and wind up way over your head, give someone dangerous to you a String, mark XP, and take +1 forward to Defy Disaster."
				},
				{
					name: "Impressive Swordplay",
					body: "Whenever you roll a 7+ to Fight, you may gain a String on someone who is present and ask their player what it is about you that has impressed or intrigued them."
				},
				{
					name: "The Main Attraction",
					body: "When you make a dramatic entrance, roll +Grace:",
					rolled: "yes", rolldefault: "grace",
					hit: "Choose 2", mixed: "Choose 1",
					mixedbullets: [
						"All attention is focused on you for a moment",
						"You hold the attention of one person for as long as you deliver a dramatic speech",
						"Take a String on someone present",
						"You take +1 forward"
					]
				},
				{
					name: "One in Every Port",
					body: "When you return to any town you’ve been to before, name a person with whom you shared intimacy here and say how you left things. If you left on bad terms, mark XP and the GM will tell you something interesting that has changed since you were last here."
				},
				{
					name: "Rrrip!",
					body: "When you take or narrowly evade a physical blow from someone dangerous to you, you may declare that your clothes were damaged and are now practically indecent. For the remainder of the scene, when you roll a 10+ on any move against an NPC, you may declare that they have a crush on you (up to one NPC per roll and subject to GM discretion). Additionally, any PC who becomes Smitten with you during the remainder of the scene may mark XP."
				},
				{
					subheader: "Truths of Heart and Blade",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "To Love and Lose",
					body: "When you become Smitten with someone, say why, give them a String, and answer this question:",
					bullets: ["Why would your romance never last?"],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Repartée",
					body: "When you Figure Out a Person during a physical conflict, you may additionally ask one of these questions, even on a 6-:",
					bullets: ["What would make you run away with me?","Where did you learn to fight?"],
					pbdefault: "yes",
					pbother: "no"
				}
			]
		},
		"seeker": { 
			name: "The Seeker",
			bio: "The Seeker comes from a toxic society and has found a new community in which to belong and grow. Their central conflict pits tradition and upbringing against justice and developing their personal values. Example Archetypes: Immigrant from Heteronormia, Enclave-Raised, Privileged Background",
			relationships: [
				"Who reminds you of home?",
				"Who is the most outrageous of your new companions?",
				"Who is your model for local customs?"
			],
			look: {
				demeanor: "Guarded demeanor, curious demeanor, uptight demeanor",
				clothes: "Foreigner’s clothes, old-fashioned clothes, elaborate getup",
				sword: "An ancient sword, a brand-new sword, “That’s not a sword!”"
			},
			startstats: [
				{ daring: 1, grace: 0, heart: -1, wit: 1, spirit: 0 },
				{ daring: 0, grace: 1, heart: 0, wit: -1, spirit: 1 }
			],
			moves: [
				{
					subheader: "Tradition, Commandments, Conviction",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Tradition",
					tracklabel: "Tradition",
					body: "Tradition is a measure of how you feel your Authority would judge your behavior.",
					preamble: "Your Tradition starts at 1. Gain a point of Tradition whenever you make a personal sacrifice to act in accordance with your Commandments, to a maximum of 4. When you are at 4 Tradition, you incur a Condition each time you act contrary to your Commandments.",
					end: "Spend Tradition at any time to temper the wrath of the Authority, or to take +1 forward to follow your Commandments or Call on a Toxic Power.",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Commandments",
					body: "Describe the Authority that governed your upbringing and choose at least six Commandments the Authority has issued:",
					blanks: [
						{
							name: "Commandment", checkbox: "yes",
							suggestions: "Always answer an insult with a drawn sword. Never admit to your weak emotions. Always cover your sinful body. No intimacy until after a monogamous marriage. Never give when you can sell. Never let a weaker person fight their own battles. Never fight a weaker person’s battles. Always obey the Authority. Always obey a certain type of person (gender, race, class, belief, elders). Never go unchaperoned (or at all) with a certain type of person."
						},
						{
							name: "Commandment", checkbox: "yes",
							suggestions: "Always answer an insult with a drawn sword. Never admit to your weak emotions. Always cover your sinful body. No intimacy until after a monogamous marriage. Never give when you can sell. Never let a weaker person fight their own battles. Never fight a weaker person’s battles. Always obey the Authority. Always obey a certain type of person (gender, race, class, belief, elders). Never go unchaperoned (or at all) with a certain type of person."
						},
						{
							name: "Commandment", checkbox: "yes",
							suggestions: "Always answer an insult with a drawn sword. Never admit to your weak emotions. Always cover your sinful body. No intimacy until after a monogamous marriage. Never give when you can sell. Never let a weaker person fight their own battles. Never fight a weaker person’s battles. Always obey the Authority. Always obey a certain type of person (gender, race, class, belief, elders). Never go unchaperoned (or at all) with a certain type of person."
						},
						{
							name: "Commandment", checkbox: "yes",
							suggestions: "Always answer an insult with a drawn sword. Never admit to your weak emotions. Always cover your sinful body. No intimacy until after a monogamous marriage. Never give when you can sell. Never let a weaker person fight their own battles. Never fight a weaker person’s battles. Always obey the Authority. Always obey a certain type of person (gender, race, class, belief, elders). Never go unchaperoned (or at all) with a certain type of person."
						},
						{
							name: "Commandment", checkbox: "yes",
							suggestions: "Always answer an insult with a drawn sword. Never admit to your weak emotions. Always cover your sinful body. No intimacy until after a monogamous marriage. Never give when you can sell. Never let a weaker person fight their own battles. Never fight a weaker person’s battles. Always obey the Authority. Always obey a certain type of person (gender, race, class, belief, elders). Never go unchaperoned (or at all) with a certain type of person."
						},
						{
							name: "Commandment", checkbox: "yes",
							suggestions: "Always answer an insult with a drawn sword. Never admit to your weak emotions. Always cover your sinful body. No intimacy until after a monogamous marriage. Never give when you can sell. Never let a weaker person fight their own battles. Never fight a weaker person’s battles. Always obey the Authority. Always obey a certain type of person (gender, race, class, belief, elders). Never go unchaperoned (or at all) with a certain type of person."
						}
					],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Convictions",
					body: "When you break a Commandment and repudiate it forever, mark its checkbox and mark XP. Write a Conviction expressing your new beliefs, something that contradicts the Commandment.",
					preamble: "Each time you live up to a Conviction despite temptation or cost, reduce your Tradition by 1 and ask an onlooker if they agree with that Conviction. If they say yes, take a String on them and learn what holds them back from living up to it, if anything. If they say no, mark a Condition.",
					end: "Convictions should be bold statements that stand in contrast to the Commandments. Refer to the suggestions for each blank for ideas.",
					blanks: [
						{
							name: "Conviction",
							suggestions: "I care for myself as I would my dearest friend. Fear will not stop me from speaking the truth of my heart. I will fight for the well-being of those targeted by the Authority, if they wish it. I will atone for the harm I’ve done by liberating others from the Authority. When I see something unjust, I will educate those who can learn to do better and challenge those who must be overcome."
						},
						{
							name: "Conviction",
							suggestions: "I care for myself as I would my dearest friend. Fear will not stop me from speaking the truth of my heart. I will fight for the well-being of those targeted by the Authority, if they wish it. I will atone for the harm I’ve done by liberating others from the Authority. When I see something unjust, I will educate those who can learn to do better and challenge those who must be overcome."
						},
						{
							name: "Conviction",
							suggestions: "I care for myself as I would my dearest friend. Fear will not stop me from speaking the truth of my heart. I will fight for the well-being of those targeted by the Authority, if they wish it. I will atone for the harm I’ve done by liberating others from the Authority. When I see something unjust, I will educate those who can learn to do better and challenge those who must be overcome."
						},
						{
							name: "Conviction",
							suggestions: "I care for myself as I would my dearest friend. Fear will not stop me from speaking the truth of my heart. I will fight for the well-being of those targeted by the Authority, if they wish it. I will atone for the harm I’ve done by liberating others from the Authority. When I see something unjust, I will educate those who can learn to do better and challenge those who must be overcome."
						},
						{
							name: "Conviction",
							suggestions: "I care for myself as I would my dearest friend. Fear will not stop me from speaking the truth of my heart. I will fight for the well-being of those targeted by the Authority, if they wish it. I will atone for the harm I’ve done by liberating others from the Authority. When I see something unjust, I will educate those who can learn to do better and challenge those who must be overcome."
						},
						{
							name: "Conviction",
							suggestions: "I care for myself as I would my dearest friend. Fear will not stop me from speaking the truth of my heart. I will fight for the well-being of those targeted by the Authority, if they wish it. I will atone for the harm I’ve done by liberating others from the Authority. When I see something unjust, I will educate those who can learn to do better and challenge those who must be overcome."
						}
					],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					subheader: "Playbook Moves",
					pbdefault: "yes",
					instructions: "(start with the move marked and choose two more)"
				},
				{
					name: "People Are People",
					body: "When you talk about your home, roll +Heart:",
					rolled: "yes", rolldefault: "heart",
					hit: "Choose 2", mixed: "Choose 1",
					mixedbullets: [ "Admit a flaw about your home; gain +1 forward","Share something good about your home; clear a Condition","Lie about your home to impress a listener; take a String on them" ],
					pbdefault: "yes"
				},
				{
					name: "Hear Me!",
					body: "When you shout one of your Convictions aloud in confrontation with those who hold a contrary belief, roll +Daring:",
					rolled: "yes", rolldefault: "daring",
					hit: "Ask 2", mixed: "Ask 1",
					mixedbullets: [
						"Why do you think you have to follow that belief?","What does it cost you to follow that belief?","What do you wish for that is contrary to that belief?"
					]
				},
				{
					name: "It Wasn’t All Bad",
					body: "When you encounter someone whose perspective is different from that of your companions, share a relevant story from your home culture and roll +Spirit:",
					rolled: "yes", rolldefault: "spirit",
					hit: "Gain a String on them and either take +1 forward to interact with them or grant that +1 forward to a companion",
					mixed: "Gain a String on them",
					end: "In either case, they also tell you something interesting or useful about their upbringing."
				},
				{
					name: "Listen and Learn",
					body: "When you ask someone what you should do in an unfamiliar situation:",
					bullets: ["If you follow their advice, take +1 forward and clear a Condition","If you follow their advice and it goes poorly, mark XP"]
				},
				{
					name: "Proper Courtship",
					body: "When you’re Smitten with someone and perform an elaborate and roundabout courtship ritual…",
					bullets: ["If the recipient responds properly, you each get +1 forward to protect each other until either of you breaks a Commandment, and they gain a point of Tradition that they can spend for the same effects you can","If they don’t understand that you’re Smitten, give a String to an onlooker who does understand"],
					pbother: "no"
				},
				{
					name: "Silly Tourist",
					body: "When you Figure Out a Person or Defy Disaster by playing the fool, you may additionally ask a question from this list, even on a 6-:",
					bullets: ["What would make you laugh?","What hidden threat or opportunity am I missing?","How are you vulnerable?"]
				},
				{
					name: "Stiff Upper Lip",
					body: "You can spend a point of Tradition to ignore the -2 penalty caused by Conditions. This effect ends if you violate a Commandment or at the end of the scene. When the effect ends, take a Condition.",
					pbother: "no"
				},
				{
					subheader: "Truths of Heart and Blade",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "I Don’t Belong",
					body: "When you become Smitten with someone, say why, give them a String, and answer this question:",
					bullets: [ "Which of your values do they openly violate or decry?" ],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Not So Different",
					body: "When you Figure Out a Person during a physical conflict, you may additionally ask one of these questions, even on a 6-:",
					bullets: ["What prejudice do you hold?","What tradition do you most value?"],
					pbdefault: "yes",
					pbother: "no"
				}
			]
		},
		"spooky witch": { 
			name: "The Spooky Witch",
			bio: "The Spooky Witch is a weirdo who does their own thing while craving connection. They’ve found that many monsters are quite friendly if you give them a chance, but befriending them brands you a monster, as well. Their central conflict lies in navigating pressures to conform versus their own desires or those of their monstrous friends. Example archetypes: Spell Dancer, Nerdy Alchemist, Speaker for the Unseen",
			relationships: [
				"Who thinks you’re not all that weird?",
				"Whom have the Unseen warned you about?",
				"Who is your touchstone for what “normal” is?"
			],
			look: {
				demeanor: "Focused demeanor, playful demeanor, distant demeanor",
				clothes: "Wispy clothes, darker-than-black clothes, specialized clothes",
				sword: "An eldritch sword, a bone sword, a thirsty sword"
			},
			startstats: [
				{ daring: 0, grace: 0, heart: -1, wit: 1, spirit: 1 },
				{ daring: -1, grace: 1, heart: 0, wit: 0, spirit: 1 }
			],
			moves: [
				{
					subheader: "The Unseen",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "The Unseen",
					body: "The Unseen are mysterious beings most cannot perceive. Their very existence may be debated, but you know the truth, because they have spoken to you. You know that some are kind and some are dangerous, that they have abilities and limitations that differ from “normal” people, and that you find yourself in between.", 
					preamble: "Work with your GM to define what the Unseen are—or what your Spooky Witch thinks they are. They could be friendly spirits, phase-shifted aliens, psychic remnants, glitched-out nanites, angry poltergeists, or something totally other. When did you first interact with them? What do you think they want?",
					blanks: [ { name: "What the Unseen are like" } ],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					subheader: "Playbook Moves",
					pbdefault: "yes",
					instructions: "(start with the moves marked and choose two more)"
				},
				{
					name: "Commune with the Unseen",
					body: "When you perform a ritual to commune with the Unseen, give a dangerous Unseen a String on you and roll +Spirit:", 
					rolled: "yes", rolldefault: "spirit",
					hit: "Choose 2",
					hitbullets: [
						"Hide something in the Unseen world",
						"Learn something important from the Unseen",
						"Temporarily alter the Unseen nature of a place",
						"Ask a question from Figure Out a Person of anyone, anywhere, if you can name one of their deceased loved ones","Learn the recent history of an object you hold"
					],
					mixed: "Choose 2 from the 10+ list, but choose 1 thing that goes awry",
					mixedbullets: ["Restless Unseen cause a haunting","Hungry Unseen destroy all non-sentient life in a small area","Stern Unseen judge you, inflicting a Condition"],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "I Like Snails!",
					body: "When you are Smitten with someone and Figure Them Out, blurt out something weird and let them ask you a question from the list. Then ask them another question from the list, even on a 6-.",
					pbdefault: "yes"
				},
				{
					name: "Astral Dance", 
					body: "When you dance across the boundary into the realm beyond, describe it and roll +Grace:",
					rolled: "yes", rolldefault: "grace",
					hit: "You and a small number of others who dance with you arrive at a distant destination of your choice.",
					mixed: "You don’t arrive where you intend, you arrive almost too late, or you lose something important in the process. The GM will tell you which."
				},
				{
					name: "Divination", 
					body: "When you have time and safety to read the unseen truth of someone present, describe your divination process and what makes it conspicuous. The GM will tell you something interesting about the person or the obstacles they face that they don’t know. Then roll +Spirit:",
					rolled: "yes", rolldefault: "spirit",
					hit: "If you tell the truth, they clear a Condition. If you lie, gain a String on them.",
					mixed: "They learn the truth and clear a Condition."
				},
				{
					name: "Dreamwalk", 
					body: "When you touch an unconscious, sleeping, or willing subject, you can see an impression of their thoughts and appear in their dreams. You may roll +Spirit to Figure Out or Entice them in this state.",
					rolled: "yes", rolldefault: "spirit"
				},
				{
					name: "Eerie Companion",
					body: "You have a little pet monster or spirit. Choose two basic moves. The companion grants you +1 to these moves when it assists you, but its assistance is always obvious and alarming to ordinary people. In addition, you can speak with monsters.",
					blanks: [
						{
							name: "Basic Move Receiving +1",
							suggestions: "Fight, Defy Disaster, Entice, Figure Out a Person, Emotional Support, Call on a Toxic Power"
						},
						{
							name: "Basic Move Receiving +1",
							suggestions: "Fight, Defy Disaster, Entice, Figure Out a Person, Emotional Support, Call on a Toxic Power"
						}
					]
				},
				{
					name: "Friends in Weird Places", 
					body: "You are friends with some odd people. Folx that others might not consider people at all…",
					preamble: "Name three of them. For each one, write down one thing they’re good at, one reason why everyone else is afraid of them, and what you like to do together when you hang out.",
					end: "When you call on them for help, the GM tells you what they provide. Give them a String on you and mark the Favor next to their name. Whenever significant time passes, one of your friends with marked Favor will need help from you. Clear their Favor if you help, mark a Condition if you don’t.",
					blanks: [
						{ name: "1st friend", checkbox: "yes" }, { name: "Why everyone else is afraid of them" }, { name: "What we like to do together" },
						{ name: "2nd friend", checkbox: "yes" }, { name: "Why everyone else is afraid of them" }, { name: "What we like to do together" },
						{ name: "3rd friend", checkbox: "yes" }, { name: "Why everyone else is afraid of them" }, { name: "What we like to do together" }
					]
				},
				{
					name: "Talk Nerdy to Me",
					body: "You may roll +Wit instead of +Heart to Entice someone. In addition, choose an area of study that holds special interest for you. You have top-tier knowledge of this area and are always prepared with an interesting fact, and sometimes even a useful fact, when you come across something within your expertise. The GM will provide the information or invite you to make something up.",
					rolled: "yes", rolldefault: "wit"
				},
				{
					name: "Witchfire",
					body: "You may roll +Spirit instead of +Daring to Fight, but you’re very conspicuous when you do. The consequences of a 6- will be severe.",
					rolled: "yes", rolldefault: "spirit"
				},
				{
					subheader: "Truths of Heart and Blade",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Why Did I Bring up the Snails?",
					body: "When you become Smitten with someone, say why, give them a String, and answer this question:",
					bullets: ["What obvious thing about you are you sure would make them reject you?"],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Whispered Secrets",
					body: "When you Figure Out a Person during a physical conflict, you may additionally ask one of these questions, even on a 6-:",
					bullets: ["What makes you insecure?","What haunts you?"],
					pbdefault: "yes",
					pbother: "no"
				}
			]
		},
		"trickster": { 
			name: "The Trickster",
			bio: "The Trickster is devious and calculating. They fear closeness, sincerity, and vulnerability. If they show you the truth of their heart, they’ll be wearing a mask to do it. Their central conflict lies in desiring closeness while fearing vulnerability. Example Archetypes: Businesslike Spy, Endearing Charlatan, Cold Mastermind",
			relationships: [
				"Who has seen a hint of what’s behind your mask?",
				"Who has been the worst victim of your trickery?",
				"Whom are you most concerned about?"
			],
			look: {
				demeanor: "Harmless demeanor, suspicious demeanor, mercurial demeanor",
				clothes: "Hooded clothes, nondescript clothes, clothes to play a role",
				sword: "A concealed sword, a venomous sword, a surprising sword"
			},
			startstats: [
				{ daring: 1, grace: 0, heart: -1, wit: 1, spirit: 0 },
				{ daring: 0, grace: 1, heart: -1, wit: 1, spirit: 0 }
			],
			moves: [
				{
					subheader: "Too Many Feelings",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "Feelings", tracklabel: "Feelings",
					body: "Your heart is as passionate as any other, but you bury it beneath layers of deception—until you can’t keep your feelings in any longer.",
					preamble: "Start at 1 and increase your Feelings by 1 each time you gain a String, someone gains a String on you, or you mark a Condition. You may also choose to increase your Feelings any time you find yourself gasping or swooning over someone. Strings assigned during character creation don’t increase your Feelings.",
					alternative: "When you open up to someone whose regard matters to you, reduce your Feelings by 2. When you secretly perform a loving act for someone, reduce your Feelings by 1.",
					end: "If your Feelings track reaches 4, you can’t hold it in anymore. Tear off the mask and scream what you’ve been holding in, do what you’ve been afraid to do, and damn the consequences. You can give anyone present a String on you to gain a String on them. Stop when the consequences catch up with you, for good or ill. Afterwards, reduce your Feelings to 0 and clear a Condition. It feels good to get it out, at least in the moment.",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					subheader: "Playbook Moves",
					pbdefault: "yes",
					instructions: "(start with the moves marked and choose two more)"
				},
				{
					name: "Ew, Feelings",
					body: "When someone offers you Emotional Support and you refuse to open up, increase your Feelings by 1 and choose 1 from the listed options for that move as if they rolled 7–9. If they rolled 10+, they know they got through to you; they gain the benefits of a 10+ result as if you had opened up.",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "The Mask", 
					body: "When you seek to persuade an NPC of a lie about yourself, roll +Wit:",
					rolled: "yes", rolldefault: "wit",
					hit: "Choose 2",
					mixed: "Choose 1",
					mixedbullets: ["They believe a big lie", "The lie you have chosen is unexpectedly perfect, creating a new opportunity", "They give you the benefit of the doubt and remain convinced even if there is some evidence of your lie"],
					end: "Additionally, whenever a PC Figures You Out, you can give false answers. You must increase your Feelings by 1 at the end of any scene where you do this.",
					pbdefault: "yes"
				},
				{
					name: "Center of the Web",
					body: "When someone approaches you to get something from you or threaten you. Choose 1:",
					bullets: ["Gain a String on them or they lose a String on you","Ask them a question from the Figure Out a Person move","+1 ongoing against them for the scene"]
				},
				{
					name: "Deft Fingers",
					body: "When you filch something from a person, roll +Grace:",
					rolled: "yes", rolldefault: "grace",
					hit: "Choose 2", mixed: "Choose 1",
					mixedbullets: ["The item reveals a secret love or vulnerability","The item creates an opportunity (such as a map, key, or note)","The person doesn’t know you took it"]
				},
				{
					name: "Devious Scheme",
					body: "When others go along with your cunning plan, roll +Wit:",
					rolled: "yes", rolldefault: "wit",
					hit: "Twice during your plan, you may choose 1",
					mixed: "Once during your plan, you may choose 1",
					mixedbullets: ["Produce just the right object","Describe an unexpected weakness in an obstacle","Appear right behind someone at a crucial moment"]
				},
				{
					name: "Knives behind the Mask",
					body: "When someone reveals a secret about you in your presence, you’re prepared with a damaging secret about them. If you reveal it now in retaliation, they mark a Condition. If you keep the secret for the time being, gain a String on them."
				},
				{
					name: "Play the Part",
					body: "When you use someone else’s personal item or clothing to disguise yourself as them, roll +Daring:",
					rolled: "yes", rolldefault: "daring",
					hit: "While you remain so dressed, your disguise is perfect; only your words or deeds may expose you.",
					mixed: "Someone sees through your disguise, but they don’t give you away just yet. Give them a String.",
				},
				{
					subheader: "Truths of Heart and Blade",
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "A Beautiful Lie",
					body: "When you become Smitten with someone, say why, give them a String, and answer this question:",
					bullets: ["What secret do you have that you think would make them reject you if they knew?"],
					pbdefault: "yes",
					pbother: "no"
				},
				{
					name: "I See through You",
					body: "When you Figure Out a Person during a physical conflict, you may additionally ask one of these questions, even on a 6-:",
					bullets: ["Who do you want me to be?","What are you most afraid of right now?"],
					pbdefault: "yes",
					pbother: "no"
				}
			]
		}
	};

	// end BIG playbooks data set

	// functions

	// Code testing reveals that the generateRowID function does not generate a unique ID 100% of the time when adding many rows at once, so we've got to 

	var uniqueids = {};

	var logs = 0;

	var prefixedLogging = true;

	var log = function(t,c) {
		logs = Date.now();
		if ( prefixedLogging ) {
			if ( typeof c === "undefined" ) {
				console.log(`${logs}: ${t}`);
			} else {
				console.log(`${logs}: [${c}] ${t}`);
			}
		} else {
			console.log(t);
		}
	};
	
	var setStatus = function(t) {
		if ( typeof t !== "undefined" && t !== "" ) {
			getAttrs(["status-message"],function(s) {
				var m = s["status-message"];
				setAttrs( { "status-message": `${m} ${t}` } );
			});
			log(t);
		} else {
			setAttrs( { "status-message": "" } );
		}
	};
	
	var generateActuallyUniqueRowID = function() {
		var generated = generateRowID();
		while ( uniqueids[generated] === true ) {
			log("generateActuallyUniqueRowID: " + generated + " is not a unique ID, trying again.");
			generated = generateRowID();
		}
		// log("generateActuallyUniqueRowID: " + generated + " verified as unique, returning.");
		uniqueids[generated] = true;
		return generated;
	};
	
	var gTBK = function(t) {
		if ( typeof t === "undefined" ) {
			return "";
		} else {
			var result = getTranslationByKey(t);
			// log(`${t} -> ${result}`,"translation")
			if ( result === false ) {
				log("could not translate: " + t);
				return "UNTRANSLATED ["+t+"]";
			} else {
				if ( result === "" ) { return ""; }
				else { return result; }
			}
		}
	};

	var loadPlaybookMoves = function(p,markDefaults) { // p is the playbook key!, markDefaults is an optional boolean
		if ( typeof playbooks[p] !== "undefined" ) {
			log(`called: loadPlaybookMoves(${p})`)
			var pbook = playbooks[p];
			console.log(pbook);
			var attrs = {};
			if ( typeof markDefaults === "undefined" || markDefaults !== true ) {
				markDefaults = false;
			}

			// It's good to get to this step, but we need to check first to see if this playbook's already loaded up.
			getSectionIDs("repeating_playbooks", function(ids) {
				var pbf = [];
				for(var i=0; i < ids.length; i++ ) {
					var pbfpre = "repeating_playbooks_" + ids[i] + "_";
					pbf[i*2] = pbfpre + "key";
					pbf[i*2+1] = pbfpre + "loaded";
				}
				getAttrs(pbf, function(pdata) {
					// need to search for load status and confirm

					var loaded = "";
					var pbookpre = "";
					console.log(pdata);
					for(var i=0; i < ids.length; i++ ) {
						var pbfpre = "repeating_playbooks_" + ids[i] + "_";
						var keyid = pbfpre + "key"; var loadid = pbfpre + "loaded";
						log(`scanning pbfpre ${pbfpre} keyid ${keyid} loadid ${loadid}`);
						if ( typeof pdata[keyid] !== "undefined" && pdata[keyid] === p ) {
							// Then this is the playbook in question, let's see if it's loaded
							if ( typeof pdata[loadid] !== "undefined" ) { // Should be a yes or no
								pbookpre = pbfpre;
								loaded = pdata[loadid];
								if ( loaded === "" ) { loaded = "no"; } // if this is happening, but shouldn't, because we established the value as "no" during playbook setup. inexcusable that it's not coming through empty.
								break; // No need to continue this for loop once we've found the playbook
							}
						}
					}
					log(`emerged from finding the playbook with loaded value of ${loaded}`);
					console.log(pbook.moves);
					if ( loaded === "no" && typeof pbook.moves !== "undefined" ) {
						log(`configuring moves found for ${p}, ${pbookpre}`);
						var attrs = {};
						attrs[`${pbookpre}loaded`] = "yes";
						var mymoves = pbook.moves;
						var category = "special"; // special moves come first, get default category value
						for(var i=0; i < mymoves.length; i++ ) {
							var mymove = mymoves[i];
							var moveid = generateActuallyUniqueRowID();
							var moveidpre = "repeating_moves_" + moveid + "_";
							attrs[`${moveidpre}name`] = gTBK(mymove.name);
							attrs[`${moveidpre}show`] = "yes"; // presumably, we're loading them so we should show them?
							attrs[`${moveidpre}playbook`] = p; // the playbook key value
							attrs[`${moveidpre}body`] = gTBK(mymove.body);
							attrs[`${moveidpre}taken`] = "";
							attrs[`${moveidpre}long`] = "no";
							if ( typeof mymove.header !== "undefined" ) { attrs[`${moveidpre}header`] = gTBK(mymove.header); }
							if ( typeof mymove.subheader !== "undefined" ) {
								if ( mymove.subheader === "Playbook Moves" ) {
									category = "playbook"; // setting it for this and all subsequent moves until changed again
								} else if ( mymove.subheader === "Truths of Heart and Blade" ) {
									category = "truths"; // setting it for this and all subsequent moves until changed again
								}
								attrs[`${moveidpre}subheader`] = gTBK(mymove.subheader) + " (" + gTBK(playbooks[p].name) + ")";
							}
							attrs[`${moveidpre}category`] = category;
							if ( typeof mymove.instructions !== "undefined" ) { attrs[`${moveidpre}instructions`] = gTBK(mymove.instructions); }
							if ( typeof mymove.pbdefault !== "undefined" ) { 
								attrs[`${moveidpre}pbdefault`] = mymove.pbdefault; 
								if ( mymove.pbdefault === "yes" && markDefaults ) {
									attrs[`${moveidpre}taken`] = "yes";
								}
							}
							if ( typeof mymove.pbother !== "undefined" ) { attrs[`${moveidpre}pbother`] = mymove.pbother; }
							if ( typeof mymove.tracklabel !== "undefined" ) { attrs[`${moveidpre}tracklabel`] = gTBK(mymove.tracklabel); attrs[`${moveidpre}tracker`] = 1; }
							if ( typeof mymove.preamble !== "undefined" ) { attrs[`${moveidpre}preamble`] = gTBK(mymove.preamble); attrs[`${moveidpre}long`] = "yes"; }
							if ( typeof mymove.end !== "undefined" ) { attrs[`${moveidpre}end`] = gTBK(mymove.end); attrs[`${moveidpre}long`] = "yes"; }
							if ( typeof mymove.hit !== "undefined" ) { attrs[`${moveidpre}hit`] = gTBK(mymove.hit); attrs[`${moveidpre}long`] = "yes"; }
							if ( typeof mymove.mixed !== "undefined" ) { attrs[`${moveidpre}mixed`] = gTBK(mymove.mixed); attrs[`${moveidpre}long`] = "yes"; }
							if ( typeof mymove.miss !== "undefined" ) { attrs[`${moveidpre}miss`] = gTBK(mymove.miss); attrs[`${moveidpre}long`] = "yes"; }
							if ( typeof mymove.alternative !== "undefined" ) { attrs[`${moveidpre}alternative`] = gTBK(mymove.alternative); attrs[`${moveidpre}long`] = "yes"; }
							if ( typeof mymove.althit !== "undefined" ) { attrs[`${moveidpre}althit`] = gTBK(mymove.althit); attrs[`${moveidpre}long`] = "yes"; }
							if ( typeof mymove.altmixed !== "undefined" ) { attrs[`${moveidpre}altmixed`] = gTBK(mymove.altmixed); attrs[`${moveidpre}long`] = "yes"; }
							if ( typeof mymove.altmiss !== "undefined" ) { attrs[`${moveidpre}altmiss`] = gTBK(mymove.altmiss); attrs[`${moveidpre}long`] = "yes"; }
							if ( typeof mymove.rolled !== "undefined" && mymove.rolled === "yes" ) { 
								var rc = "";
								if ( typeof mymove.rolldefault !== "undefined" ) {
									if ( typeof stats[mymove.rolldefault] !== "undefined" ) {
										rc = "|" + gTBK(stats[mymove.rolldefault]) + " " + gTBK("(Default)") + ",@{stat_" + mymove.rolldefault + "}";
									} else if ( mymove.rolldefault === "conditions-marked" ) {
										rc = "|" + gTBK("Number of Conditions marked") + " " + gTBK("(Default)") + ",@{" + mymove.rolldefault + "}";
									} else {
										log(`Was not able to parse ${mymove.rolldefault} as a rollable attribute`);
									}
								} 
								// building a string like |Sharp (Default),@{Sharp}|Charm,@{Charm}|Cool,@{Cool}|Sharp,@{Sharp}|Tough,@{Tough}|Weird,@{Weird}
								for(var [statkey,statname] of Object.entries(stats)) {
									rc = rc + "|" + gTBK(statname) + ",@{stat_" + statkey + "}";
								}
								attrs[`${moveidpre}rollconfig`] = rc;
							}
							// Now the expanding modulars: the blanks, and the bullets 
							// Currently blanks support up to 10, bullets support up to 5
							for(var j=0; j < 10; j++) {
								if ( typeof mymove.blanks !== "undefined" ) {
									if ( typeof mymove.blanks[j] !== "undefined" ) {
										attrs[`${moveidpre}long`] = "yes";
										attrs[`${moveidpre}blankname${j}`] = gTBK(mymove.blanks[j].name);
										if ( typeof mymove.blanks[j].suggestions !== "undefined" ) {
											attrs[`${moveidpre}blanksuggestions${j}`] = gTBK(mymove.blanks[j].suggestions); 
										}
										if ( typeof mymove.blanks[j].checkbox !== "undefined" ) {
											attrs[`${moveidpre}checkbox${j}`] = mymove.blanks[j].checkbox;
										}
									}
								}
							}
							var mbullets = [ "bullets", "hitbullets", "mixedbullets", "missedbullets", "altbullets", "althitbullets", "altmixedbullets", "altmissedbullets" ];
							for(var j=0; j < 5; j++) {
								// This will run us through the 7 modular bullet lists for this index (!!!!!!) 
								for(var x=0; x < mbullets.length; x++) {
									var fkey = mbullets[x];
									if ( typeof mymove[fkey] !== "undefined" ) { 
										// Then there's an bullet list of this type for this move 
										attrs[`${moveidpre}long`] = "yes";
										var flist = mymove[fkey];
										var nosattheend = fkey.substring(0,fkey.length-1);
										if ( typeof flist[j] !== "undefined" ) { // Then there's a bullet at this position in this list
											attrs[`${moveidpre}${nosattheend}${j}`] = gTBK(flist[j]);
										}
									}
								}
							}
							// At this point attrs should contain a bunch of stuff we need to know in order to populate the shareoptions field. ZOD!
							var options = "{{blank0=@{blank0}}} {{blank1=@{blank1}}} {{blank2=@{blank2}}} {{blank3=@{blank3}}} {{blank4=@{blank4}}} {{blank5=@{blank5}}} {{blank6=@{blank6}}} {{blank7=@{blank7}}} {{blank8=@{blank8}}} {{blank9=@{blank9}}} ";
							var shareoptid = moveidpre + "shareoptions";
							for(var j=0; j < moveoptions.length; j++) {
								var moid = moveidpre + moveoptions[j];
								if ( typeof attrs[moid] !== "undefined" && attrs[moid] !== "" ) {
									options = options + "{{"+moveoptions[j]+"=@{"+moveoptions[j]+"}}} ";
								}
							}
							attrs[shareoptid] = options;
							// At this point we should be able to save the moves.
						} // End for loop on all of the moves for this playbook
						setAttrs(attrs,{},function () {
							log(`moves configured for ${p}`);
						});
					} // end if block for typeof pbook.moves !== "undefined"
					else {
						log(`did not load moves for ${p}; loaded = ${loaded}`);
					}
				});
			});
		}
	};
	// event handlers
	
	// Initialize when first opening the sheet, or when the initializing field is changed appropriately.

	on("sheet:opened change:pbinitialized", function() {
		log("Handler: sheet:opened change:pbinitialized");
		getAttrs(["pbinitialized"], function(values) {
			if ( values.pbinitialized === "reset" ) {
				var attrs = { "pbinitialized": "no" };
				attrs["playbook-current-row"] = "";
				attrs["starting-chosen"] = "0";
				attrs["experience"] = 0; /* attrs["xp1"] = 0; attrs["xp2"] = 0; attrs["xp3"] = 0; attrs["xp4"] = 0; attrs["xp5"] = 0; */
				log("resetting sheet");
				getSectionIDs("repeating_playbooks", function(idarray) {
					for(var i=0; i < idarray.length; i++ ) {
						removeRepeatingRow("repeating_playbooks_"+idarray[i]);
					}
				});
				getSectionIDs("repeating_looks", function(idarray) {
					for(var i=0; i < idarray.length; i++ ) {
						removeRepeatingRow("repeating_looks_"+idarray[i]);
					}
				});
				getSectionIDs("repeating_relationships", function(idarray) {
					for(var i=0; i < idarray.length; i++ ) {
						removeRepeatingRow("repeating_relationships_"+idarray[i]);
					}
				});
				getSectionIDs("repeating_stats", function(idarray) {
					for(var i=0; i < idarray.length; i++ ) {
						removeRepeatingRow("repeating_stats_"+idarray[i]);
					}
				});
				getSectionIDs("repeating_startingstats", function(idarray) {
					for(var i=0; i < idarray.length; i++ ) {
						removeRepeatingRow("repeating_startingstats_"+idarray[i]);
					}
				});
				getSectionIDs("repeating_advances", function(idarray) {
					for(var i=0; i < idarray.length; i++ ) {
						removeRepeatingRow("repeating_advances_"+idarray[i]);
					}
				});
				getSectionIDs("repeating_conditions", function(idarray) {
					for(var i=0; i < idarray.length; i++ ) {
						removeRepeatingRow("repeating_conditions_"+idarray[i]);
					}
				});
				getSectionIDs("repeating_strings", function(idarray) {
					for(var i=0; i < idarray.length; i++ ) {
						removeRepeatingRow("repeating_strings_"+idarray[i]);
					}
				});
				getSectionIDs("repeating_modifiers", function(idarray) {
					for(var i=0; i < idarray.length; i++ ) {
						removeRepeatingRow("repeating_modifiers_"+idarray[i]);
					}
				});
				// Moves are highest volume, so we use the callback to set the attributes that'll fire off the next stage.
				getSectionIDs("repeating_moves", function(idarray) {
					for(var i=0; i < idarray.length; i++ ) {
						removeRepeatingRow("repeating_moves_"+idarray[i]);
					}
					log("moves removed");
					setAttrs(attrs,{},function() { log("reset clause done"); }); // Set the resets after all this mess wraps up
				});
			} else if ( values.pbinitialized !== "yes" ) { // the big if

				var initted = {};
				initted["pbinitialized"] = "yes"; // set this early so we don't accidentally fire off the process twice
				setAttrs(initted); // I figure once we've got the basic moves in, we should be able to admit we're done

				log("Sheet is not initialized. Beginning process.");
				var attrs = {};
				attrs["playbook-key"] = "";
				attrs["playbook-name"] = gTBK("Choose a playbook!");
				attrs["experience_max"] = xpmax;
				var stringid = "repeating_strings_" + generateActuallyUniqueRowID();
				attrs[`${stringid}_used`] = "no"; // Creates our starter String entry
				var modifierid = "repeating_modifiers_" + generateActuallyUniqueRowID();
				attrs[`${modifierid}_used`] = "no"; // Creates our starter modifier entry
				var rwm = gTBK("roll with modifier");
				attrs["rollprompt"] = "?{"+rwm+"|0}"; // sets up our default rolling prompt
				for(var [id,value] of Object.entries(looks) ) {
					var newid = generateActuallyUniqueRowID();
					var lookpre = "repeating_looks_" + newid + "_";
					var lookkey = lookpre + "key";
					var lookname = lookpre + "name";
					attrs[lookkey] = gTBK(id);
					attrs[lookname] = gTBK(value);
				}
				var rc = "";
				for(var [id,value] of Object.entries(stats) ) {
					var newid = generateActuallyUniqueRowID();
					var statpre = "repeating_stats_" + newid + "_";
					var statkey = statpre + "key";
					var statname = statpre + "name";
					var statdesc = statpre + "description";
					var rating = statpre + "rating";
					attrs[statkey] = id;
					attrs[statname] = gTBK(value);
					attrs[statdesc] = gTBK(sdesc[id]);
					attrs[rating] = 0; // Give an initial value rather than letting them be empty; empty causes icky errors.
					// building a string like |@{Sharp}|Charm,@{Charm}|Cool,@{Cool}|Sharp,@{Sharp}|Tough,@{Tough}|Weird,@{Weird}
					rc = rc + "|" + gTBK(value) + ",@{stat_" + id + "}";
				}
				attrs["stats-query"] = rc;
				for(var i = 0; i < advances.length; i++) {
					var newid = generateActuallyUniqueRowID();
					var apre = "repeating_advances_" + newid + "_";
					var advance = advances[i];
					var tid = apre + "text";
					// var lid = apre + "notelabel";
					var pid = apre + "preamble";
					attrs[tid] = gTBK(advance.text);
					if ( typeof advance.preamble !== "undefined" ) { attrs[pid] = gTBK(advance.preamble); }
					// if ( typeof advance.notelabel !== "undefined" ) { attrs[lid] = gTBK(advance.notelabel); }
				}

				// We can afford to pause here to set these attributes, then empty out the array to continue; it's no big deal if these ones run simultaneous to what's later, so async call is ok

				setAttrs(attrs,{},function() { log("first-round initializations complete"); }); 

				// Fresh array please

				attrs = {};

				for(var [id,value] of Object.entries(playbooks) ) {
					var newid = generateActuallyUniqueRowID();
					var pbidpre = "repeating_playbooks_" + newid + "_";
					var pbidkey = pbidpre + "key";
					var pbidname = pbidpre + "name";
					var pbidloaded = pbidpre + "loaded";
					attrs[pbidkey] = id;
					attrs[pbidname] = gTBK(value["name"]);
					attrs[pbidloaded] = "no";
					var bioid = pbidpre + "bio";
					if ( typeof value["bio"] !== "undefined" ) { attrs[bioid] = gTBK(value["bio"]); }

					// This is where we used to create all the moves for all the playbooks.
					// But it's smarter to load those piecemeal as-desired, so relocating.

				}

				log(`configuring playbooks list`);
				setAttrs(attrs,{},function() {
					log(`playbooks list configured`);
				});
				attrs = {};

				// ZED? 
				/*
				var pbmoveattrs = attrs; // save the attributes object; will set later
				attrs = {}; // empty it
				*/

				// Here endeth the move creation section

				// We also need to create all the basic moves. These are very similar to playbook moves, but we're gonna replicate code in case differences emerge over development.

				var basicids = {};

				for(var i=0; i < basicmoves.length; i++ ) {
					var basicmove = basicmoves[i];
					var moveid = generateActuallyUniqueRowID();
					var moveidpre = "repeating_basic_" + moveid + "_";
					attrs[`${moveidpre}category`] = "basic";
					if ( typeof basicmove.name !== "undefined" ) { 
						attrs[`${moveidpre}name`] = gTBK(basicmove.name); 
						basicids[attrs[`${moveidpre}name`]] = moveid; // helps us map for later
					}
					if ( typeof basicmove.body !== "undefined" ) { attrs[`${moveidpre}body`] = gTBK(basicmove.body); }
					attrs[`${moveidpre}taken`] = "yes";
					attrs[`${moveidpre}show`] = "yes";
					attrs[`${moveidpre}long`] = "no";
					if ( typeof basicmove.header !== "undefined" ) { attrs[`${moveidpre}header`] = gTBK(basicmove.header); }
					if ( typeof basicmove.subheader !== "undefined" ) { attrs[`${moveidpre}subheader`] = gTBK(basicmove.subheader); }
					if ( typeof basicmove.preamble !== "undefined" ) { attrs[`${moveidpre}preamble`] = gTBK(basicmove.preamble); attrs[`${moveidpre}long`] = "yes"; }
					if ( typeof basicmove.end !== "undefined" ) { attrs[`${moveidpre}end`] = gTBK(basicmove.end); attrs[`${moveidpre}long`] = "yes"; }
					if ( typeof basicmove.hit !== "undefined" ) { attrs[`${moveidpre}hit`] = gTBK(basicmove.hit); attrs[`${moveidpre}long`] = "yes"; }
					if ( typeof basicmove.mixed !== "undefined" ) { attrs[`${moveidpre}mixed`] = gTBK(basicmove.mixed); attrs[`${moveidpre}long`] = "yes"; }
					if ( typeof basicmove.miss !== "undefined" ) { attrs[`${moveidpre}miss`] = gTBK(basicmove.miss); attrs[`${moveidpre}long`] = "yes"; }
					if ( typeof basicmove.alternative !== "undefined" ) { attrs[`${moveidpre}alternative`] = gTBK(basicmove.alternative);  attrs[`${moveidpre}long`] = "yes";}
					if ( typeof basicmove.althit !== "undefined" ) { attrs[`${moveidpre}althit`] = gTBK(basicmove.althit);  attrs[`${moveidpre}long`] = "yes"; }
					if ( typeof basicmove.altmixed !== "undefined" ) { attrs[`${moveidpre}altmixed`] = gTBK(basicmove.altmixed);  attrs[`${moveidpre}long`] = "yes"; }
					if ( typeof basicmove.altmiss !== "undefined" ) { attrs[`${moveidpre}altmiss`] = gTBK(basicmove.altmiss); attrs[`${moveidpre}long`] = "yes"; }
					if ( typeof basicmove.rolled !== "undefined" && basicmove.rolled === "yes" ) { 
						var rc = "";
						if ( typeof basicmove.rolldefault !== "undefined" ) {
							if ( typeof stats[basicmove.rolldefault] !== "undefined" ) {
								rc = "|" + stats[basicmove.rolldefault] + " " + gTBK("(Default)") + ",@{stat_" + basicmove.rolldefault + "}";
							}
						} 
						// building a string like |Sharp (Default),@{Sharp}|Charm,@{Charm}|Cool,@{Cool}|Sharp,@{Sharp}|Tough,@{Tough}|Weird,@{Weird}
						for(var [statkey,statname] of Object.entries(stats)) {
							rc = rc + "|" + gTBK(statname) + ",@{stat_" + statkey + "}";
						}
						attrs[`${moveidpre}rollconfig`] = rc;
					}
					// Now the expanding modulars: the blanks, and the bullets 
					var mbullets = [ "bullets", "hitbullets", "mixedbullets", "missedbullets", "altbullets", "althitbullets", "altmixedbullets", "altmissedbullets" ];
					for(var j=0; j < 5; j++) {
						if ( typeof basicmove.blanks !== "undefined" ) { 
							if ( typeof basicmove.blanks[j] !== "undefined" ) {
								attrs[`${moveidpre}long`] = "yes";
								attrs[`${moveidpre}blankname${j}`] = gTBK(basicmove.blanks[j].name);
								if ( typeof basicmove.blanks[j].suggestions !== "undefined" ) {
									attrs[`${moveidpre}blanksuggestions${j}`] = gTBK(basicmove.blanks[j].suggestions); 
								}
							}
						}
						// This will run us through the 7 modular bullet lists for this index (!!!!!!) 
						for(var x=0; x < mbullets.length; x++) {
							var fkey = mbullets[x];
							if ( typeof basicmove[fkey] !== "undefined" ) { // Then there's an bullet list of this type for this move
								var flist = basicmove[fkey];
								var nosattheend = fkey.substring(0,fkey.length-1);
								if ( typeof flist[j] !== "undefined" ) { // Then there's a bullet at this position in this list
									attrs[`${moveidpre}long`] = "yes";
									attrs[`${moveidpre}${nosattheend}${j}`] = gTBK(flist[j]);
								}
							}
						}
					}

					// At this point attrs should contain a bunch of stuff we need to know in order to populate the shareoptions field. ZOD!
					var options = "{{blank0=@{blank0}}} {{blank1=@{blank1}}} {{blank2=@{blank2}}} {{blank3=@{blank3}}} {{blank4=@{blank4}}} {{blank5=@{blank5}}} {{blank6=@{blank6}}} {{blank7=@{blank7}}} {{blank8=@{blank8}}} {{blank9=@{blank9}}} ";
					var shareoptid = moveidpre + "shareoptions";
					for(var j=0; j < moveoptions.length; j++) {
						var moid = moveidpre + moveoptions[j];
						if ( typeof attrs[moid] !== "undefined" && attrs[moid] !== "" ) {
							options = options + "{{"+moveoptions[j]+"=@{"+moveoptions[j]+"}}} ";
						}
					}
					attrs[shareoptid] = options;

				}

				// Here endeth basic moves creation

				// ZED pbmoveattrs, basicmoveattrs

				var basicmoveattrs = attrs; // save the attributes object; will set later
				attrs = {}; // empty it

				// usefully, conditions creation comes after moves creation, so we can map these to their affected moves too
				attrs["conditions-penalty"] = -2;
				log("configuring conditions");
				for(var [id,value] of Object.entries(conditions) ) {
					var newid = generateActuallyUniqueRowID();
					var conpre = "repeating_conditions_" + newid + "_";
					for(var [fid,fval] of Object.entries(value)) {
						var fkey = conpre + fid;
						attrs[fkey] = fval;
						if ( fid === "penalty" && attrs["conditions-penalty"] !== fval ) {
							attrs["conditions-penalty"] = fval; // Set the default conditions penalty based on these values; will need to get smarter if there are ever varied values at setup time
						}
						if ( fid === "name" ) { var fvt = gTBK(fval); attrs[fkey] = fvt; attrs[`condition-${fvt}`] = "no"; }
						if ( fid === "penalized" ) { 
							var fvt = gTBK(fval); attrs[fkey] = fvt; 
							attrs[`condition-penalty-${fvt}`] = 0;
							if ( typeof basicids[fvt] !== "undefined" ) { // IMPORTANT! Needs access to the basicids object populated by the basic moves building effort. So conditions must execute sequentially after basic moves. Be careful not to populate basicids in something asynchronous.
								var movefieldid = basicids[fvt];
								attrs[`${conpre}moveid`] = movefieldid; // build that link 
								attrs[`${movefieldid}conditionid`] = newid; // build that link other direction
								attrs[`${movefieldid}condition-marked`] = "no"; // Initialize
								attrs[`${movefieldid}modifier-marked`] = gTBK("Modifier is not marked."); // Initialize
							}
						}
						if ( fid === "clearwhen" ) { var fvt = gTBK(fval); attrs[fkey] = fvt; }
					}
				}

				// MAKE SURE TO SET SHEET VERSION
				
				attrs["sheet-version"] = codeVersion;

				// ZED?
				setAttrs(attrs,{},function() {
					log("done configuring conditions");
				});

				// Time-consuming-est stuff here?

				log("configuring basic moves");
				setAttrs(basicmoveattrs,{},function() {
					log("basic moves configured");
				});

/*
				log("configuring playbook moves");
				setAttrs(pbmoveattrs,{},function() {
					log("playbook moves configured");
					log("sheet configuration should be complete");
				});
*/

			} // end the big if
		});
	});

	// Do everything that needs to be done when picking a playbook from the menu

	on("clicked:repeating_playbooks:choose-playbook", function(e) {
		log("Handler: clicked:repeating_playbooks:choose-playbook");
		var rowprefix = (e.sourceAttribute).slice(0,-15); // Strips off the 'choose-playbook'
		var keyid = rowprefix + "key";
		var nameid = rowprefix + "name";
		var selectedid = rowprefix + "selected";
		getAttrs([keyid,nameid,"playbook-current-row"], function(a) {
			var attrs = { "playbook-key": a[keyid], "playbook-name": a[nameid], "playbook-current-row": rowprefix };
			if ( a["playbook-current-row"] !== "" ) {
				var oldselectedid = a["playbook-current-row"] + "selected";
				attrs[oldselectedid] = "";
			}
			attrs[selectedid] = "S"; // S for a star, k for a heart
			attrs["playbook-current-row"] = rowprefix;
			setAttrs(attrs);

			// Looks section 
			var pbkey = a[keyid];
			var mylooks = playbooks[pbkey].look;

			log(`configuring looks for ${pbkey}`);
			getSectionIDs("looks", function(lf) {
				var lfields = [];
				for(var i=0; i < lf.length; i++ ) {
					lfields[i] = "repeating_looks_" + lf[i] + "_key";
				}

				getAttrs(lfields, function(la) {
					var lattrs = {};
					for(var i=0; i < lfields.length; i++) {

						var key = la[lfields[i]]; // the value of the look's key field tells us what category we're looking to populate examples for
						if ( typeof mylooks[key] !== "undefined" ) {
							// Then we have a look category key to populate!
							var eid = "repeating_looks_" + lf[i] + "_examples";
							lattrs[eid] = mylooks[key];
						}
					}
					setAttrs(lattrs,{},function() { log(`looks for ${pbkey} configured`); });
				});

			});

			// relationships section

			var myrels = playbooks[pbkey].relationships;

			log(`configuring relationship questions for ${pbkey}`);

			getSectionIDs("repeating_relationships", function(idarray) {
				for(var i=0; i < idarray.length; i++ ) {
					removeRepeatingRow("repeating_relationships_"+idarray[i]);
				}
			});

			var relq = {};
			
			if ( typeof myrels !== "undefined" ) {
				for(var i=0; i < myrels.length; i++) {
					var newid = generateActuallyUniqueRowID();
					var rpre = "repeating_relationships_"+newid+"_";
					var rtext = rpre + "text";
					relq[rtext] = getTranslationByKey(myrels[i]);
				}
				setAttrs(relq);
			}

			// starting stats section

			log(`configuring starting stats for ${pbkey}`);

			var mystarts = playbooks[a[keyid]].startstats;

			// Clear out any existing starting stats sets, they don't matter
			getSectionIDs("repeating_startingstats", function(idarray) {
				for(var i=0; i < idarray.length; i++ ) {
					removeRepeatingRow("repeating_startingstats_"+idarray[i]);
				}
			});
			
			// Now populate based on our mystarts

			var starta = {};
			if ( typeof mystarts !== "undefined" ) {
				for(var i=0; i < mystarts.length; i++) {
					var newid = generateActuallyUniqueRowID();
					var startpre = "repeating_startingstats_"+newid+"_";
					var startset = startpre + "set";
					var starttext = startpre + "text";
					var myset = ""; 
					var mytext = "";
					for(var [statkey,value] of Object.entries(mystarts[i]) ) {
						if ( myset !== "" ) {
							myset = myset+" ";
							mytext = mytext+", ";
						}
						myset = myset+statkey+":"+value;
						mytext = mytext+gTBK(stats[statkey])+" ";
						if ( Number(value) > 0 ) {
							mytext = mytext+"+";
						} else if ( Number(value) == 0 ) {
							mytext = mytext+"=";
						}
						mytext = mytext+value;
					}
					starta[startset] = myset;
					starta[starttext] = mytext;
				}
				setAttrs(starta,{},function() { log(`starting stats for ${pbkey} configured`); });
			}

			// Moves section 

			log(`configuring moves for ${pbkey}`);

			getSectionIDs("moves", function(mf) {
				var mfields = [];
				for(var i=0; i < mf.length; i++ ) {
					mfields[i*4] = "repeating_moves_" + mf[i] + "_playbook";
					mfields[i*4+1] = "repeating_moves_" + mf[i] + "_pbdefault";
					mfields[i*4+2] = "repeating_moves_" + mf[i] + "_taken";
					mfields[i*4+3] = "repeating_moves_" + mf[i] + "_name";
				}

				getAttrs(mfields, function(ma) {
					log(`determining show/hide moves status for all moves, for ${pbkey}`);
					var mattrs = {};
					var found = false;
					var pbook = attrs["playbook-key"];
					for(var i=0; i < mf.length; i++) {
						var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
						var mdefid = "repeating_moves_" + mf[i] + "_pbdefault"; var mdef = ma[mdefid];
						var takeid = "repeating_moves_" + mf[i] + "_taken";
						var showid = "repeating_moves_" + mf[i] + "_show";
						var nameid = "repeating_moves_" + mf[i] + "_name"; var mname = ma[nameid];
						// Decide if we mark as taken any default moves for the playbook, and clear out marked ones from viewing other playbooks previously.
						if ( mdef === "yes" ) {
							if ( mbook === attrs["playbook-key"] ) { // Then this is a default move for the chosen playbook
								mattrs[takeid] = "yes"; ma[takeid] = "yes"; // need to set both the attribute-to-be, and tell later processes that the attribute-that-is is already the attribute-to-be's value
							} else { // Then this is a default move for ANOTHER playbook and should get un-chosen
								mattrs[takeid] = "0"; ma[takeid] = "0"; // see above
							}
						}
						mattrs[`move-${mbook}-${mname}`] = ma[takeid]; // Set up the externalized tracking of moves
						// Default to displaying only moves from the playbook
						// If it's marked taken still/already at this point (after checking for playbook defaults), it should not be unmarked! But mbook === "" means a basic move, so don't deal with that.
						if ( mbook === attrs["playbook-key"] ) { 
							mattrs[showid] = "yes"; found = true; // want to make sure to signify when we've actually found a move for the targeted playbook, see use of found further below
						} else if ( ma[takeid] === "yes" && mbook !== "" ) { 
							mattrs[showid] = "yes";
						} else if ( mbook !== "" )  { // skip basic moves; display as-is
							mattrs[showid] = "no"; // for now; eventually we may have differing behaviors depending on current display settings
						}
					}
					log(`setting visibility flags for ${pbkey}`);
					setAttrs(mattrs,{},function() { log(`visibility flags set for ${pbkey}`); });
					// But wait! If we didn't find any moves matching the targeted playbook, that means the playbook isn't loaded yet.
					log(`found status is ${found}`);
					console.log(found);
					if ( ! found ) { 
						loadPlaybookMoves(pbkey, true); // second argument indicates that any pbdefault === "yes" should be marked taken
					}
				});

			});

		});
	});

	// There are three additive-ish filter modes for moves
	
	on("clicked:movefilter-pbmoves", function() {
		log("Handler: clicked:movefilter-pbmoves");
		getSectionIDs("moves", function(mf) {
			var mfields = ["playbook-key","movefilter-hidespecial","movefilter-hideplaybook","movefilter-hidetruths","movefilter-hidebasic","movefilter"];
			var offset = mfields.length;
			for(var i=0; i < mf.length; i++ ) {
				mfields[i*4+offset] = "repeating_moves_" + mf[i] + "_playbook";
				mfields[i*4+offset+1] = "repeating_moves_" + mf[i] + "_pbdefault";
				mfields[i*4+offset+2] = "repeating_moves_" + mf[i] + "_taken";
				mfields[i*4+offset+3] = "repeating_moves_" + mf[i] + "_category";
			}
			getAttrs(mfields, function(ma) {
				var mattrs = { "movefilter-takenonly": "no" };
				for(var i=0; i < mf.length; i++) {
					var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
					var mdefid  = "repeating_moves_" + mf[i] + "_pbdefault"; var mdef = ma[mdefid];
					var takeid  = "repeating_moves_" + mf[i] + "_taken"; var taken = ma[takeid];
					var catid   = "repeating_moves_" + mf[i] + "_category"; var cat = ma[catid];
					var showid  = "repeating_moves_" + mf[i] + "_show";
					if ( mbook === ma["playbook-key"] || taken === "yes" ) { // If it's marked taken or it's in the active playbook, show it
						mattrs[showid] = "yes";
						// unless...
						if ( cat === "basic" && typeof ma["movefilter-hidebasic"] !== "undefined" && ma["movefilter-hidebasic"] === "yes" ) {
							mattrs[showid] = "no";
						} else if ( cat === "special" && typeof ma["movefilter-hidespecial"] !== "undefined" && ma["movefilter-hidespecial"] === "yes" ) {
							mattrs[showid] = "no";
						} else if ( cat === "playbook" && typeof ma["movefilter-hideplaybook"] !== "undefined" && ma["movefilter-hideplaybook"] === "yes" ) {
							mattrs[showid] = "no";
						} else if ( cat === "truths" && typeof ma["movefilter-hidetruths"] !== "undefined" && ma["movefilter-hidetruths"] === "yes" ) {
							mattrs[showid] = "no";
						}
					} else { // if it's not, hide it
						mattrs[showid] = "no";
					}
				}
				setAttrs(mattrs);
			});
		});
	});

	on("clicked:movefilter-allmoves", function() {
		log("Handler: clicked:movefilter-allmoves");
		getSectionIDs("moves", function(mf) {
			var mfields = ["playbook-key","movefilter-hidespecial","movefilter-hideplaybook","movefilter-hidetruths","movefilter-hidebasic","movefilter"];
			var offset = mfields.length;
			for(var i=0; i < mf.length; i++ ) {
				mfields[i*4+offset] = "repeating_moves_" + mf[i] + "_playbook";
				mfields[i*4+offset+1] = "repeating_moves_" + mf[i] + "_pbdefault";
				mfields[i*4+offset+2] = "repeating_moves_" + mf[i] + "_taken";
				mfields[i*4+offset+3] = "repeating_moves_" + mf[i] + "_category";
			}
			getAttrs(mfields, function(ma) {
				var mattrs = { "movefilter-takenonly": "no" };
				for(var i=0; i < mf.length; i++) {
					var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
					var mdefid  = "repeating_moves_" + mf[i] + "_pbdefault"; var mdef = ma[mdefid];
					var takeid  = "repeating_moves_" + mf[i] + "_taken"; var taken = ma[takeid];
					var catid   = "repeating_moves_" + mf[i] + "_category"; var cat = ma[catid];
					var showid  = "repeating_moves_" + mf[i] + "_show";
					mattrs[showid] = "yes"; // Show everything.
					// unless...
					if ( cat === "basic" && typeof ma["movefilter-hidebasic"] !== "undefined" && ma["movefilter-hidebasic"] === "yes" ) {
						mattrs[showid] = "no";
					} else if ( cat === "special" && typeof ma["movefilter-hidespecial"] !== "undefined" && ma["movefilter-hidespecial"] === "yes" ) {
						mattrs[showid] = "no";
					} else if ( cat === "playbook" && typeof ma["movefilter-hideplaybook"] !== "undefined" && ma["movefilter-hideplaybook"] === "yes" ) {
						mattrs[showid] = "no";
					} else if ( cat === "truths" && typeof ma["movefilter-hidetruths"] !== "undefined" && ma["movefilter-hidetruths"] === "yes" ) {
						mattrs[showid] = "no";
					}
				}
				setAttrs(mattrs);
			});
		});
	});

	on("clicked:repeating_playbooks:movefilter-onepb", function(e) {
		log("Handler: clicked:repeating_playbooks:movefilter-onepb");
		var rowprefix = (e.sourceAttribute).slice(0,-16); // Strips off the 'movefilter-onepb'
		getAttrs([`${rowprefix}key`,`${rowprefix}loaded`], function(kf) {
			if ( typeof kf[`${rowprefix}loaded`] !== "undefined" && kf[`${rowprefix}loaded`] === "yes" ) {
				getSectionIDs("moves", function(mf) {
					var mfields = ["playbook-key","movefilter-hidespecial","movefilter-hideplaybook","movefilter-hidetruths","movefilter-hidebasic","movefilter"];
					var offset = mfields.length;
					for(var i=0; i < mf.length; i++ ) {
						mfields[i*4+offset] = "repeating_moves_" + mf[i] + "_playbook";
						mfields[i*4+offset+1] = "repeating_moves_" + mf[i] + "_pbdefault";
						mfields[i*4+offset+2] = "repeating_moves_" + mf[i] + "_taken";
						mfields[i*4+offset+3] = "repeating_moves_" + mf[i] + "_category";
					}
					getAttrs(mfields, function(ma) {
						var mattrs = { "movefilter-takenonly": "no" };
						for(var i=0; i < mf.length; i++) {
							var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
							var mdefid  = "repeating_moves_" + mf[i] + "_pbdefault"; var mdef = ma[mdefid];
							var takeid  = "repeating_moves_" + mf[i] + "_taken"; var taken = ma[takeid];
							var catid   = "repeating_moves_" + mf[i] + "_category"; var cat = ma[catid];
							var showid  = "repeating_moves_" + mf[i] + "_show";
							if ( mbook === kf[`${rowprefix}key`] ) { // If in the kf indicated playbook, show it
								mattrs[showid] = "yes";
								// unless...
								if ( cat === "basic" && typeof ma["movefilter-hidebasic"] !== "undefined" && ma["movefilter-hidebasic"] === "yes" ) {
									mattrs[showid] = "no";
								} else if ( cat === "special" && typeof ma["movefilter-hidespecial"] !== "undefined" && ma["movefilter-hidespecial"] === "yes" ) {
									mattrs[showid] = "no";
								} else if ( cat === "playbook" && typeof ma["movefilter-hideplaybook"] !== "undefined" && ma["movefilter-hideplaybook"] === "yes" ) {
									mattrs[showid] = "no";
								} else if ( cat === "truths" && typeof ma["movefilter-hidetruths"] !== "undefined" && ma["movefilter-hidetruths"] === "yes" ) {
									mattrs[showid] = "no";
								}
							}
						}
						setAttrs(mattrs);
					});
				});
			} else {
				// If we're here, the playbook isn't loaded yet, so, let's do so.
				loadPlaybookMoves(kf[`${rowprefix}key`]);
			}
		});
	});

	on("clicked:movefilter-hideprohibited", function() {
		log("Handler: clicked:movefilter-hideprohibited");
		getSectionIDs("moves", function(mf) {
			var mfields = ["playbook-key"];
			for(var i=0; i < mf.length; i++ ) {
				mfields[i*3+1] = "repeating_moves_" + mf[i] + "_playbook";
				mfields[i*3+2] = "repeating_moves_" + mf[i] + "_pbother";
				mfields[i*3+3] = "repeating_moves_" + mf[i] + "_taken";
			}
			getAttrs(mfields, function(ma) {
				var mattrs = {};
				for(var i=0; i < mf.length; i++) {
					var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
					var moid = "repeating_moves_" + mf[i] + "_pbother"; var mo = ma[moid];
					var takeid = "repeating_moves_" + mf[i] + "_taken";
					var showid = "repeating_moves_" + mf[i] + "_show";
					if ( ma[takeid] !== "yes" && ma["playbook-key"] !== mbook && typeof mo !== "undefined" && mo === "no" ) {
						// If it's not a taken move, pbother = no, and current playbook isn't this move's playbook, hide the move
						mattrs[showid] = "no";
					}
				}
				setAttrs(mattrs);
			});
		});
	});

// Checkbox handlers for move filtering

/*
	on("clicked:movefilter-takenonly", function() {
		log("Handler: clicked:movefilter-takenonly");
		getSectionIDs("moves", function(mf) {
			log(mf);
			var mfields = ["playbook-key"];
			for(var i=0; i < mf.length; i++ ) {
				mfields[i*3+1] = "repeating_moves_" + mf[i] + "_playbook";
				mfields[i*3+2] = "repeating_moves_" + mf[i] + "_pbdefault";
				mfields[i*3+3] = "repeating_moves_" + mf[i] + "_taken";
			}
			getAttrs(mfields, function(ma) {
				var mattrs = {};
				for(var i=0; i < mf.length; i++) {
					var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
					var mdefid = "repeating_moves_" + mf[i] + "_pbdefault"; var mdef = ma[mdefid];
					var takeid = "repeating_moves_" + mf[i] + "_taken";
					var showid = "repeating_moves_" + mf[i] + "_show";
					if ( ma[takeid] === "yes" ) { // If it's marked taken, show it
						mattrs[showid] = "yes";
					} else { // if it's not, hide it
						mattrs[showid] = "no";
					}
				}
				log(mattrs);
				setAttrs(mattrs);
			});
		});
	});
*/

	on("change:movefilter-takenonly", function() {
		log("Handler: change:movefilter-takenonly");
		getSectionIDs("moves", function(mf) {
			var mfields = ["playbook-key","movefilter-takenonly"];
			for(var i=0; i < mf.length; i++ ) {
				mfields[i*2+2] = "repeating_moves_" + mf[i] + "_playbook";
				mfields[i*2+3] = "repeating_moves_" + mf[i] + "_taken";
			}
			getAttrs(mfields, function(ma) {
				var mattrs = {};
				var state = "yes";
				if ( typeof ma["movefilter-takenonly"] !== "undefined" && ma["movefilter-takenonly"] === "yes" ) {
					state = "no";
				}
				for(var i=0; i < mf.length; i++) {
					var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
					var takeid = "repeating_moves_" + mf[i] + "_taken"; var taken = ma[takeid];
					var showid = "repeating_moves_" + mf[i] + "_show";
					// log(`for ${mf[i]} taken is ${taken}`);
					if ( typeof taken === "undefined" || taken !== "yes" ) {
						if ( state === "no" ) { 
							mattrs[showid] = "no";
						} else if ( state === "yes" && mbook === ma["playbook-key"] ) {
							// If turned off, then the minimum is to show the current playbook's untaken moves. Other ones from outside the playbook will need to be re-revealed.
							mattrs[showid] = "yes";
						}
					}
				}
				setAttrs(mattrs);
			});
		});
	});

// These all address hiding things by their (hidden) category code: special, playbook, truths, and basic. Truths is specific to TSL, but I'm leaving it in the main code here because it's easy enough to scrub out as needed.

	on("change:movefilter-hidebasic", function() {
		log("Handler: change:movefilter-hidebasic");
		getSectionIDs("moves", function(mf) {
			var mfields = ["playbook-key","movefilter-hidebasic"];
			for(var i=0; i < mf.length; i++ ) {
				mfields[i*2+2] = "repeating_moves_" + mf[i] + "_playbook";
				mfields[i*2+3] = "repeating_moves_" + mf[i] + "_category"; // if this is not null or empty, then we need to do a little extra
			}
			getAttrs(mfields, function(ma) {
				var mattrs = {};
				for(var i=0; i < mf.length; i++) {
					var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
					var catid = "repeating_moves_" + mf[i] + "_category"; var cat = ma[catid];
					var showid = "repeating_moves_" + mf[i] + "_show";
					var state = "yes";
					if ( typeof ma["movefilter-hidebasic"] !== "undefined" && ma["movefilter-hidebasic"] === "yes" ) {
						state = "no";
					}
					if ( cat === "basic" ) { // For basic moves the logic is simple.
						mattrs[showid] = state;
					}
				}
				setAttrs(mattrs);
			});
		});
	});

	on("change:movefilter-hidespecial", function() {
		log("Handler: change:movefilter-hidespecial");
		getSectionIDs("moves", function(mf) {
			var mfields = ["playbook-key","movefilter-hidespecial"];
			for(var i=0; i < mf.length; i++ ) {
				mfields[i*2+2] = "repeating_moves_" + mf[i] + "_playbook";
				mfields[i*2+3] = "repeating_moves_" + mf[i] + "_category"; // if this is not null or empty, then we need to do a little extra
			}
			getAttrs(mfields, function(ma) {
				var mattrs = {};
				for(var i=0; i < mf.length; i++) {
					var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
					var catid = "repeating_moves_" + mf[i] + "_category"; var cat = ma[catid];
					var showid = "repeating_moves_" + mf[i] + "_show";
					var state = "yes";
					if ( typeof ma["movefilter-hidespecial"] !== "undefined" && ma["movefilter-hidespecial"] === "yes" ) {
						state = "no";
					}
					if ( cat === "special" && ( state === "no" || ( state === "yes" && mbook === ma["playbook-key"] ) ) ) { // We can only toggle things back to visibility if they're part of the current playbook; but if it's hide them, hide them all
						mattrs[showid] = state;
					}
				}
				setAttrs(mattrs);
			});
		});
	});

	on("change:movefilter-hidetruths", function() {
		log("Handler: change:movefilter-hidetruths");
		getSectionIDs("moves", function(mf) {
			var mfields = ["playbook-key","movefilter-hidetruths"];
			for(var i=0; i < mf.length; i++ ) {
				mfields[i*2+2] = "repeating_moves_" + mf[i] + "_playbook";
				mfields[i*2+3] = "repeating_moves_" + mf[i] + "_category"; // if this is not null or empty, then we need to do a little extra
			}
			getAttrs(mfields, function(ma) {
				var mattrs = {};
				for(var i=0; i < mf.length; i++) {
					var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
					var catid = "repeating_moves_" + mf[i] + "_category"; var cat = ma[catid];
					var showid = "repeating_moves_" + mf[i] + "_show";
					var state = "yes";
					if ( typeof ma["movefilter-hidetruths"] !== "undefined" && ma["movefilter-hidetruths"] === "yes" ) {
						state = "no";
					}
					if ( cat === "truths" && ( state === "no" || ( state === "yes" && mbook === ma["playbook-key"] ) ) ) { // We can only toggle things back to visibility if they're part of the current playbook; but if it's hide them, hide them all
						mattrs[showid] = state;
					}
				}
				setAttrs(mattrs);
			});
		});
	});

	on("change:movefilter-hideplaybook", function() {
		log("Handler: change:movefilter-hideplaybook");
		getSectionIDs("moves", function(mf) {
			var mfields = ["playbook-key","movefilter-hideplaybook"];
			for(var i=0; i < mf.length; i++ ) {
				mfields[i*2+2] = "repeating_moves_" + mf[i] + "_playbook";
				mfields[i*2+3] = "repeating_moves_" + mf[i] + "_category"; // if this is not null or empty, then we need to do a little extra
			}
			getAttrs(mfields, function(ma) {
				var mattrs = {};
				for(var i=0; i < mf.length; i++) {
					var mbookid = "repeating_moves_" + mf[i] + "_playbook"; var mbook = ma[mbookid];
					var catid = "repeating_moves_" + mf[i] + "_category"; var cat = ma[catid];
					var showid = "repeating_moves_" + mf[i] + "_show";
					var state = "yes";
					if ( typeof ma["movefilter-hideplaybook"] !== "undefined" && ma["movefilter-hideplaybook"] === "yes" ) {
						state = "no";
					}
					if ( cat === "playbook" && ( state === "no" || ( state === "yes" && mbook === ma["playbook-key"] ) ) ) { // We can only toggle things back to visibility if they're part of the current playbook; but if it's hide them, hide them all
						mattrs[showid] = state;
					}
				}
				setAttrs(mattrs);
			});
		});
	});

	// A set of starting stats has been picked. Get going.

	on("clicked:repeating_startingstats:choose-startingstats", function(e) {
		log("Handler: clicked:repeating_startingstats:choose-startingstats");
		var rowprefix = (e.sourceAttribute).slice(0,-20); // Strips off the 'choose-startingstats'
		var setid = rowprefix + "set";
		getAttrs(["starting-chosen", setid], function(a) {
			if ( typeof a["starting-chosen"] === "undefined" || a["starting-chosen"] === "0" ) { // Then we may proceed, otherwise buttons are locked
				var statspec = a[setid];
				var statmap = {};
				var statspeclist = statspec.toString().split(/ /);
				for(var j=0; j < statspeclist.length; j++ ) {
					var parts = statspeclist[j].toString().split(/:/);
					var statkey = parts[0];
					var statval = parts[1];
					statmap[statkey] = statval;
				}
				getSectionIDs("stats", function(sf) {
					var sfields = [];
					for(var i=0; i < sf.length; i++ ) {
						sfields[i] = "repeating_stats_" + sf[i] + "_key";
					}
					getAttrs(sfields,function(sa) {
						var sattrs = { "starting-chosen": "yes" };
						for(var i=0; i < sfields.length; i++) {
							var key = sa[sfields[i]];
							if ( typeof statmap[key] !== "undefined" ) {
								var rateid = "repeating_stats_" + sf[i] + "_rating";
								sattrs[rateid] = statmap[key];
							}
						}
						setAttrs(sattrs);
					});
				});
			} else {
				log("Starting stat choice was already made, current stats menu is locked.");
			}
		});
	});

	// Conditions -> Modifiers

	on("change:conditions-penalty", function() {
		log("Handler: change:conditions-penalty");
		getSectionIDs("conditions", function(f) {
			var fields = ["conditions-penalty"];
			for(var i=0; i < f.length; i++) {
				fields[i+1] = "repeating_conditions_" + f[i] + "_penalty";
			}
			getAttrs(fields, function(c) {
				var cats = {};
				for(var i=0; i < f.length; i++) {
					var penaltyid = fields[i+1];
					if ( typeof c["conditions-penalty"] !== "undefined" && c[penaltyid] !== c["conditions-penalty"] ) {
						cats[penaltyid] = c["conditions-penalty"];
					}
				}
				setAttrs(cats);
			});
		});
	});
	
	on("change:repeating_conditions:marked", function(e) {
		log("Handler: change:repeating_conditions:marked");
		var rowid = (e.sourceAttribute).slice(0,-6); // Strips off the 'marked';
		var markedid = `${rowid}marked`;
		var nameid = `${rowid}name`;
		var penaltyid = `${rowid}penalty`;
		var moveidid = `${rowid}moveid`;
		var penalizedid = `${rowid}penalized`;
		var tcmid = "conditions-marked";
		getAttrs([nameid, markedid, penaltyid, penalizedid, moveidid ],function(m) {
			var marked = m[markedid];
			var name = m[nameid];
			var penalty = m[penaltyid];
			var penalized = m[penalizedid];
			if ( typeof marked !== "undefined" && marked === "yes" ) {
				// then it is marked, and we need to create a modifier matching it
				var sattrs = {};
				var modifierid = "repeating_modifiers_" + generateActuallyUniqueRowID();
				sattrs[`${modifierid}_used`] = "yes";
				sattrs[`${modifierid}_condition-id`] = rowid;
				sattrs[`${modifierid}_modifier`] = penalty;
				sattrs[`${modifierid}_state`] = "ongoing";
				sattrs[`${modifierid}_statename`] = gTBK("ongoing");

				sattrs[`${modifierid}_target`] = penalized + ' ('+name+')';
				// We'll also want to flip a flag on the relevant basic move entry.
				if ( typeof m[moveidid] !== "undefined" && m[moveidid] !== "" ) {
					var moveid = m[moveidid];
					sattrs[`repeating_basic_${moveid}_condition-marked`] = "yes";
					sattrs[`${modifierid}_moveid`] = moveid;
					sattrs[`repeating_basic_${moveid}_modifier-marked`] = gTBK("Modifier is not marked.");
					sattrs[`repeating_basic_${moveid}_modifierid`] = modifierid;
				}

				// But before we can set our attributes we also need to make sure to update our tally, and make it accurate.
				getSectionIDs("repeating_conditions", function(carray) {
					var cids = [];
					for ( var i=0; i < carray.length; i++ ) {
						cids[i] = "repeating_conditions_" + carray[i] + "_marked";
					}
					getAttrs(cids,function(c) {
						var tally = 0;
						for ( var i=0; i < carray.length; i++ ) {
							if ( typeof c[cids[i]] !== "undefined" && c[cids[i]] === "yes" ) {
								tally++;
							}
						}
						sattrs[tcmid] = tally;
						setAttrs(sattrs);
					});
				});

			} else {
				// then it is unmarked, and we need to make sure we do not retain a modifier matching it
				// rowid contains the condition's id; we need to find all modifiers that match it in case there was a misfire that caused it to get populated to the list twice
				getSectionIDs("repeating_modifiers", function(idarray) {
					var mids = [];
					for(var i=0; i < idarray.length; i++ ) {
						mids[i] = "repeating_modifiers_" + idarray[i] + "_condition-id";
					}
					getAttrs(mids,function(mdf) {
						var u = {};
						for(var i=0; i < idarray.length; i++ ) {
							if ( mdf[mids[i]] === rowid ) {
								// reality is, this should work but doesn't because roll20 can't be bothered to fire off its own remove event, so, workaround time
								// removeRepeatingRow("repeating_modifiers_"+idarray[i]);
								var uid = "repeating_modifiers_"+idarray[i]+"_used";
								var mid = "repeating_modifiers_"+idarray[i]+"_modifier";
								u[uid] = "delete";
								u[mid] = "0";
							}
						}
						// We also need to attend to flipping off the flag that was on the associated move, if any
						if ( typeof m[moveidid] !== "undefined" && m[moveidid] !== "" ) {
							var moveid = m[moveidid];
							u[`repeating_basic_${moveid}_condition-marked`] = "no";
						}

						// But before we can set our attributes we also need to make sure to update our tally, and make it accurate.
						getSectionIDs("repeating_conditions", function(carray) {
							var cids = [];
							for ( var i=0; i < carray.length; i++ ) {
								cids[i] = "repeating_conditions_" + carray[i] + "_marked";
							}
							getAttrs(cids,function(c) {
								var tally = 0;
								for ( var i=0; i < carray.length; i++ ) {
									if ( typeof c[cids[i]] !== "undefined" && c[cids[i]] === "yes" ) {
										tally++;
									}
								}
								u[tcmid] = tally;
								setAttrs(u);
							});
						});

					});
				});
			}
		});
	});
	
	// Strings -> Modifiers
	
	on("clicked:repeating_strings:spend", function(e) {
		log("Handler: clicked:repeating_strings:spend");
		var rowprefix = (e.sourceAttribute).slice(0,-5); // Strips off the 'spend'
		var checks = [`${rowprefix}check4`,`${rowprefix}check3`,`${rowprefix}check2`,`${rowprefix}check1`];
		getAttrs(checks, function(check) {
			var unmarkid = "";
			for(var i = 0; i < checks.length; i++ ) {
				if ( typeof check[checks[i]] !== "undefined" && check[checks[i]] === "1" ) {
					unmarkid = checks[i]; break;
				}
			}
			if ( unmarkid !== "" ) {
				var attrs = {};
				attrs[unmarkid] = 0;
				setAttrs(attrs);
			}
		});
		// _spend
	});
	
	// Strings -> Modifiers
	
	on("clicked:repeating_strings:spend3forwardes clicked:repeating_strings:spend3forwardfo", function(e) {
		log("Handler: clicked:repeating_strings:" + (e.sourceAttribute));
		var rowprefix = (e.sourceAttribute).slice(0,-15); // Strips off the 'spend3forwardXX'
		var movekey = (e.sourceAttribute).slice(-2); log(movekey);
		var checks = [`${rowprefix}target`,`${rowprefix}check4`,`${rowprefix}check3`,`${rowprefix}check2`,`${rowprefix}check1`];
		getAttrs(checks, function(check) {
			var unmarkid = "";
			for(var i = 1; i < checks.length; i++ ) {
				if ( typeof check[checks[i]] !== "undefined" && check[checks[i]] === "1" ) {
					unmarkid = checks[i]; break;
				}
			}
			if ( unmarkid !== "" ) {
				var attrs = {};
				attrs[unmarkid] = 0; // That spends it
				// now, create the modifier
				var modid = "repeating_modifiers_" + generateActuallyUniqueRowID() + "_";
				var stateid = `${modid}state`; // attr_state and act_state effectively have the same id, I think? but let's reconstruct.
				var statenid = `${modid}statename`; // grab the name of the state too
				var rmid = `${modid}rollmod`;
				var mnid = `${modid}modifier`;
				var tid = `${modid}target`;
				attrs[stateid] = "forward";
				attrs[statenid] = gTBK("forward");
				attrs[rmid] = "yes";
				attrs[mnid] = 3;
				var move = "";
				if ( movekey === "es" ) {
					move = gTBK("Emotional Support");
				} else if ( movekey === "fo" ) {
					move = gTBK("Figure Out");
				}
				attrs[tid] = move + ' (' + check[`${rowprefix}target`] + ')';
				setAttrs(attrs);
			}
		});
		// _spend
	});

	// Modifiers stuff

	
	// act_mark-modifier

	on("clicked:repeating_basic:mark-modifier", function(e) {
		log("Handler: clicked:repeating_basic:mark-modifier");
		var rowid = (e.sourceAttribute).slice(0,-13); // Strips off the 'mark-modifier';
		var modidid = rowid + "modifierid";
		getAttrs([modidid], function(m) {
			var modifierid = m[modidid];
			if ( typeof modifierid !== "undefined" && modifierid !== "" ) {
				// Then I've hopefully got a valid modifier here, and I can mess with its clicking. But, that also means I need to getAttrs a second time. 
				var rollmodid = modifierid + "_rollmod";
				getAttrs([rollmodid], function(r) {
					log(r);
					if ( typeof r[rollmodid] !== "undefined" && r[rollmodid] !== "" ) {
						var rollmod = r[rollmodid];
						var mats = {};
						if ( rollmod === "yes" ) {
							mats[rollmodid] = "no";
						} else {
							mats[rollmodid] = "yes";
						}
						setAttrs(mats);
					} else {
						log("there was no valid rollmod value");
					}
				});
			}
		});
	});

	/* attr_state, act_state */

	on("clicked:mods-checkall", function() {
		log("Handler: clicked:mods-checkall");
		getSectionIDs("repeating_modifiers", function(idarray) {
			mlist = [];
			for(var i=0; i < idarray.length; i++ ) {
				mlist[i] = "repeating_modifiers_"+idarray[i]+"_used";
			}
			getAttrs(mlist, function(m) {
				var mattrs = {};
				for(var i=0; i < idarray.length; i++ ) {
					var uid = "repeating_modifiers_"+idarray[i]+"_used"; 
					var u = m[uid];
					var rid = "repeating_modifiers_"+idarray[i]+"_rollmod"; 
					if ( typeof u !== "undefined" && u === "yes" ) {
						mattrs[rid] = "yes"; 
					}
				}
				setAttrs(mattrs);
			});
		});
	});

	on("clicked:mods-uncheckall", function() {
		log("Handler: clicked:mods-uncheckall");
		getSectionIDs("repeating_modifiers", function(idarray) {
			mlist = [];
			for(var i=0; i < idarray.length; i++ ) {
				mlist[i] = "repeating_modifiers_"+idarray[i]+"_used";
			}
			getAttrs(mlist, function(m) {
				var mattrs = {};
				for(var i=0; i < idarray.length; i++ ) {
					var uid = "repeating_modifiers_"+idarray[i]+"_used"; 
					var u = m[uid];
					var rid = "repeating_modifiers_"+idarray[i]+"_rollmod"; 
					if ( typeof u !== "undefined" && u === "yes" ) {
						mattrs[rid] = "no"; 
					}
				}
				setAttrs(mattrs);
			});
		});
	});

	on("clicked:repeating_modifiers:state", function(e) {
		log("Handler: clicked:repeating_modifiers:state");
		var rowid = (e.sourceAttribute).slice(0,-5); // Strips off the 'state';
		var stateid = `${rowid}state`; // attr_state and act_state effectively have the same id, I think? but let's reconstruct.
		var statenid = `${rowid}statename`; // grab the name of the state too
		getAttrs([stateid],function(s) {
			var sattrs = {};
			if ( s[stateid] === "forward" ) {
				sattrs[stateid] = "ongoing";
				sattrs[statenid] = gTBK("ongoing");
			} else {
				sattrs[stateid] = "forward";
				sattrs[statenid] = gTBK("forward");
			}
			setAttrs(sattrs);
		});
	});

	on("clicked:repeating_modifiers:trash", function(e) {
		log("Handler: clicked:repeating_modifiers:trash");
		var rowid = (e.sourceAttribute).slice(0,-6); // Strips off the '_trash';
		var sattrs = {};
		sattrs[`${rowid}_used`] = "delete";
		sattrs[`${rowid}_modifier`] = "0"; // This'll make sure the totalling handler will fire off
		setAttrs(sattrs); // Please trigger the handler
	});

	// this had a blanket change:repeating_modifiers originally, don't think that's right

	on("change:repeating_modifiers:rollmod change:repeating_modifiers:modifier remove:repeating_modifiers", function() { 
		log("Handler: change:repeating_modifiers:rollmod change:repeating_modifiers:modifier remove:repeating_modifiers");
		// We need to examine whether any entries count as unused, and if there are multiples, remove them, and if there are none, add one.
		var mlist = []; var mflist = [];
		getSectionIDs("repeating_modifiers", function(idarray) {
			for(var i=0; i < idarray.length; i++ ) {
				mlist[i] = "repeating_modifiers_"+idarray[i];
				mflist[i*6] = mlist[i] + "_used";
				mflist[i*6+1] = mlist[i] + "_rollmod";
				mflist[i*6+2] = mlist[i] + "_target"; 
				mflist[i*6+3] = mlist[i] + "_modifier"; 
				mflist[i*6+4] = mlist[i] + "_moveid"; 
				mflist[i*6+5] = mlist[i] + "_statename";
			}
			mflist[idarray.length*6] = "rollprompt-mods";
			var sattrs = {};
			if ( mlist.length > 0 ) {
				getAttrs(mflist, function(mf) {
					var keeper = false;
					var tally = 0;
					var tallytext = ""; var tscount = 0;
					var dostring = false;
					if ( typeof mf["rollprompt-mods"] !== "undefined" && mf["rollprompt-mods"] === "1" ) {
						dostring = true;
					}
					for(var i=0; i < mlist.length; i++ ) {
						var usedid = mlist[i] + "_used"; var used = mf[usedid];
						var rollmodid = mlist[i] + "_rollmod"; var rollmod = mf[rollmodid];
						var targetid = mlist[i] + "_target"; var target = mf[targetid];
						var modifierid = mlist[i] + "_modifier"; var modifier = mf[modifierid];
						var snid = mlist[i] + "_statename"; var statename = mf[snid];
						var moveidid = mlist[i] + "_moveid"; var moveid = mf[moveidid];
						if ( used === "delete" ) {
							removeRepeatingRow(mlist[i],{silent:true}); 
						} else if (
							( typeof target === "undefined" || target === "" ) 
							&& ( typeof rollmod === "undefined" || rollmod !== "yes" ) 
							&& ( typeof modifier === "undefined" || modifier === "0" ) 
						) {
							if ( i < (mlist.length - 1) ) {
								// Then it's a blank, no checkmark, 0 modifier, blank target; we only need one of those, and they're interchangeable, so we'll delete these
								removeRepeatingRow(mlist[i],{silent:true}); // We don't need to trigger a bunch of runs through of this handler just because we're removing rows because we are already in this handler
							} else {
								// The exception is if it's the very last one in the list. We don't need to delete that one only to create another every time.
								keeper = true;
								sattrs[usedid] = "no"; 
							}
						} else { 
							sattrs[usedid] = "yes";
							// if we're here, we can also figure out the total of checkmarked stuff
							if ( typeof rollmod !== "undefined" && rollmod === "yes" ) { 
								var mod = 0;
								if ( typeof modifier !== "undefined" ) {
									mod = parseInt(modifier);
									if ( isNaN(mod) ) {
										mod = 0;
									}
									tally = tally + mod;
									// ZODDDD {{title=@{name}}} statename target modifier
									tscount = tscount + 1;
									var sign = ""; if ( mod > -1 ) { sign = "+"; }
									tallytext = tallytext + " {{checked" + tscount + "=" + sign + mod + " " + statename + " " + target + "}}";
								}
								// we should make a note in the appropriate move
								if ( typeof moveid !== "undefined" && moveid !== "" ) {
									sattrs[`repeating_basic_${moveid}_modifier-marked`] = gTBK("Modifier is marked.");								
									sattrs[`repeating_basic_${moveid}_modifierid`] = mlist[i]; // store the modifier's ID on the move								
								} else {
									log("no moveid");
								}
							} else if ( typeof moveid !== "undefined" && moveid !== "" ) {
								// rollmod isn't yes, so if there's an associated move, its modifier is not marked
								sattrs[`repeating_basic_${moveid}_modifier-marked`] = gTBK("Modifier is not marked.");
							}
						}
					}

					// At this point if keeper = true, we don't need to create a new row; if false, we do.
					// Or, if there are no entries, we need to create one, because there always needs to be at least one.
					if ( ! keeper || mlist.length === 0 ) {
						var modifierid = "repeating_modifiers_" + generateActuallyUniqueRowID();
						sattrs[`${modifierid}_used`] = "no"; // Creates our a new modifier entry
					}
					setAttrs(sattrs,{silent:true}); // We don't need to trigger a bunch of runs through this handler because we're setting attributes *with* this handler.
					var actualtext = "";
					if ( dostring ) { actualtext = tallytext; }
					setAttrs({"modifier-tally": tally, "modifier-tally-text": actualtext, "modifier-tally-text-memory": tallytext}); // but we do need the tally to trigger side-effects
				});
			} else { // I suspect if there's no array, getAttrs doesn't bother to fire off its callback, which is a shame because I expected it to.
				var modifierid = "repeating_modifiers_" + generateActuallyUniqueRowID();
				sattrs[`${modifierid}_used`] = "no"; // Creates our a new modifier entry
				setAttrs(sattrs,{silent:true}); // We don't need to trigger a bunch of runs through this handler because we're setting attributes *with* this handler.
			}
		});
	});
	
	// Strings stuff

	on("clicked:repeating_strings:trash", function(e) {
		log("Handler: clicked:repeating_strings:trash");
		var rowid = (e.sourceAttribute).slice(0,-6); // Strips off the '_trash';
		var sattrs = {};
		sattrs[`${rowid}_used`] = "delete";
		setAttrs(sattrs); // Please trigger the fucking handler
	});

	on("change:repeating_strings remove:repeating_strings", function() {
		log("Handler: change:repeating_strings remove:repeating_strings");
		// We need to examine whether any entries count as unused, and if there are multiples, remove them, and if there are none, add one.
		var slist = []; var sflist = [];
		getSectionIDs("repeating_strings", function(idarray) {
			for(var i=0; i < idarray.length; i++ ) {
				slist[i] = "repeating_strings_"+idarray[i];
				sflist[i*6] = slist[i] + "_used";
				sflist[i*6+1] = slist[i] + "_check1"; sflist[i*6+2] = slist[i] + "_check2"; sflist[i*6+3] = slist[i] + "_check3"; sflist[i*6+4] = slist[i] + "_check4";
				sflist[i*6+5] = slist[i] + "_target";
			}
			var sattrs = {};
			if ( slist.length > 0 ) {
				getAttrs(sflist, function(sf) {
					var keeper = false;
					for(var i=0; i < slist.length; i++ ) {
						var usedid = slist[i] + "_used";
						var check1id = slist[i] + "_check1"; var check2id = slist[i] + "_check2"; var check3id = slist[i] + "_check3"; var check4id = slist[i] + "_check4";
						var targetid = slist[i] + "_target";
						var used = sf[usedid]; var check1 = sf[check1id]; var check2 = sf[check2id]; var check3 = sf[check3id]; var check4 = sf[check4id]; var target = sf[targetid];
						if ( used === "delete" ) {
							removeRepeatingRow(slist[i],{silent:true}); 
						} else if (
							( typeof target === "undefined" || target === "" ) 
							&& ( typeof check1 === "undefined" || check1 !== "1" ) 
							&& ( typeof check2 === "undefined" || check2 !== "1" ) 
							&& ( typeof check3 === "undefined" || check3 !== "1" ) 
							&& ( typeof check4 === "undefined" || check4 !== "1" ) 
						) {
							if ( i < (slist.length - 1) ) {
								// Then it's a blank with no used checkboxes; we only need one of those, and they're interchangeable, so we'll delete these
								removeRepeatingRow(slist[i],{silent:true}); // We don't need to trigger a bunch of runs through of this handler just because we're removing rows because we are already in this handler
							} else {
								// The exception is if it's the very last one in the list. We don't need to delete that one only to create another every time.
								keeper = true;
								sattrs[usedid] = "no"; 
							}
						} else {
							sattrs[usedid] = "yes";
						}
					}
					// At this point if keeper = true, we don't need to create a new row; if false, we do.
					// Or, if there are no entries, we need to create one, because there always needs to be at least one.
					if ( ! keeper || slist.length === 0 ) {
						var stringid = "repeating_strings_" + generateActuallyUniqueRowID();
						sattrs[`${stringid}_used`] = "no"; // Creates our a new String entry
					}
					setAttrs(sattrs,{silent:true}); // We don't need to trigger a bunch of runs through this handler because we're setting attributes *with* this handler.
				});
			} else { // I suspect if there's no array, getAttrs doesn't bother to fire off its callback, which is a shame because I expected it to.
				var stringid = "repeating_strings_" + generateActuallyUniqueRowID();
				sattrs[`${stringid}_used`] = "no"; // Creates our a new String entry
				setAttrs(sattrs,{silent:true}); // We don't need to trigger a bunch of runs through this handler because we're setting attributes *with* this handler.
			}
		});
	});

	// Modifiers and Roll Button Adjustments

	var rwm = gTBK("roll with modifier");

	on("change:rollprompt-mods change:rollprompt-query change:modifier-tally", function() {
		log("Handler: change:rollprompt-mods change:rollprompt-query change:modifier-tally");
		getAttrs(["rollprompt-mods","rollprompt-query","modifier-tally","modifier-tally-text-memory"], function(f) {
			var defaultconfig = "?{" + rwm + "|0}";
			var usemods = "1";
			if ( typeof f["rollprompt-mods"] === "undefined" || f["rollprompt-mods"] !== "1") {
				usemods = "0";
			}
			var doquery = "1";
			if ( typeof f["rollprompt-query"] === "undefined" || f["rollprompt-query"] !== "1") {
				doquery = "0";
			}
			var tally = "0";
			if ( typeof f["modifier-tally"] !== "undefined" ) {
				tally = f["modifier-tally"];
			}
			var attrs = {};
			if ( usemods === "1" ) {
				if ( doquery === "1" ) {
					// Use standard default config
					attrs["rollprompt"] = "?{" + rwm + "|"+tally+"}";
				} else {
					// We don't want to be bothered by it at all
					attrs["rollprompt"] = tally; // just add the tally
				}
				// That's all well and good, but let's make sure we also grab the tally text value and make that active again.
				attrs["modifier-tally-text"] = f["modifier-tally-text-memory"]; // if we're not looking at modifiers for the tally, it should not send this stuff, so empty it
			} else { // then usemods === 0; we don't tally, so this is simple action
				if ( doquery === "1" ) {
					// Use standard default config
					attrs["rollprompt"] = defaultconfig;
				} else {
					// We don't want to be bothered by it at all
					attrs["rollprompt"] = "";
				}
				attrs["modifier-tally-text"] = ""; // if we're not looking at modifiers for the tally, it should not send this stuff, so empty it
			}
			setAttrs(attrs);
		});
	});

	// Externalizers
	
	// Initialization of the sheet does not fire off any of these, because it's silent:true. 
	///// Actually that was once true but it was clear that roll20 isn't interested in the behavior of that setting being consistent, so I think this stuff does fire off now.

	// Externalize stats data
	
	on("change:repeating_stats:rating", function(e) {
		log("Handler: change:repeating_stats:rating");
		var rowprefix = (e.sourceAttribute).slice(0,-6); // strips off 'rating';
		var rid = rowprefix + "rating";
		var kid = rowprefix + "key";
		getAttrs([rid,kid], function(a) {
			var ratname = "stat_" + a[kid];
			var rats = {};
			rats[ratname] = a[rid];
			setAttrs(rats);
		});
	});
	
	on("change:repeating_stats", function() {
		log("Handler: change:repeating_stats");
		var summary = "";
		// name, rating
		getSectionIDs("repeating_stats", function (a) {
			var sids = [];
			for(var i = 0; i < a.length; i++) {
				sids[i*2] = "repeating_stats_" + a[i] + "_name";
				sids[i*2+1] = "repeating_stats_" + a[i] + "_rating";
			}
			getAttrs(sids,function(f) {
				for(var i = 0; i < a.length; i++) {
					var name = f[sids[i*2]];
					var rating = f[sids[i*2+1]];
					var mod = parseInt(rating);
					if ( isNaN(mod) ) {
						mod = 0;
					}
					if ( mod > 0 ) {
						rating = "+" + rating;
					} else if ( mod == 0 ) {
						rating = "=" + rating;
					}
					summary = summary + `${name}${rating} `;
				}
				setAttrs({ "stats-summary": summary });
			});
		});
	});

	// Externalize move selection data

	on("change:repeating_moves:taken", function(e) { 
		log("Handler: change:repeating_moves:taken");
		var rowprefix = (e.sourceAttribute).slice(0,-5); // strips off 'taken';
		var mid = rowprefix + "taken";
		var pid = rowprefix + "playbook";
		var nid = rowprefix + "name";
		var tlid = rowprefix + "tracklabel";
		var tid = rowprefix + "trackid";
		getAttrs([mid,pid,nid,tlid,tid], function(a) {
			var mats = {};
			var matname = "move-" + a[pid] + "-" + a[nid]; // e.g., move-beast-Ferocious
			var taken = "0";
			if ( a[mid] === "yes" ) { taken = "yes"; } 
			mats[matname] = taken;
			// good place to also make tracklabel determinations
			if ( typeof a[tlid] !== "undefined" && a[tlid] !== "" ) {
				// then this has a track 
				log("this move has a tracklabel set");
				if ( taken === "yes" ) {
					// Then we need to create a track with the track label value as the label
					// also set the trackid on the original move, to cross-connect
					// also set the rowprefix on the track in case we need cross connection the other direction
					var trackid = "repeating_tracks_"+ generateActuallyUniqueRowID();
					mats[tid] = trackid; 
					mats[`${trackid}_name`] = a[tlid];
					mats[`${trackid}_value`] = 1; // Starts at 1 always in TSL
					mats[`${trackid}_moveid`] = rowprefix;
					log("move is marked taken, so generating track entry");
				} else if ( a[tid] !== "undefined" && a[tid] !== "" ) {
					log("move is not marked taken, but has a trackid value, so removing that track entry");
					// Then there's an existing track, but the move granting it is unmarked; time to get rid of it.
					removeRepeatingRow(a[tid]); // a[tid] = repeating_tracks_<id>
					mats[tid] = ""; // empty the trackid entry on the original move
				}
			}
			setAttrs(mats);
		});
	});

	// Also build a summary of moves
	
	var bigscantimestamp = 0;

	// In this particular case we super need it to also run on sheet open, as a way to quietly correct outdated moves summaries

	on("change:repeating_moves:taken sheet:opened", function() {
		log("Handler: change:repeating_moves:taken sheet:opened -- moves summary");
		var now = Date.now();
		if ( (now - bigscantimestamp) > 999 ) { 
			log("Has been 1+ seconds since last moves summary calculation, summarizing");
			// We are not willing to run this more often than once per second, even if it means things get a little out of date, because to do otherwise could impact sheet speed. Generally this won't be a problem except when multiple moves are getting marked by code at the same time, but player choices afterwards should occur at a slower pace, allowing catch-up.
			bigscantimestamp = now;
			getSectionIDs("repeating_moves", function(midlist) {
				var mids = [];
				for(var i = 0; i < midlist.length; i++) {
					mids[i*2] = "repeating_moves_" + midlist[i] + "_name";
					mids[i*2+1] = "repeating_moves_" + midlist[i] + "_taken";
				}
				console.log(mids);
				getAttrs(mids,function(m) {
					console.log(m);
					var summary = "";
					for(var i = 0; i < midlist.length; i++) {
						var nameid = "repeating_moves_" + midlist[i] + "_name";
						var takeid = "repeating_moves_" + midlist[i] + "_taken";
						var taken = ""; var name = "";
						if ( typeof m[nameid] === "undefined" || m[nameid] === "" ) {
							log(`Name "${m[nameid]}" is undefined or empty`);
							continue; // If it's an empty name, we have no business listing it
						}
						if ( typeof m[takeid] === "undefined" || m[takeid] !== "yes" ) {
							log(`Value "${m[takeid]}" is undefined or not yes`);
							continue; // If it's not taken, don't list it
						}
						name = m[nameid];
						if ( summary !== "" ) {
							summary = summary + ", ";
						}
						summary = summary + name;
					}
					log(`summary determined: ${summary}`);
					setAttrs({ "movesummary": summary },{},function () { log("summary field set"); });
				});
			});
		} else {
			log("Skipping move summary due to simultaneous execution");
		}
	});

	// Externalize conditions data
	
	on("change:repeating_conditions:marked", function(e) {
		log("Handler: change:repeating_conditions:marked");
		var rowprefix = (e.sourceAttribute).slice(0,-6); // strips off 'marked';
		var mid = rowprefix + "marked";
		var pdid = rowprefix + "penalized";
		var moveidid = rowprefix + "moveid";
		var pnid = rowprefix + "penalty";
		var nid = rowprefix + "name";
		getAttrs([mid,pdid,pnid,nid,moveidid], function(a) {
			var cats = {};
			var catname = "condition-" + a[nid];
			var marked = "no";
			if ( a[mid] === "yes" ) { marked = "yes"; }
			cats[catname] = marked;
			var penalty = 0;
			var catpen = "condition-penalty-" + a[pdid];
			if ( marked === "yes" ) {
				penalty = Number(a[pnid]);
			}
			cats[catpen] = penalty;
			setAttrs(cats);
		});
	});

	// Externalize tracks data
	
	on("change:repeating_tracks:value", function(e) {
		log("Handler: change:repeating_tracks:value");
		var rowprefix = (e.sourceAttribute).slice(0,-5); // strips off 'value';
		var vid = rowprefix + "value";
		var nid = rowprefix + "name";
		getAttrs([vid,nid], function(a) {
			var tats = {};
			var tatname = "track-" + a[nid];
			tats[tatname] = a[vid];
			setAttrs(tats);
		});
	});

	// Externalize looks
	
	on("change:repeating_looks", function(e) {
		log("Handler: change:repeating_looks");
		var aesthetics = "";
		// name, desc
		getSectionIDs("repeating_looks", function (a) {
			var lids = [];
			for(var i = 0; i < a.length; i++) {
				lids[i*2] = "repeating_looks_" + a[i] + "_name";
				lids[i*2+1] = "repeating_looks_" + a[i] + "_desc";
			}
			getAttrs(lids,function(f) {
				for(var i = 0; i < a.length; i++) {
					var name = f[lids[i*2]];
					var desc = f[lids[i*2+1]];
					aesthetics = aesthetics + `**${name}:** ${desc}.` + "\n";
				}
				setAttrs({ "aesthetics": aesthetics });
			});
		});
	});
	
	// ======================
	// Sheet Updates Section
	// ======================

	on("sheet:opened", function() {
		getAttrs(["sheet-version"], function(s) {
			var myVersion = "1.0";
			if ( typeof s["sheet-version"] !== "undefined" && s["sheet=version"] !== "" ) {
				myVersion = s["sheet-version"];
			}
			log("This sheet is version "+myVersion);
			if ( myVersion !== codeVersion ) {
				log("This sheet is behind the current version "+codeVersion);
				if ( myVersion === "1.0" ) {
					// Then do what needs to be done for this version to move up.
					var nextVersion = "1.001";
					myVersion = nextVersion;
					// 1.001 #1 Make sure the second bullet (bullet1) of the basics move End of Session is corrected
					var oldtext = getTranslationByKey("Any PC de-escalated a violent situation");
					var newtext = getTranslationByKey("Any PC struck a blow against oppression or de-escalated a violent situation");
					getSectionIDs("repeating_basic", function(blist) {
						var bf = [];
						for(var i=0; i < blist.length; i++ ) {
							var bfpre = "repeating_basic_" + blist[i] + "_";
							bf[i] = bfpre + "bullet1";
						}
						getAttrs(bf, function(bdata) {
							for(var i=0; i < blist.length; i++ ) {
								if ( bdata[bf[i]] === oldtext ) {
									log("discovered oldtext");
									var att = {};
									att[bf[i]] = newtext;
									setAttrs(att);
									break;
								}
							}
						});
					});
				}
				// Once we're comfortable that the right things are being done, 
				// we make sure to setAttrs sheet-version => myVersion
				setAttrs({"sheet-version": myVersion});
			}
		});
	});

</script>

<input type="hidden" name="attr_sheet-version" value="1.0">

<input type="hidden" name="attr_status-message" value="" class="hide-on-null"><div style="text-align: center; margin-top: -20px; margin-bottom: 20px; border-bottom: 1px solid black;" class="bold"><span name="attr_status-message"></span></div>

<input type="hidden" name="attr_playbook-key" class="pkey" value="">

<input type="hidden" name="attr_pbinitialized" value="no">

<input type="hidden" name="attr_rollprompt" value="">

<div class="whole">

	<img src="https://imgsrv.roll20.net/?src=https%3A//raw.githubusercontent.com/fredhicks/ehp-roll20/master/art/tsl-logo.png" width="160" height="80" align="right">

	<div class="toprow">
	<input type="text" name="attr_character_name" class="topname fillme">
	</div>

	<div class="toprow">

		<div class="nocontrol popmenu">
			<div class="popmenu-trigger"><span class="bold"><span data-i18n="Playbook"></span>:</span> <span name="attr_playbook-name"></span></div>
			<div class="popmenu-box">
				<div>
					<span data-i18n="You may experience a short pause before your choice displays, slightly longer for playbooks that haven't been loaded yet! Please note that when displayed, moves will appear in your character sheet in the order in which you loaded them."></span>
				</div>
				<fieldset class="repeating_playbooks">
					<div class="popmenu-section">
						<input type="hidden" name="attr_key" value="">
						<input type="hidden" name="attr_name" value="">
						<input type="hidden" name="attr_selected" value="" class="popmenu-select">
						<button type="action" name="act_choose-playbook" class="buttonless">
							<input type="hidden" name="attr_loaded" value="no" class="hide-on-yes"><span data-i18n="Load and"></span>
							<span data-i18n="Choose"></span>
							<span name="attr_name" class="bold-uncolored"></span>
							<span name="attr_selected" class="pictos"></span>
						</button>
						<input type="hidden" name="attr_bio" value="" class="hide-on-null">
						<div class="tooltip bio">
							<div><span class="pictos">E</span> <span data-i18n="More about"></span> <span name="attr_name"></span></div>
							<div class="tooltip-pop">
								<span name="attr_bio"></span>
							</div>
						</div>
					</div>
				</fieldset>
			</div>
		</div>

		<!-- input type="hidden" name="attr_starting-chosen" value="no" class="hide-on-yes" -->
		<div class="nocontrol popmenu">
			<div class="popmenu-trigger"><span class="bold"><span data-i18n="Starting Stats"></span></span></div>
			<div class="popmenu-box">
				<div><span data-i18n="Pick one of these sets (overwrites current ratings), then add 1 to two different stats."></span></div>
				
				<input type="hidden" name="attr_starting-chosen" value="0" class="hide-on-yes"><div><fieldset class="repeating_startingstats">
					<input type="hidden" name="attr_set" value="">
					<input type="hidden" name="attr_text" value="">
					<button type="action" name="act_choose-startingstats" class="buttonless">
						<span name="attr_text" class="bold-uncolored"></span>
					</button>
				</fieldset></div>
				<input type="checkbox" name="attr_starting-chosen" value="yes" class="checkboxer"><span class="checkboxed"></span>
				<input type="hidden" name="attr_starting-chosen" value="0" class="hide-on-zero hide-on-null"><span>
					<span data-i18n="Choice made and locked"></span>
				</span>
				<input type="hidden" name="attr_starting-chosen" value="0" class="hide-on-yes"><span>
					<span data-i18n="Lock menu to prevent overwrite"></span>
				</span>
			</div>
		</div>
		<div>
			<span class="bold"><span data-i18n="Pronouns"></span>: </span>
			<input type="text" name="attr_pronouns" value="" class="fillme" style="width: 120px">
		</div>
		<input type="hidden" name="attr_movesummary" value="" class="hide-on-null">
		<div class="smallbutton">
			<button type="roll" class="sharemove" style="margin-top: -1px;" value="&{template:introducer} {{character=@{character_name}}} {{pronouns=@{pronouns}}} {{playbook=@{playbook-name}}} {{stats=@{stats-summary}}} {{aesthetics=@{aesthetics}}} {{moves=@{movesummary}}} }"><span data-i18n="Introduce yourself!" class="bold"></span> </button>
		</div>
	</div> <!-- /class=toprow -->

	<!-- input type="hidden" name="attr_pbinitialized" value="no" class="show-on-yes" --><div>


	<input type="hidden" name="attr_height" class="height" value="default">
	<div class="columns">
		<div class="narrow">

			<div class="nocontrol">
				<fieldset class="repeating_stats">
					<input type="hidden" name="attr_key" value="">
					<input type="hidden" name="attr_name" value="">
					<div class="tooltip">
						<div class="section-head one-line">
							<button type="roll" class="sheet-2d6-button-nofloat no-dice stretch bold" value="&{template:2d6-roll} {{character=@{character_name}}} {{title=@{name}}} {{roll=[[2d6+@{rating}+@{rollprompt}]]}} @{modifier-tally-text}" name="roll_2d6">
								<span name="attr_name"></span>
							</button>
							<button type="roll" class="sheet-2d6-button-nofloat minimum bold" value="&{template:2d6-roll} {{character=@{character_name}}} {{title=@{name}}} {{roll=[[2d6+@{rating}+@{rollprompt}]]}}" name="roll_2d6">
								<input type="hidden" name="attr_rating" value="" class="make-plus"><span class="make-plus"></span><span name="attr_rating" class="minimum"></span>
							</button>
						</div>
						<div class="tooltip-pop">
							<div class="bold"><span name="attr_name"></span>: <input type="number" name="attr_rating" value="" min="-9" max="9" class="fillme"></div>
							<div><span name="attr_description"></span></div>
						</div>
					</div>
				</fieldset>
			</div>

			<div class="tooltip">
				<div class="section-head">
					<span data-i18n="Experience"></span>
				</div>
				<div class="xptrack">
					<input type="number" name="attr_experience" value="0" min="0" class="fillme">
					<input type="hidden" name="attr_experience_max" value="5">
				</div>
				<div class="tooltip-pop">
					<span data-i18n="Receive experience (XP) whenever you roll a 6- or when a move tells you to mark XP. A PC can spend XP to take an Advance; consult that section for more."></span>
				</div>
			</div>

			<div class="nocontrol">
				<fieldset class="repeating_tracks">
					<input type="hidden" name="attr_value" value="1">
					<input type="hidden" name="attr_name" value="">
					<input type="hidden" name="attr_moveid" value="">
					<div class="section-head">
						<span name="attr_name"></span>
						(<span name="attr_value"></span>)
					</div>
					<div class="track-container">
						<input type="radio" name="attr_value" value="0"><span></span>
						<input type="radio" name="attr_value" value="1"><span></span>
						<input type="radio" name="attr_value" value="2"><span></span>
						<input type="radio" name="attr_value" value="3"><span></span>
						<input type="radio" name="attr_value" value="4"><span></span>
					</div>
				</fieldset>
			</div>

			<br/>

			<div class="popmenu">
				<div class="bold popmenu-trigger">
					<span data-i18n="Sheet Height"></span>
				</div>
				<div class="popmenu-box">
					<div>
					<input type="radio" name="attr_height" class="height" value="default" checked> <span data-i18n="Default"></span>
					</div>
					<div>
					<input type="radio" name="attr_height" class="height" value="tall"> <span data-i18n="Tall"></span>
					</div>
					<div>
					<input type="radio" name="attr_height" class="height" value="max"> <span data-i18n="Max"></span>
					</div>
				</div>
			</div>

			<div class="flexspacer"></div>

			<div class="copyright-bloc">
				<div class="copyright-statement">
				<span>sheet version</span> <span name="attr_sheet-version"></span><br/>
				<span><span data-i18n="Thirsty Sword Lesbians is copyright Evil Hat Productions, LLC and April Kit Walsh."></span></span>
				</div>
				<img src="https://imgsrv.roll20.net/?src=https%3A//raw.githubusercontent.com/fredhicks/ehp-roll20/master/art/ehp-gsg-logos.png" width="120" height="36">
			</div>

		</div> <!-- class="narrow" column ends -->
		<div class="wide">

			<div class="section-head">
				<div class="popmenu">
					<div class="popmenu-trigger"><span data-i18n="Moves"></span></div>
					<div class="popmenu-box">
						<div><button type="action" name="act_movefilter-pbmoves" class="buttonless"><span class="bold-uncolored"><span data-i18n="My Playbook's Moves Only"></span></span></button></div>
						<div><button type="action" name="act_movefilter-allmoves" class="buttonless"><span class="bold-uncolored"><span data-i18n="Show All Loaded Moves"></span></span></button></div>
						<div><button type="action" name="act_movefilter-hideprohibited" class="buttonless"><span class="bold-uncolored"><span data-i18n="Filter Out Moves I Can't Take"></span></span></button></div>
						<div class="popmenu-section"><input type="checkbox" name="attr_movefilter-takenonly" value="yes" class="checkboxer"><span class="checkboxed"></span> <span class="bold-uncolored"><span data-i18n="Hide Untaken Moves"></span></span></div>
						<div><input type="checkbox" name="attr_movefilter-hidespecial" value="yes" class="checkboxer"><span class="checkboxed"></span> <span class="bold-uncolored"><span data-i18n="Hide Special Features"></span></span></div>
						<div><input type="checkbox" name="attr_movefilter-hideplaybook" value="yes" class="checkboxer"><span class="checkboxed"></span> <span class="bold-uncolored"><span data-i18n="Hide Playbook Moves"></span></span></div>
						<div><input type="checkbox" name="attr_movefilter-hidetruths" value="yes" class="checkboxer"><span class="checkboxed"></span> <span class="bold-uncolored"><span data-i18n="Hide Truths of Heart and Blade"></span></span></div>
						<div><input type="checkbox" name="attr_movefilter-hidebasic" value="yes" class="checkboxer"><span class="checkboxed"></span> <span class="bold-uncolored"><span data-i18n="Hide Basic Moves"></span></span></div>
						<div class="bold popmenu-section"><span data-i18n="Individual Playbook Moves"></span></div>
						<div class="nocontrol"><fieldset class="repeating_playbooks">
							<input type="hidden" name="attr_key" value="">
							<input type="hidden" name="attr_name" value="">
							<div><button type="action" name="act_movefilter-onepb" class="buttonless">&nbsp; <span class="bold-uncolored"><input type="hidden" name="attr_loaded" value="no" class="hide-on-yes"><span data-i18n="Load"></span> <input type="hidden" name="attr_loaded" value="no" class="hide-on-no"><span data-i18n="Show"></span> <span name="attr_name"></span></span></button></div>
						</fieldset></div>
					</div>
				</div>
			</div>
			<div class="nocontrol moves-all">
				<fieldset class="repeating_moves">
					<input type="hidden" name="attr_header" value="" class="hide-on-null"><div><input type="hidden" name="attr_show" value="no" class="hide-on-no"><div class="section-head"><span name="attr_header"></span></div></div>
					<input type="hidden" name="attr_subheader" value="" class="hide-on-null"><div>
						<input type="hidden" name="attr_show" value="no" class="hide-on-no">
						<div class="section-subhead"><span name="attr_subheader"></span></div>
					</div>
					<input type="hidden" name="attr_instructions" value="" class="hide-on-null"><div>
						<input type="hidden" name="attr_show" value="no" class="hide-on-no">
						<div><i><span name="attr_instructions"></span></i></div>
					</div>

					<input type="hidden" name="attr_body" value="">
					<input type="hidden" name="attr_pbother" value="yes">
					<input type="hidden" name="attr_pbdefault" value="no">
					<input type="hidden" name="attr_name" value="" class="hide-on-null">
					<div class="move-whole">
						<div class="move-compressor"><input type="hidden" name="attr_show" value="no" class="hide-on-no"><div class="move">
							<div class="right-buttons">
								<input type="hidden" name="attr_rollconfig" value="" class="hide-on-null">
								<button type="roll" class="sheet-2d6-button-nofloat" value="&{template:2d6-roll} {{character=@{character_name}}} {{title=@{name}}} {{roll=[[2d6+?{@{name} using @{rollconfig}}+@{rollprompt}]]}} @{modifier-tally-text}" name="roll_2d6"></button>
								<button type="roll" class="sharemove" style="margin-top: -1px;" value="&{template:sharemove} {{name=@{name}}} {{playbook=@{playbook}}} {{body=@{body}}} @{shareoptions} }"></button><input type="hidden" name="attr_shareoptions" value="">
							</div>
							<input type="hidden" name="attr_playbook" value="" class="hide-on-null">
							<span><input type="checkbox" name="attr_taken" value="yes" class="checkboxer"><span class="checkboxed"></span></span>
							<span name="attr_name" class="bold"></span>:
							<span name="attr_body"></span> 
							<input type="hidden" name="attr_long" value="yes" class="show-on-yes-combo">
							<input type="checkbox" name="attr_long-expand" value="yes" class="show-on-checked-combo" checked>
							<div class="move-long">
								<input type="hidden" name="attr_preamble" class="hide-on-null" value=""><div class="indented"><span name="attr_preamble"></span></div>
								<input type="hidden" name="attr_bullet0" class="hide-on-null" value=""><div class="result"><ul>
									<input type="hidden" name="attr_bullet0" class="hide-on-null" value=""><li>
										<span name="attr_bullet0"></span>
									</li>
									<input type="hidden" name="attr_bullet1" class="hide-on-null" value=""><li>
										<span name="attr_bullet1"></span>
									</li>
									<input type="hidden" name="attr_bullet2" class="hide-on-null" value=""><li>
										<span name="attr_bullet2"></span>
									</li>
									<input type="hidden" name="attr_bullet3" class="hide-on-null" value=""><li>
										<span name="attr_bullet3"></span>
									</li>
									<input type="hidden" name="attr_bullet4" class="hide-on-null" value=""><li>
										<span name="attr_bullet4"></span>
									</li>
								</ul></div>
								<input type="hidden" name="attr_hit" class="hide-on-null" value=""><div class="result hit">
									<span name="attr_hit"></span>
									<input type="hidden" name="attr_hitbullet0" class="hide-on-null" value=""><div><ul>
										<input type="hidden" name="attr_hitbullet0" class="hide-on-null" value=""><li>
											<span name="attr_hitbullet0"></span>
										</li>
										<input type="hidden" name="attr_hitbullet1" class="hide-on-null" value=""><li>
											<span name="attr_hitbullet1"></span>
										</li>
										<input type="hidden" name="attr_hitbullet2" class="hide-on-null" value=""><li>
											<span name="attr_hitbullet2"></span>
										</li>
										<input type="hidden" name="attr_hitbullet3" class="hide-on-null" value=""><li>
											<span name="attr_hitbullet3"></span>
										</li>
										<input type="hidden" name="attr_hitbullet4" class="hide-on-null" value=""><li>
											<span name="attr_hitbullet4"></span>
										</li>
									</ul></div>
								</div>
								<input type="hidden" name="attr_mixed" class="hide-on-null" value=""><div class="result mixed">
									<span name="attr_mixed"></span>
									<input type="hidden" name="attr_mixedbullet0" class="hide-on-null" value=""><div><ul>
										<input type="hidden" name="attr_mixedbullet0" class="hide-on-null" value=""><li>
											<span name="attr_mixedbullet0"></span>
										</li>
										<input type="hidden" name="attr_mixedbullet1" class="hide-on-null" value=""><li>
											<span name="attr_mixedbullet1"></span>
										</li>
										<input type="hidden" name="attr_mixedbullet2" class="hide-on-null" value=""><li>
											<span name="attr_mixedbullet2"></span>
										</li>
										<input type="hidden" name="attr_mixedbullet3" class="hide-on-null" value=""><li>
											<span name="attr_mixedbullet3"></span>
										</li>
										<input type="hidden" name="attr_mixedbullet4" class="hide-on-null" value=""><li>
											<span name="attr_mixedbullet4"></span>
										</li>
									</ul></div>
								</div>
								<input type="hidden" name="attr_miss" class="hide-on-null" value=""><div class="result miss">
									<span name="attr_miss"></span>
									<input type="hidden" name="attr_missbullet0" class="hide-on-null" value=""><div><ul>
										<input type="hidden" name="attr_missbullet0" class="hide-on-null" value=""><li>
											<span name="attr_missbullet0"></span>
										</li>
										<input type="hidden" name="attr_missbullet1" class="hide-on-null" value=""><li>
											<span name="attr_missbullet1"></span>
										</li>
										<input type="hidden" name="attr_missbullet2" class="hide-on-null" value=""><li>
											<span name="attr_missbullet2"></span>
										</li>
										<input type="hidden" name="attr_missbullet3" class="hide-on-null" value=""><li>
											<span name="attr_missbullet3"></span>
										</li>
										<input type="hidden" name="attr_missbullet4" class="hide-on-null" value=""><li>
											<span name="attr_missbullet4"></span>
										</li>
									</ul></div>
								</div>
								<input type="hidden" name="attr_alternative" class="hide-on-null" value=""><div class="indented"><span name="attr_alternative"></span></div>
								<input type="hidden" name="attr_altbullet0" class="hide-on-null" value=""><div class="result"><ul>
									<input type="hidden" name="attr_altbullet0" class="hide-on-null" value=""><li>
										<span name="attr_altbullet0"></span>
									</li>
									<input type="hidden" name="attr_altbullet1" class="hide-on-null" value=""><li>
										<span name="attr_altbullet1"></span>
									</li>
									<input type="hidden" name="attr_altbullet2" class="hide-on-null" value=""><li>
										<span name="attr_altbullet2"></span>
									</li>
									<input type="hidden" name="attr_altbullet3" class="hide-on-null" value=""><li>
										<span name="attr_altbullet3"></span>
									</li>
									<input type="hidden" name="attr_altbullet4" class="hide-on-null" value=""><li>
										<span name="attr_altbullet4"></span>
									</li>
								</ul></div>
								<input type="hidden" name="attr_althit" class="hide-on-null" value=""><div class="result hit">
									<span name="attr_althit"></span>
									<input type="hidden" name="attr_althitbullet0" class="hide-on-null" value=""><div><ul>
										<input type="hidden" name="attr_althitbullet0" class="hide-on-null" value=""><li>
											<span name="attr_althitbullet0"></span>
										</li>
										<input type="hidden" name="attr_althitbullet1" class="hide-on-null" value=""><li>
											<span name="attr_althitbullet1"></span>
										</li>
										<input type="hidden" name="attr_althitbullet2" class="hide-on-null" value=""><li>
											<span name="attr_althitbullet2"></span>
										</li>
										<input type="hidden" name="attr_althitbullet3" class="hide-on-null" value=""><li>
											<span name="attr_althitbullet3"></span>
										</li>
										<input type="hidden" name="attr_althitbullet4" class="hide-on-null" value=""><li>
											<span name="attr_althitbullet4"></span>
										</li>
									</ul></div>
								</div>
								<input type="hidden" name="attr_altmixed" class="hide-on-null" value=""><div class="result mixed">
									<span name="attr_altmixed"></span>
									<input type="hidden" name="attr_altmixedbullet0" class="hide-on-null" value=""><div><ul>
										<input type="hidden" name="attr_altmixedbullet0" class="hide-on-null" value=""><li>
											<span name="attr_altmixedbullet0"></span>
										</li>
										<input type="hidden" name="attr_altmixedbullet1" class="hide-on-null" value=""><li>
											<span name="attr_altmixedbullet1"></span>
										</li>
										<input type="hidden" name="attr_altmixedbullet2" class="hide-on-null" value=""><li>
											<span name="attr_altmixedbullet2"></span>
										</li>
										<input type="hidden" name="attr_altmixedbullet3" class="hide-on-null" value=""><li>
											<span name="attr_altmixedbullet3"></span>
										</li>
										<input type="hidden" name="attr_altmixedbullet4" class="hide-on-null" value=""><li>
											<span name="attr_altmixedbullet4"></span>
										</li>
									</ul></div>
								</div>
								<input type="hidden" name="attr_altmiss" class="hide-on-null" value=""><div class="result miss">
									<span name="attr_altmiss"></span>
									<input type="hidden" name="attr_altmissbullet0" class="hide-on-null" value=""><div><ul>
										<input type="hidden" name="attr_altmissbullet0" class="hide-on-null" value=""><li>
											<span name="attr_altmissbullet0"></span>
										</li>
										<input type="hidden" name="attr_altmissbullet1" class="hide-on-null" value=""><li>
											<span name="attr_altmissbullet1"></span>
										</li>
										<input type="hidden" name="attr_altmissbullet2" class="hide-on-null" value=""><li>
											<span name="attr_altmissbullet2"></span>
										</li>
										<input type="hidden" name="attr_altmissbullet3" class="hide-on-null" value=""><li>
											<span name="attr_altmissbullet3"></span>
										</li>
										<input type="hidden" name="attr_altmissbullet4" class="hide-on-null" value=""><li>
											<span name="attr_altmissbullet4"></span>
										</li>
									</ul></div>
								</div>
								<input type="hidden" name="attr_end" class="hide-on-null" value=""><div class="indented"><span name="attr_end"></span></div>
								<input type="hidden" name="attr_blankname0" class="hide-on-null" value=""><div class="fill-the-blank">
									<input type="hidden" name="attr_checkbox0" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox0" value="marked" class="checkboxer"><span class="checkboxed"></span></span>
									<span class="bold" name="attr_blankname0"></span>:
									<input type="text" name="attr_blank0" class="fillme">
									<input type="hidden" name="attr_blanksuggestions0" class="hide-on-null" value=""><div class="suggestions examples-list">
										<span name="attr_blanksuggestions0"></span>
									</div>
								</div>
								<input type="hidden" name="attr_blankname1" class="hide-on-null" value=""><div class="fill-the-blank">
									<input type="hidden" name="attr_checkbox1" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox1" value="marked" class="checkboxer"><span class="checkboxed"></span></span>
									<span class="bold" name="attr_blankname1"></span>:
									<input type="text" name="attr_blank1" class="fillme">
									<input type="hidden" name="attr_blanksuggestions1" class="hide-on-null" value=""><div class="suggestions examples-list">
										<span name="attr_blanksuggestions1"></span>
									</div>
								</div>
								<input type="hidden" name="attr_blankname2" class="hide-on-null" value=""><div class="fill-the-blank">
									<input type="hidden" name="attr_checkbox2" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox2" value="marked" class="checkboxer"><span class="checkboxed"></span></span>
									<span class="bold" name="attr_blankname2"></span>:
									<input type="text" name="attr_blank2" class="fillme">
									<input type="hidden" name="attr_blanksuggestions2" class="hide-on-null" value=""><div class="suggestions examples-list">
										<span name="attr_blanksuggestions2"></span>
									</div>
								</div>
								<input type="hidden" name="attr_blankname3" class="hide-on-null" value=""><div class="fill-the-blank">
									<input type="hidden" name="attr_checkbox3" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox3" value="marked" class="checkboxer"><span class="checkboxed"></span></span>
									<span class="bold" name="attr_blankname3"></span>:
									<input type="text" name="attr_blank3" class="fillme">
									<input type="hidden" name="attr_blanksuggestions3" class="hide-on-null" value=""><div class="suggestions examples-list">
										<span name="attr_blanksuggestions3"></span>
									</div>
								</div>
								<input type="hidden" name="attr_blankname4" class="hide-on-null" value=""><div class="fill-the-blank">
									<input type="hidden" name="attr_checkbox4" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox4" value="marked" class="checkboxer"><span class="checkboxed"></span></span>
									<span class="bold" name="attr_blankname4"></span>:
									<input type="text" name="attr_blank4" class="fillme">
									<input type="hidden" name="attr_blanksuggestions4" class="hide-on-null" value=""><div class="suggestions examples-list">
										<span name="attr_blanksuggestions4"></span>
									</div>
								</div>
								<input type="hidden" name="attr_blankname5" class="hide-on-null" value=""><div class="fill-the-blank">
									<input type="hidden" name="attr_checkbox5" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox5" value="marked" class="checkboxer"><span class="checkboxed"></span></span>
									<span class="bold" name="attr_blankname5"></span>:
									<input type="text" name="attr_blank5" class="fillme">
									<input type="hidden" name="attr_blanksuggestions5" class="hide-on-null" value=""><div class="suggestions examples-list">
										<span name="attr_blanksuggestions5"></span>
									</div>
								</div>
								<input type="hidden" name="attr_blankname6" class="hide-on-null" value=""><div class="fill-the-blank">
									<input type="hidden" name="attr_checkbox6" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox6" value="marked" class="checkboxer"><span class="checkboxed"></span></span>
									<span class="bold" name="attr_blankname6"></span>:
									<input type="text" name="attr_blank6" class="fillme">
									<input type="hidden" name="attr_blanksuggestions6" class="hide-on-null" value=""><div class="suggestions examples-list">
										<span name="attr_blanksuggestions6"></span>
									</div>
								</div>
								<input type="hidden" name="attr_blankname7" class="hide-on-null" value=""><div class="fill-the-blank">
									<input type="hidden" name="attr_checkbox7" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox7" value="marked" class="checkboxer"><span class="checkboxed"></span></span>
									<span class="bold" name="attr_blankname7"></span>:
									<input type="text" name="attr_blank7" class="fillme">
									<input type="hidden" name="attr_blanksuggestions7" class="hide-on-null" value=""><div class="suggestions examples-list">
										<span name="attr_blanksuggestions7"></span>
									</div>
								</div>
								<input type="hidden" name="attr_blankname8" class="hide-on-null" value=""><div class="fill-the-blank">
									<input type="hidden" name="attr_checkbox8" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox8" value="marked" class="checkboxer"><span class="checkboxed"></span></span>
									<span class="bold" name="attr_blankname8"></span>:
									<input type="text" name="attr_blank8" class="fillme">
									<input type="hidden" name="attr_blanksuggestions8" class="hide-on-null" value=""><div class="suggestions examples-list">
										<span name="attr_blanksuggestions8"></span>
									</div>
								</div>
								<input type="hidden" name="attr_blankname9" class="hide-on-null" value=""><div class="fill-the-blank">
									<input type="hidden" name="attr_checkbox9" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox9" value="marked" class="checkboxer"><span class="checkboxed"></span></span>
									<span class="bold" name="attr_blankname9"></span>:
									<input type="text" name="attr_blank9" class="fillme">
									<input type="hidden" name="attr_blanksuggestions9" class="hide-on-null" value=""><div class="suggestions examples-list">
										<span name="attr_blanksuggestions9"></span>
									</div>
								</div>
							</div> <!-- /move-long -->
							<input type="hidden" name="attr_modifier-marked" value="">
							<input type="hidden" name="attr_modifierid" value="">
							<input type="hidden" name="attr_condition-marked" value="no" class="hide-on-no">
							<div class="indented"><button type="action" name="act_mark-modifier" class="buttonless">
								<span class="pictos">!</span><span class="bold" data-i18n="Condition is active."></span>
								<span class="bold" name="attr_modifier-marked"></span>
								<span class="bold" data-i18n="Click to toggle."></span>
							</button></div>
							<div class="indented infobar">
								<input type="hidden" name="attr_long" value="no" class="show-on-yes"><div class="expand-toggle-container"><input type="checkbox" name="attr_long-expand" value="yes" class="expand-toggle" checked><span class="expand-toggle-indicator"></span> <span class="expand-toggle-on">▲<span data-i18n="Show Less"></span></span><span class="expand-toggle-off">▼<span data-i18n="Show More"></span></span></div>
								<input type="hidden" name="attr_pbdefault" value="no" class="show-on-yes-combo">
								<input type="checkbox" name="attr_taken" value="yes" class="show-on-unchecked-combo">
								<span>
									<span class="pictos show-following-on-hover">2</span>
									<span data-i18n="This move is marked by default for its playbook."></span>
								</span>
								<input type="hidden" name="attr_pbother" value="yes" class="hide-on-yes other-playbook">
								<span class="pictos show-following-on-hover">!</span> <span data-i18n="This move is not available for other playbooks."></span>
							</div>
						</div></div> <!-- /move /move-compressor -->
					</div> <!-- /move-whole -->
				</fieldset>
			</div>
			<!-- Here ends the monster all-the-moves beast. Too bad we have to replicate it for the basics! -->

			<!-- Here begins the BASIC MOVES section -->

		<input type="checkbox" name="attr_movefilter-hidebasic" value="yes" class="hide-on-checked">
		<div class="allbasic">
			<div class="section-head">
				<span data-i18n="Basic Moves"></span>
			</div>
			<div class="nocontrol moves-all">
				<fieldset class="repeating_basic">
					<input type="hidden" name="attr_subheader" value="" class="hide-on-null">
					<div>
						<input type="hidden" name="attr_show" value="no" class="hide-on-no">
						<div class="section-subhead"><span name="attr_subheader"></span></div>
					</div>
					<input type="hidden" name="attr_instructions" value="" class="hide-on-null">
					<div>
						<input type="hidden" name="attr_show" value="no" class="hide-on-no">
						<div><i><span name="attr_instructions"></span></i></div>
					</div>
					<input type="hidden" name="attr_tracklabel" value="" class="hide-on-null">
					<div class="track">
						<input type="hidden" name="attr_show" value="no" class="hide-on-no">
						<div> <span name="attr_tracklabel" class="bold tracker-label"></span>
							<input type="number" name="attr_tracker" max="4" min="0" value="1" class="fillme tracker-number">
							<input type="hidden" name="attr_tracker" class="tracker"> <span class="tracker-bar"></span> </div>
					</div>
					<input type="hidden" name="attr_body" value="">
					<input type="hidden" name="attr_pbother" value="yes">
					<input type="hidden" name="attr_pbdefault" value="no">
					<input type="hidden" name="attr_name" value="" class="hide-on-null">
					<div class="move-whole">
						<div class="move-compressor">
							<input type="hidden" name="attr_show" value="no" class="hide-on-no">
							<div class="move">
								<div class="right-buttons">
									<input type="hidden" name="attr_rollconfig" value="" class="hide-on-null">
									<button type="roll" class="sheet-2d6-button-nofloat" value="&{template:2d6-roll} {{character=@{character_name}}} {{title=@{name}}} {{roll=[[2d6+?{@{name} using @{rollconfig}}+@{rollprompt}]]}} @{modifier-tally-text}" name="roll_2d6"></button>
									<button type="roll" class="sharemove" style="margin-top: -1px;" value="&{template:sharemove} {{name=@{name}}} {{body=@{body}}} @{shareoptions} }"></button>
									<input type="hidden" name="attr_shareoptions" value=""> </div>
								<span name="attr_name" class="bold"></span>: <span name="attr_body"></span>
								<input type="hidden" name="attr_long" value="yes" class="show-on-yes-combo">
								<input type="checkbox" name="attr_long-expand" value="yes" class="show-on-checked-combo" checked>
								<div class="move-long">
									<input type="hidden" name="attr_preamble" class="hide-on-null" value="">
									<div class="indented"><span name="attr_preamble"></span></div>
									<input type="hidden" name="attr_bullet0" class="hide-on-null" value="">
									<div class="result">
										<ul>
											<input type="hidden" name="attr_bullet0" class="hide-on-null" value="">
											<li> <span name="attr_bullet0"></span> </li>
											<input type="hidden" name="attr_bullet1" class="hide-on-null" value="">
											<li> <span name="attr_bullet1"></span> </li>
											<input type="hidden" name="attr_bullet2" class="hide-on-null" value="">
											<li> <span name="attr_bullet2"></span> </li>
											<input type="hidden" name="attr_bullet3" class="hide-on-null" value="">
											<li> <span name="attr_bullet3"></span> </li>
											<input type="hidden" name="attr_bullet4" class="hide-on-null" value="">
											<li> <span name="attr_bullet4"></span> </li>
										</ul>
									</div>
									<input type="hidden" name="attr_hit" class="hide-on-null" value="">
									<div class="result hit"> <span name="attr_hit"></span>
										<input type="hidden" name="attr_hitbullet0" class="hide-on-null" value="">
										<div>
											<ul>
												<input type="hidden" name="attr_hitbullet0" class="hide-on-null" value="">
												<li> <span name="attr_hitbullet0"></span> </li>
												<input type="hidden" name="attr_hitbullet1" class="hide-on-null" value="">
												<li> <span name="attr_hitbullet1"></span> </li>
												<input type="hidden" name="attr_hitbullet2" class="hide-on-null" value="">
												<li> <span name="attr_hitbullet2"></span> </li>
												<input type="hidden" name="attr_hitbullet3" class="hide-on-null" value="">
												<li> <span name="attr_hitbullet3"></span> </li>
												<input type="hidden" name="attr_hitbullet4" class="hide-on-null" value="">
												<li> <span name="attr_hitbullet4"></span> </li>
											</ul>
										</div>
									</div>
									<input type="hidden" name="attr_mixed" class="hide-on-null" value="">
									<div class="result mixed"> <span name="attr_mixed"></span>
										<input type="hidden" name="attr_mixedbullet0" class="hide-on-null" value="">
										<div>
											<ul>
												<input type="hidden" name="attr_mixedbullet0" class="hide-on-null" value="">
												<li> <span name="attr_mixedbullet0"></span> </li>
												<input type="hidden" name="attr_mixedbullet1" class="hide-on-null" value="">
												<li> <span name="attr_mixedbullet1"></span> </li>
												<input type="hidden" name="attr_mixedbullet2" class="hide-on-null" value="">
												<li> <span name="attr_mixedbullet2"></span> </li>
												<input type="hidden" name="attr_mixedbullet3" class="hide-on-null" value="">
												<li> <span name="attr_mixedbullet3"></span> </li>
												<input type="hidden" name="attr_mixedbullet4" class="hide-on-null" value="">
												<li> <span name="attr_mixedbullet4"></span> </li>
											</ul>
										</div>
									</div>
									<input type="hidden" name="attr_miss" class="hide-on-null" value="">
									<div class="result miss"> <span name="attr_miss"></span>
										<input type="hidden" name="attr_missbullet0" class="hide-on-null" value="">
										<div>
											<ul>
												<input type="hidden" name="attr_missbullet0" class="hide-on-null" value="">
												<li> <span name="attr_missbullet0"></span> </li>
												<input type="hidden" name="attr_missbullet1" class="hide-on-null" value="">
												<li> <span name="attr_missbullet1"></span> </li>
												<input type="hidden" name="attr_missbullet2" class="hide-on-null" value="">
												<li> <span name="attr_missbullet2"></span> </li>
												<input type="hidden" name="attr_missbullet3" class="hide-on-null" value="">
												<li> <span name="attr_missbullet3"></span> </li>
												<input type="hidden" name="attr_missbullet4" class="hide-on-null" value="">
												<li> <span name="attr_missbullet4"></span> </li>
											</ul>
										</div>
									</div>
									<input type="hidden" name="attr_alternative" class="hide-on-null" value="">
									<div class="indented"><span name="attr_alternative"></span></div>
									<input type="hidden" name="attr_altbullet0" class="hide-on-null" value="">
									<div class="result">
										<ul>
											<input type="hidden" name="attr_altbullet0" class="hide-on-null" value="">
											<li> <span name="attr_altbullet0"></span> </li>
											<input type="hidden" name="attr_altbullet1" class="hide-on-null" value="">
											<li> <span name="attr_altbullet1"></span> </li>
											<input type="hidden" name="attr_altbullet2" class="hide-on-null" value="">
											<li> <span name="attr_altbullet2"></span> </li>
											<input type="hidden" name="attr_altbullet3" class="hide-on-null" value="">
											<li> <span name="attr_altbullet3"></span> </li>
											<input type="hidden" name="attr_altbullet4" class="hide-on-null" value="">
											<li> <span name="attr_altbullet4"></span> </li>
										</ul>
									</div>
									<input type="hidden" name="attr_althit" class="hide-on-null" value="">
									<div class="result hit"> <span name="attr_althit"></span>
										<input type="hidden" name="attr_althitbullet0" class="hide-on-null" value="">
										<div>
											<ul>
												<input type="hidden" name="attr_althitbullet0" class="hide-on-null" value="">
												<li> <span name="attr_althitbullet0"></span> </li>
												<input type="hidden" name="attr_althitbullet1" class="hide-on-null" value="">
												<li> <span name="attr_althitbullet1"></span> </li>
												<input type="hidden" name="attr_althitbullet2" class="hide-on-null" value="">
												<li> <span name="attr_althitbullet2"></span> </li>
												<input type="hidden" name="attr_althitbullet3" class="hide-on-null" value="">
												<li> <span name="attr_althitbullet3"></span> </li>
												<input type="hidden" name="attr_althitbullet4" class="hide-on-null" value="">
												<li> <span name="attr_althitbullet4"></span> </li>
											</ul>
										</div>
									</div>
									<input type="hidden" name="attr_altmixed" class="hide-on-null" value="">
									<div class="result mixed"> <span name="attr_altmixed"></span>
										<input type="hidden" name="attr_altmixedbullet0" class="hide-on-null" value="">
										<div>
											<ul>
												<input type="hidden" name="attr_altmixedbullet0" class="hide-on-null" value="">
												<li> <span name="attr_altmixedbullet0"></span> </li>
												<input type="hidden" name="attr_altmixedbullet1" class="hide-on-null" value="">
												<li> <span name="attr_altmixedbullet1"></span> </li>
												<input type="hidden" name="attr_altmixedbullet2" class="hide-on-null" value="">
												<li> <span name="attr_altmixedbullet2"></span> </li>
												<input type="hidden" name="attr_altmixedbullet3" class="hide-on-null" value="">
												<li> <span name="attr_altmixedbullet3"></span> </li>
												<input type="hidden" name="attr_altmixedbullet4" class="hide-on-null" value="">
												<li> <span name="attr_altmixedbullet4"></span> </li>
											</ul>
										</div>
									</div>
									<input type="hidden" name="attr_altmiss" class="hide-on-null" value="">
									<div class="result miss"> <span name="attr_altmiss"></span>
										<input type="hidden" name="attr_altmissbullet0" class="hide-on-null" value="">
										<div>
											<ul>
												<input type="hidden" name="attr_altmissbullet0" class="hide-on-null" value="">
												<li> <span name="attr_altmissbullet0"></span> </li>
												<input type="hidden" name="attr_altmissbullet1" class="hide-on-null" value="">
												<li> <span name="attr_altmissbullet1"></span> </li>
												<input type="hidden" name="attr_altmissbullet2" class="hide-on-null" value="">
												<li> <span name="attr_altmissbullet2"></span> </li>
												<input type="hidden" name="attr_altmissbullet3" class="hide-on-null" value="">
												<li> <span name="attr_altmissbullet3"></span> </li>
												<input type="hidden" name="attr_altmissbullet4" class="hide-on-null" value="">
												<li> <span name="attr_altmissbullet4"></span> </li>
											</ul>
										</div>
									</div>
									<input type="hidden" name="attr_end" class="hide-on-null" value="">
									<div class="indented"><span name="attr_end"></span></div>
									<input type="hidden" name="attr_blankname0" class="hide-on-null" value="">
									<div class="fill-the-blank">
										<input type="hidden" name="attr_checkbox0" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox0" value="marked" class="checkboxer"><span class="checkboxed"></span></span> <span class="bold" name="attr_blankname0"></span>:
										<input type="text" name="attr_blank0" class="fillme">
										<input type="hidden" name="attr_blanksuggestions0" class="hide-on-null" value="">
										<div class="suggestions examples-list"> <span name="attr_blanksuggestions0"></span> </div>
									</div>
									<input type="hidden" name="attr_blankname1" class="hide-on-null" value="">
									<div class="fill-the-blank">
										<input type="hidden" name="attr_checkbox1" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox1" value="marked" class="checkboxer"><span class="checkboxed"></span></span> <span class="bold" name="attr_blankname1"></span>:
										<input type="text" name="attr_blank1" class="fillme">
										<input type="hidden" name="attr_blanksuggestions1" class="hide-on-null" value="">
										<div class="suggestions examples-list"> <span name="attr_blanksuggestions1"></span> </div>
									</div>
									<input type="hidden" name="attr_blankname2" class="hide-on-null" value="">
									<div class="fill-the-blank">
										<input type="hidden" name="attr_checkbox2" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox2" value="marked" class="checkboxer"><span class="checkboxed"></span></span> <span class="bold" name="attr_blankname2"></span>:
										<input type="text" name="attr_blank2" class="fillme">
										<input type="hidden" name="attr_blanksuggestions2" class="hide-on-null" value="">
										<div class="suggestions examples-list"> <span name="attr_blanksuggestions2"></span> </div>
									</div>
									<input type="hidden" name="attr_blankname3" class="hide-on-null" value="">
									<div class="fill-the-blank">
										<input type="hidden" name="attr_checkbox3" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox3" value="marked" class="checkboxer"><span class="checkboxed"></span></span> <span class="bold" name="attr_blankname3"></span>:
										<input type="text" name="attr_blank3" class="fillme">
										<input type="hidden" name="attr_blanksuggestions3" class="hide-on-null" value="">
										<div class="suggestions examples-list"> <span name="attr_blanksuggestions3"></span> </div>
									</div>
									<input type="hidden" name="attr_blankname4" class="hide-on-null" value="">
									<div class="fill-the-blank">
										<input type="hidden" name="attr_checkbox4" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox4" value="marked" class="checkboxer"><span class="checkboxed"></span></span> <span class="bold" name="attr_blankname4"></span>:
										<input type="text" name="attr_blank4" class="fillme">
										<input type="hidden" name="attr_blanksuggestions4" class="hide-on-null" value="">
										<div class="suggestions examples-list"> <span name="attr_blanksuggestions4"></span> </div>
									</div>
									<input type="hidden" name="attr_blankname5" class="hide-on-null" value="">
									<div class="fill-the-blank">
										<input type="hidden" name="attr_checkbox5" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox5" value="marked" class="checkboxer"><span class="checkboxed"></span></span> <span class="bold" name="attr_blankname5"></span>:
										<input type="text" name="attr_blank5" class="fillme">
										<input type="hidden" name="attr_blanksuggestions5" class="hide-on-null" value="">
										<div class="suggestions examples-list"> <span name="attr_blanksuggestions5"></span> </div>
									</div>
									<input type="hidden" name="attr_blankname6" class="hide-on-null" value="">
									<div class="fill-the-blank">
										<input type="hidden" name="attr_checkbox6" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox6" value="marked" class="checkboxer"><span class="checkboxed"></span></span> <span class="bold" name="attr_blankname6"></span>:
										<input type="text" name="attr_blank6" class="fillme">
										<input type="hidden" name="attr_blanksuggestions6" class="hide-on-null" value="">
										<div class="suggestions examples-list"> <span name="attr_blanksuggestions6"></span> </div>
									</div>
									<input type="hidden" name="attr_blankname7" class="hide-on-null" value="">
									<div class="fill-the-blank">
										<input type="hidden" name="attr_checkbox7" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox7" value="marked" class="checkboxer"><span class="checkboxed"></span></span> <span class="bold" name="attr_blankname7"></span>:
										<input type="text" name="attr_blank7" class="fillme">
										<input type="hidden" name="attr_blanksuggestions7" class="hide-on-null" value="">
										<div class="suggestions examples-list"> <span name="attr_blanksuggestions7"></span> </div>
									</div>
									<input type="hidden" name="attr_blankname8" class="hide-on-null" value="">
									<div class="fill-the-blank">
										<input type="hidden" name="attr_checkbox8" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox8" value="marked" class="checkboxer"><span class="checkboxed"></span></span> <span class="bold" name="attr_blankname8"></span>:
										<input type="text" name="attr_blank8" class="fillme">
										<input type="hidden" name="attr_blanksuggestions8" class="hide-on-null" value="">
										<div class="suggestions examples-list"> <span name="attr_blanksuggestions8"></span> </div>
									</div>
									<input type="hidden" name="attr_blankname9" class="hide-on-null" value="">
									<div class="fill-the-blank">
										<input type="hidden" name="attr_checkbox9" value="no" class="hide-on-no hide-on-null"><span><input type="checkbox" name="attr_blankbox9" value="marked" class="checkboxer"><span class="checkboxed"></span></span> <span class="bold" name="attr_blankname9"></span>:
										<input type="text" name="attr_blank9" class="fillme">
										<input type="hidden" name="attr_blanksuggestions9" class="hide-on-null" value="">
										<div class="suggestions examples-list"> <span name="attr_blanksuggestions9"></span> </div>
									</div>
								</div>
								<!-- /move-long -->
								<input type="hidden" name="attr_modifier-marked" value="">
								<input type="hidden" name="attr_modifierid" value="">
								<input type="hidden" name="attr_condition-marked" value="no" class="hide-on-no">
								<div class="indented">
									<button type="action" name="act_mark-modifier" class="buttonless"> <span class="pictos">!</span><span class="bold" data-i18n="Condition is active."></span> <span class="bold" name="attr_modifier-marked"></span> <span class="bold" data-i18n="Click to toggle."></span> </button>
								</div>
								<div class="indented infobar">
									<input type="hidden" name="attr_long" value="no" class="show-on-yes">
									<div class="expand-toggle-container">
										<input type="checkbox" name="attr_long-expand" value="yes" class="expand-toggle" checked><span class="expand-toggle-indicator"></span> <span class="expand-toggle-on">▲<span data-i18n="Show Less"></span></span><span class="expand-toggle-off">▼<span data-i18n="Show More"></span></span>
									</div>
							</div>
						</div>
						<!-- /move /move-compressor -->
					</div>
					<!-- /move-whole -->
				</fieldset>
			</div>
		</div> <!-- /allbasic -->

			<!-- Here ends the BASIC MOVES section -->

			<div>
				<div class="section-head">
					<span data-i18n="Advances"></span>
				</div>
				<div>
					<span data-i18n="When you fill your XP track, you gain an Advance from the list. If you’re playing a single session rather than an ongoing game, you earn an Advance every 3 XP instead of every 5."></span>
				</div>
				<div class="nocontrol">
					<fieldset class="repeating_advances">
						<input type="hidden" name="attr_preamble" class="hide-on-null"><div class="space-below"><span name="attr_preamble"></span></div>
						<div class="move">
							<input type="checkbox" name="attr_taken" value="1" class="checkboxer"><span class="checkboxed"></span>
							<input type="hidden" name="attr_text" value=""><span name="attr_text"></span>
						</div>
					</fieldset>
				</div>
			</div>

		</div> <!-- class="wide" column ends -->
		<div class="standard">

			<div class="section-head">
				<div class="nocontrol popmenu">
					<div class="popmenu-trigger"><span data-i18n="Conditions"></span></div>
					<div class="popmenu-box">
						<span data-i18n="Override penalty value" class="bold"></span>: <input type="number" name="attr_conditions-penalty" value="-2" max="0">
					</div>
				</div>
			</div>
			<div class="nocontrol">
				<fieldset class="repeating_conditions">
					<div class="condition">
						<input type="checkbox" name="attr_marked" value="yes" class="checkboxer"><span class="checkboxed"></span>
						<input type="hidden" name="attr_name" value="">
						<input type="hidden" name="attr_penalty" value="">
						<input type="hidden" name="attr_penalized" value="">
						<input type="hidden" name="attr_moveid" value="">
						<input type="hidden" name="attr_clearwhen" value="">
						<span name="attr_name" class="bold"></span>
						<div class="condition-penalty"> <span name="attr_penalty"></span> <span data-i18n="to"></span> <span name="attr_penalized" class="bold"></span> </div>
						<div><span name="attr_note"></span></div>
						<div class="condition-pop">
							<div> <span name="attr_name" class="bold"></span> </div>
							<div> <span name="attr_penalty"></span> <span data-i18n="to"></span> <span name="attr_penalized" class="bold"></span> </div>
							<div> <span name="attr_clearwhen"></span> </div>
							<div> 
								<span data-i18n="Note to display" class="bold"></span>:
								<input type="text" name="attr_note" class="fillme" style="width: 100px;">
							</div>
						</div>
					</div>
				</fieldset>
			</div>

			<div class="section-head">
				<div class="nocontrol popmenu">
					<div class="popmenu-trigger"><span data-i18n="Modifiers"></span></div>
					<div class="popmenu-box">
						<div class="checkline"><input type="checkbox" name="attr_rollprompt-mods" value="1" checked class="checkboxer"><span class="checkboxed"></span> <span data-i18n="2d6 buttons use checked mods"></span></div>
						<div class="checkline"><input type="checkbox" name="attr_rollprompt-query" value="1" checked class="checkboxer"><span class="checkboxed"></span> <span data-i18n="2d6 buttons prompt for mods"></span></div>
					</div>
				</div>
			</div>
			<div class="nocontrol">
				<fieldset class="repeating_modifiers"><div class="one-line modifier">
					<div class="minimum">
						<input type="checkbox" name="attr_rollmod" value="yes" class="checkboxer"><span class="checkboxed"></span>
					</div>
					<div class="minimum">
						<input type="hidden" name="attr_condition-id" value="">
						<input type="hidden" name="attr_modifier" value="" class="make-plus"><span class="make-plus"></span><input type="number" name="attr_modifier" value="0" class="fillme plus-enabled">
					</div>
					<div class="minimum">
						<input type="hidden" name="attr_statename" value="forward">
						<input type="hidden" name="attr_state" value="forward" class="mod-state-button">
						<button type="action" name="act_state" class="buttonless"><span name="attr_statename"></span></button>
					</div>
					<div class="stretch">
						<input type="text" name="attr_target" value="" class="fillme">
					</div>
					<div class="minimum">
						<input type="hidden" name="attr_used" value="no" class="hide-on-no">
						<button type="action" name="act_trash" class="buttonless trashit"></button>
					</div>
				</div></fieldset>
				<input type="hidden" name="attr_modifier-tally" value="0">
				<input type="hidden" name="attr_modifier-tally-text" value="">
				<input type="hidden" name="attr_modifier-tally-text-memory" value="">
				<input type="hidden" name="attr_stats-query" value=""> <!-- populated during initialization -->
				<div align="center">
					<button type="roll" class="sheet-2d6-button-nofloat" value="&{template:2d6-roll} {{character=@{character_name}}} {{title=Roll with modifiers}} {{roll=[[2d6+?{@{modifier-tally} + @{stats-query}}+@{modifier-tally}]]}} @{modifier-tally-text}" name="roll_2d6-mods"><span class="bold"><span data-i18n="Current tally"></span>: </span><span name="attr_modifier-tally"></span>&nbsp;</button>
				</div>
				<div align="center">
					<button type="action" name="act_mods-checkall" class="buttonless"><span data-i18n="check all"></span></button> / 
					<button type="action" name="act_mods-uncheckall" class="buttonless"><span data-i18n="uncheck all"></span></button>
				</div>
			</div>

			<div class="section-head">
				<span data-i18n="Strings"></span>
			</div>
			<div class="nocontrol">
				<fieldset class="repeating_strings">
					<div class="string">
						<div class="one-line">
							<div class="minimum unpadded">
								<input type="checkbox" name="attr_check1" value="1" class="checkboxer"><span class="checkboxed"></span>
							</div>
							<div class="minimum unpadded">
								<input type="checkbox" name="attr_check2" value="1" class="checkboxer"><span class="checkboxed"></span>
							</div>
							<div class="minimum unpadded">
								<input type="checkbox" name="attr_check3" value="1" class="checkboxer"><span class="checkboxed"></span>
							</div>
							<div class="minimum">
								<input type="checkbox" name="attr_check4" value="1" class="checkboxer"><span class="checkboxed"></span>
							</div>
							<div class="stretch">
								<input type="text" name="attr_target" value="" class="fillme">
							</div>
							<div class="minimum">
								<input type="hidden" name="attr_used" value="no" class="hide-on-no">
								<button type="action" name="act_trash" class="buttonless trashit"></button>
							</div>
						</div>
						<div style="white-space: normal; margin-top: -6px;">
							<input type="checkbox" name="attr_check1" value="1" class="string-mask">
							<input type="checkbox" name="attr_check2" value="1" class="string-mask">
							<input type="checkbox" name="attr_check3" value="1" class="string-mask">
							<input type="checkbox" name="attr_check4" value="1" class="string-mask">
							<div class="string-checked-reveal smallbutton">
								<span class="bold" data-i18n="Spend"></span>:
								<button type="action" name="act_spend3forwardes" class="buttonless smallbutton">+3 <span data-i18n="Emotional Support"></span></button>
								<button type="action" name="act_spend3forwardfo" class="buttonless smallbutton">+3 <span data-i18n="Figure Out"></span></button>
								<button type="action" name="act_spend" class="buttonless smallbutton"><span data-i18n="Other"></span></button>
							</div>
							<input type="checkbox" name="attr_check4" value="1" class="show-on-checked">
							<div class="fourth">
								<span class="bold" data-i18n="Time for a String Advance!"></span>
							</div>
						</div>
						
					</div>
				</fieldset>
			</div>
			<div>
				<span data-i18n="Consult the basic move “Influence with a String” for options to influence others for good or ill. Several basic and playbook moves also have effects upon spending a string."></span> 
				<span data-i18n="Gaining a fourth String on someone triggers a String Advance. The basic moves reference contains details."></span>
			</div>

			<div class="nocontrol">
				<div class="section-head"><span class="bold"><span data-i18n="Relationship Questions"></span></span></div>
				<div>
					<ul>
					<fieldset class="repeating_relationships">
						<input type="hidden" name="attr_text" value="">
							<li><span name="attr_text"></span></li>
					</fieldset>
					</ul>
				</div>
			</div>

			<div class="nocontrol">
				<div class="section-head"><span class="bold"><span data-i18n="Aesthetics"></span></span></div>
				<div>
					<fieldset class="repeating_looks">
						<input type="hidden" name="attr_key" value="">
						<input type="hidden" name="attr_name" value="">
						<input type="hidden" name="attr_examples" value="">
						<div>
							<div><span name="attr_name" class="bold"></span></div>
							<input type="text" name="attr_desc" value="" class="fillme fullwidth">
							<div class="examples-list"><span name="attr_examples"></span></div>
						</div>
					</fieldset>
				</div>
			</div>

			<div class="section-head">
				<span data-i18n="Notes"></span>
			</div>
			<div>
				<textarea name="attr_notes" style="height: 120px;"></textarea>
			</div>

		</div> <!-- class="standard" column ends -->
	</div> <!-- class="columns" ends -->
	
	</div> <!-- div containing the part of the sheet that disappears during initialization -->

</div> <!-- /class=whole (as in, the whole sheet) -->

<rolltemplate class="sheet-rolltemplate-sharemove">
	<div class="sheet-topline">
		{{#name}}**{{name}}**{{/name}} <!--{{#playbook}}**({{playbook}}){{/playbook}}-->
	</div>
	<div class="sheet-move">
		{{#body}}<div>{{body}}</div>{{/body}}
		{{#preamble}}<div class="sheet-indented">{{preamble}}</div>{{/preamble}}
		{{#bullet0}}
			<ul>
				<li>{{bullet0}}</li>
				{{#bullet1}}<li>{{bullet1}}</li>{{/bullet1}}
				{{#bullet2}}<li>{{bullet2}}</li>{{/bullet2}}
				{{#bullet3}}<li>{{bullet3}}</li>{{/bullet3}}
				{{#bullet4}}<li>{{bullet4}}</li>{{/bullet4}}
			</ul>
		{{/bullet0}}
		{{#hit}}
			<div class="sheet-result">
				**10+:** {{hit}}
				{{#hitbullet0}}
					<ul>
						<li>{{hitbullet0}}</li>
						{{#hitbullet1}}<li>{{hitbullet1}}</li>{{/hitbullet1}}
						{{#hitbullet2}}<li>{{hitbullet2}}</li>{{/hitbullet2}}
						{{#hitbullet3}}<li>{{hitbullet3}}</li>{{/hitbullet3}}
						{{#hitbullet4}}<li>{{hitbullet4}}</li>{{/hitbullet4}}
					</ul>
				{{/hitbullet0}}
			</div>
		{{/hit}}
		{{#mixed}}
			<div class="sheet-result">
				**7-9:** {{mixed}}
				{{#mixedbullet0}}
					<ul>
						<li>{{mixedbullet0}}</li>
						{{#mixedbullet1}}<li>{{mixedbullet1}}</li>{{/mixedbullet1}}
						{{#mixedbullet2}}<li>{{mixedbullet2}}</li>{{/mixedbullet2}}
						{{#mixedbullet3}}<li>{{mixedbullet3}}</li>{{/mixedbullet3}}
						{{#mixedbullet4}}<li>{{mixedbullet4}}</li>{{/mixedbullet4}}
					</ul>
				{{/mixedbullet0}}
			</div>
		{{/mixed}}
		{{#miss}}
			<div class="sheet-result">
				**6-:** {{miss}}
				{{#missbullet0}}
					<ul>
						<li>{{missbullet0}}</li>
						{{#missbullet1}}<li>{{missbullet1}}</li>{{/missbullet1}}
						{{#missbullet2}}<li>{{missbullet2}}</li>{{/missbullet2}}
						{{#missbullet3}}<li>{{missbullet3}}</li>{{/missbullet3}}
						{{#missbullet4}}<li>{{missbullet4}}</li>{{/missbullet4}}
					</ul>
				{{/missbullet0}}
			</div>
		{{/miss}}
		{{#alternative}}<div class="sheet-indented">{{alternative}}</div>{{/alternative}}
		{{#altbullet0}}
			<ul>
				<li>{{altbullet0}}</li>
				{{#altbullet1}}<li>{{altbullet1}}</li>{{/altbullet1}}
				{{#altbullet2}}<li>{{altbullet2}}</li>{{/altbullet2}}
				{{#altbullet3}}<li>{{altbullet3}}</li>{{/altbullet3}}
				{{#altbullet4}}<li>{{altbullet4}}</li>{{/altbullet4}}
			</ul>
		{{/altbullet0}}
		{{#althit}}
			<div class="sheet-result">
				**10+:** {{althit}}
				{{#althitbullet0}}
					<ul>
						<li>{{althitbullet0}}</li>
						{{#althitbullet1}}<li>{{althitbullet1}}</li>{{/althitbullet1}}
						{{#althitbullet2}}<li>{{althitbullet2}}</li>{{/althitbullet2}}
						{{#althitbullet3}}<li>{{althitbullet3}}</li>{{/althitbullet3}}
						{{#althitbullet4}}<li>{{althitbullet4}}</li>{{/althitbullet4}}
					</ul>
				{{/althitbullet0}}
			</div>
		{{/althit}}
		{{#altmixed}}
			<div class="sheet-result">
				**7-9:** {{altmixed}}
				{{#altmixedbullet0}}
					<ul>
						<li>{{altmixedbullet0}}</li>
						{{#altmixedbullet1}}<li>{{altmixedbullet1}}</li>{{/altmixedbullet1}}
						{{#altmixedbullet2}}<li>{{altmixedbullet2}}</li>{{/altmixedbullet2}}
						{{#altmixedbullet3}}<li>{{altmixedbullet3}}</li>{{/altmixedbullet3}}
						{{#altmixedbullet4}}<li>{{altmixedbullet4}}</li>{{/altmixedbullet4}}
					</ul>
				{{/altmixedbullet0}}
			</div>
		{{/altmixed}}
		{{#altmiss}}
			<div class="sheet-result">
				**6-:** {{altmiss}}
				{{#altmissbullet0}}
					<ul>
						<li>{{altmissbullet0}}</li>
						{{#altmissbullet1}}<li>{{altmissbullet1}}</li>{{/altmissbullet1}}
						{{#altmissbullet2}}<li>{{altmissbullet2}}</li>{{/altmissbullet2}}
						{{#altmissbullet3}}<li>{{altmissbullet3}}</li>{{/altmissbullet3}}
						{{#altmissbullet4}}<li>{{altmissbullet4}}</li>{{/altmissbullet4}}
					</ul>
				{{/altmissbullet0}}
			</div>
		{{/altmiss}}
		{{#end}}<div class="sheet-indented">{{end}}</div>{{/end}}
		{{#blankname0}}<div class="sheet-space-above">**{{blankname0}}**: {{#blank0}}{{blank0}}{{/blank0}}</div>{{/blankname0}}
		{{#blankname1}}<div class="sheet-space-above">**{{blankname1}}**: {{#blank1}}{{blank1}}{{/blank1}}</div>{{/blankname1}}
		{{#blankname2}}<div class="sheet-space-above">**{{blankname2}}**: {{#blank2}}{{blank2}}{{/blank2}}</div>{{/blankname2}}
		{{#blankname3}}<div class="sheet-space-above">**{{blankname3}}**: {{#blank3}}{{blank3}}{{/blank3}}</div>{{/blankname3}}
		{{#blankname4}}<div class="sheet-space-above">**{{blankname4}}**: {{#blank4}}{{blank4}}{{/blank4}}</div>{{/blankname4}}
		{{#blankname5}}<div class="sheet-space-above">**{{blankname5}}**: {{#blank5}}{{blank5}}{{/blank5}}</div>{{/blankname5}}
		{{#blankname6}}<div class="sheet-space-above">**{{blankname6}}**: {{#blank6}}{{blank6}}{{/blank6}}</div>{{/blankname6}}
		{{#blankname7}}<div class="sheet-space-above">**{{blankname7}}**: {{#blank7}}{{blank7}}{{/blank7}}</div>{{/blankname7}}
		{{#blankname8}}<div class="sheet-space-above">**{{blankname8}}**: {{#blank8}}{{blank8}}{{/blank8}}</div>{{/blankname8}}
		{{#blankname9}}<div class="sheet-space-above">**{{blankname9}}**: {{#blank9}}{{blank9}}{{/blank9}}</div>{{/blankname9}}
	</div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-2d6-roll">
	<div class="sheet-topline">
		{{#character}}**{{character}}**:{{/character}}
		{{#title}}**{{title}}**{{/title}}
	</div>
	<div class="sheet-dice">
			{{#rollGreater() roll 9}}
		<div class="sheet-dieroll-hit">
				<div class="sheet-dieroll-roll">{{roll}}</div>
		</div>
		<div class="sheet-dieroll-title">
			<span data-i18n="Up Beat"></span>
		</div>
			{{/rollGreater() roll 9}}
			{{#rollBetween() roll 7 9}}
		<div class="sheet-dieroll-mixed">
				<div class="sheet-dieroll-roll">{{roll}}</div>
		</div>
		<div class="sheet-dieroll-title">
			<span data-i18n="Mixed Beat"></span>
		</div>
			{{/rollBetween() roll 7 9}}
			{{#rollLess() roll 7}}
		<div class="sheet-dieroll-miss">
				<div class="sheet-dieroll-roll">{{roll}}</div>
		</div>
		<div class="sheet-dieroll-title">
			<span data-i18n="Down Beat"></span>
		</div>
		<div class="sheet-clearance sheet-dieroll-reminder" style="margin-bottom: 6px;">
			<span data-i18n="Make sure to mark experience!"></span>
		</div>
			{{/rollLess() roll 7}}
		{{#allprops() character title roll}}
			<div style="color: white; font: 90%; text-align: left;"><span style="font-family: Pictos">2</span> {{value}}</div>
		{{/allprops() character title roll}}
	<div class="sheet-clearance"></div>
	</div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-introducer">
<div style="border-top: 1px solid black;">**{{character}}, {{playbook}}** {{#pronouns}}(*{{pronouns}}*){{/pronouns}}</div>
{{#stats}}<div>*{{stats}}*</div>{{/stats}}
{{#moves}}<div>**<span data-i18n="Moves"></span>:** *{{moves}}*</div>{{/moves}}
<div style="border-bottom: 1px solid black;">{{aesthetics}}</div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-datadumper">
	{{#allprops()}}
		<div>**{{key}}:** {{value}} </div>
	{{/allprops()}}
</rolltemplate>