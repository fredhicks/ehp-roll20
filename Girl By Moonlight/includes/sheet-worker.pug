script(type="text/worker")
	-
		// This part is run in pug
		var pbkeys = [
			"Enigma", 
			"Stranger", 
			"TimeTraveller", 
			"Harmony", 
			"Guardian", 
			"Outsider", 
			"UnlikelyHero"
		];
		var toggles = [
			"Toggle-Bio-Expand",
			"Toggle-Abilities-Expand",
			"Toggle-Abilities-Marked",
			"Ability-Veteran",
			"Toggle-Transcendent-Expand",
			"Toggle-Transcendent-Marked",
		];
		var toggleclicks = "";
		var clicks = 0;
		for(var i = 1; i < 10; i++) {
			for(var pb of pbkeys) {
				var field = 'Ability-' + pb + '-' + i;
				toggles.push(field);
				field = 'Ability-Transcendent-' + pb + '-' + i;
				toggles.push(field);
			}
		}
		for(var i of toggles) {
			clicks++;
			if ( clicks > 1 )
				toggleclicks = toggleclicks + " ";
			toggleclicks = toggleclicks + "clicked:" + i;
		}
	.
		
		// This part is run in the sheetworker javascript
		on("#{toggleclicks}", function(e) {
			log(e);
			var id = "";
			if ( typeof e.sourceAttribute !== "undefined" && e.sourceAttribute !== "" ) {
				id = e.sourceAttribute;
			} else {
				id = (e.htmlAttributes.name).substring(4); // Strips off the 'act_'
			}
			log("Toggle Handler: " + id);
			getAttrs([id], function(a) {
				if ( a[id] === "1" ) {
					a[id] = "0";
				} else {
					a[id] = "1";
				}
				log(a);
				setAttrs(a);
			});
		});
		
		on("change:Choose-Veteran-Ability", function(e) {
			log(e);
			// e.previousValue
			// e.newValue
			var atts = {};
			if ( typeof(e.newValue) == "undefined" || e.newValue == "" || e.newValue == "0") {
				atts["Choose-Veteran-Ability"] = "";
				atts["Ability-Veteran-Name"] = "";
				atts["Ability-Veteran-Effect"] = "";
			} else {
				var parts = String(e.newValue).split("|");
				var name = parts[0];
				var effect = parts[1];
				var tf = parts[2];
				atts["Ability-Veteran-Name"] = getTranslationByKey(name);
				atts["Ability-Veteran-Effect"] = getTranslationByKey(effect);
				atts["Ability-Veteran-Has-Text"] = tf;
			}
			setAttrs(atts);
		});

		on("change:Choose-Ability-Transcendent-UnlikelyHero-1 change:Choose-Ability-Transcendent-UnlikelyHero-2 change:Choose-Ability-Transcendent-UnlikelyHero-3", function(e) {
			log(e);
			// e.sourceAttribute
			var abroot = String(e.sourceAttribute).slice(7); // Should remove 'Choose-' from the front of it
			// e.previousValue
			// e.newValue
			var atts = {};
			if ( typeof(e.newValue) == "undefined" || e.newValue == "" || e.newValue == "0") {
				atts[e.sourceAttribute] = "";
				atts[abroot+"-Name"] = "";
				atts[abroot+"-Effect"] = "";
			} else {
				var parts = String(e.newValue).split("|");
				var name = parts[0];
				var effect = parts[1];
				var tf = parts[2];
				atts[abroot+"-Name"] = getTranslationByKey(name);
				atts[abroot+"-Effect"] = getTranslationByKey(effect);
				atts[abroot+"-Has-Text"] = tf;
			}
			setAttrs(atts);
		});

// Choose-Transcendent-Ability-UnlikelyHero-1