script(type="text/worker")
	-
		// This part is run in pug
		// found in variables.pug:
			// pbkeys (array-within-pug)
			// toggles (array-within-pug) 
			// stressfields (string that contains an array once used in javascript below)
			// toggleclicks (string)
			// stressclicks (string)
	.
		
		// This part is run in the sheetworker javascript
		on("#{toggleclicks}", function(e) {
			log(e);
			var id = "";
			if ( typeof e.sourceAttribute !== "undefined" && e.sourceAttribute !== "" ) {
				id = e.sourceAttribute;
			} else {
				id = (e.htmlAttributes.name).substring(4); // Strips off the 'act_'
			}
			log("Toggle Handler: " + id);
			getAttrs([id], function(a) {
				if ( a[id] === "1" ) {
					a[id] = "0";
				} else {
					a[id] = "1";
				}
				log(a);
				setAttrs(a);
			});
		});

		on("change:Choose-Veteran-Ability", function(e) {
			log(e);
			// e.previousValue
			// e.newValue
			var atts = {};
			if ( typeof(e.newValue) == "undefined" || e.newValue == "" || e.newValue == "0") {
				atts["Choose-Veteran-Ability"] = "";
				atts["Ability-Veteran-Name"] = "";
				atts["Ability-Veteran-Effect"] = "";
			} else {
				var parts = String(e.newValue).split("|");
				var name = parts[0];
				var effect = parts[1];
				var tf = parts[2];
				atts["Ability-Veteran-Name"] = getTranslationByKey(name);
				atts["Ability-Veteran-Effect"] = getTranslationByKey(effect);
				atts["Ability-Veteran-Has-Text"] = tf;
			}
			setAttrs(atts);
		});

		on("change:Choose-Ability-Transcendent-UnlikelyHero-1 change:Choose-Ability-Transcendent-UnlikelyHero-2 change:Choose-Ability-Transcendent-UnlikelyHero-3", function(e) {
			log(e);
			// e.sourceAttribute
			var abroot = String(e.sourceAttribute).slice(7); // Should remove 'Choose-' from the front of it
			// e.previousValue
			// e.newValue
			var atts = {};
			if ( typeof(e.newValue) == "undefined" || e.newValue == "" || e.newValue == "0") {
				atts[e.sourceAttribute] = "";
				atts[abroot+"-Name"] = "";
				atts[abroot+"-Effect"] = "";
			} else {
				var parts = String(e.newValue).split("|");
				var name = parts[0];
				var effect = parts[1];
				var tf = parts[2];
				atts[abroot+"-Name"] = getTranslationByKey(name);
				atts[abroot+"-Effect"] = getTranslationByKey(effect);
				atts[abroot+"-Has-Text"] = tf;
			}
			setAttrs(atts);
		});

		on("#{stressclicks}", function(e) {
			log(e);
			var id = "";
			id = (e.htmlAttributes.name).substring(4); // Strips off the 'act_'
			log("Stress Toggle Handler: " + id);
			getAttrs(!{stressfields}, function(a) {
				if ( Number(a[id]) === 1 ) {
					log(id+"=1");
					a[id] = "0";
					// We want to empty others past the one turned on
					var endnum = Number(id.substring('7')); // Strips off the 'Stress-'
					for(i = endnum; i <= 9; i++) {
						log('Setting Stress-'+i+"=0")
						a['Stress-'+i] = 0;
					}
				} else {
					log(id+"=0");
					a[id] = "1";
					// We want to fill others up to the one turned on
					var endnum = Number(id.substring('7')); // Strips off the 'Stress-'
					for(i = 1; i < endnum; i++) {
						log('Setting Stress-'+i+"=1")
						a['Stress-'+i] = 1;
					}
				}
				var st = 0;
				for(i = 1; i <= 9; i++) {
					st = st + Number(a['Stress-'+i]);
				}
				a['Stress-Total'] = st;
				if ( a['Stress-9'] == 1) {
					a['Toggle-Eclipse-Expand'] = 0;
				}
				log(a);
				setAttrs(a);
			});
		});

		on("#{transclicks}", function(e) {
			log(e);
			var id = "";
			id = (e.htmlAttributes.name).substring(4); // Strips off the 'act_'
			log("Transcendence Toggle Handler: " + id);
			getAttrs(!{transfields}, function(a) {
				if ( Number(a[id]) === 1 ) {
					log(id+"=1");
					a[id] = "0";
					// We want to empty others past the one turned on
					var endnum = Number(id.substring('14')); // Strips off the 'Transcendence-'
					for(i = endnum; i <= 4; i++) {
						log('Setting Transcendence-'+i+"=0")
						a['Transcendence-'+i] = 0;
					}
				} else {
					log(id+"=0");
					a[id] = "1";
					// We want to fill others up to the one turned on
					var endnum = Number(id.substring('14')); // Strips off the 'Transcendence-'
					for(i = 1; i < endnum; i++) {
						log('Setting Transcendence-'+i+"=1")
						a['Transcendence-'+i] = 1;
					}
				}
				var st = 0;
				for(i = 1; i <= 4; i++) {
					st = st + Number(a['Transcendence-'+i]);
				}
				a['Transcendence-Total'] = st;
				log(a);
				setAttrs(a);
			});
		});

		on("#{linkclicks}", function(e) {
			log(e);
			var id = "";
			id = (e.htmlAttributes.name).substring(4); // Strips off the 'act_'
			var prefix = id.substring(0,id.length-6); // Strips off the -Dot-X
			log("Link Toggle Handler: " + prefix + "|" + id);
			getAttrs(!{linkfields}, function(a) {
				if ( Number(a[id]) === 1 ) {
					log(id+"=1");
					a[id] = "0";
					// We want to empty others past the one turned on
					var endnum = Number(id.substring('11')); // Strips off the 'Link-X-Dot-'
					for(i = endnum; i <= 6; i++) {
						log('Setting '+prefix+'-Dot-'+i+"=0")
						a[prefix+'-Dot-'+i] = 0;
					}
				} else {
					log(id+"=0");
					a[id] = "1";
					// We want to fill others up to the one turned on
					var endnum = Number(id.substring('11')); // Strips off the 'Link-X-Dot-'
					for(i = 1; i < endnum; i++) {
						log('Setting '+prefix+'-Dot-'+i+"=1")
						a[prefix+'-Dot-'+i] = 1;
					}
				}
				// 
				var st = 0;
				for(i = 1; i <= 6; i++) {
					st = st + Number(a[prefix+'-Dot-'+i]);
				}
				a[prefix+'-Total'] = st;
				log(a);
				setAttrs(a);
			});
		});

		on("#{pbxpclicks}", function(e) {
			log(e);
			var id = "";
			id = (e.htmlAttributes.name).substring(4); // Strips off the 'act_'
			log("Playbook-XP Toggle Handler: " + id);
			getAttrs(!{pbxpfields}, function(a) {
				if ( Number(a[id]) === 1 ) {
					log(id+"=1");
					a[id] = "0";
					// We want to empty others past the one turned on
					var endnum = Number(id.substring('12')); // Strips off the 'Playbook-XP-'
					for(i = endnum; i <= 8; i++) {
						log('Setting Playbook-XP-'+i+"=0")
						a['Playbook-XP-'+i] = 0;
					}
				} else {
					log(id+"=0");
					a[id] = "1";
					// We want to fill others up to the one turned on
					var endnum = Number(id.substring('12')); // Strips off the 'Playbook-XP-'
					for(i = 1; i < endnum; i++) {
						log('Setting Playbook-XP-'+i+"=1")
						a['Playbook-XP-'+i] = 1;
					}
				}
				var st = 0;
				for(i = 1; i <= 8; i++) {
					st = st + Number(a['Playbook-XP-'+i]);
				}
				a['Playbook-XP-Total'] = st;
				log(a);
				setAttrs(a);
			});
		});

		on("#{sunclicks}", function(e) {
			log(e);
			var id = "";
			id = (e.htmlAttributes.name).substring(4); // Strips off the 'act_'
			log("Sun-XP Toggle Handler: " + id);
			getAttrs(!{sunfields}, function(a) {
				if ( Number(a[id]) === 1 ) {
					log(id+"=1");
					a[id] = "0";
					// We want to empty others past the one turned on
					var endnum = Number(id.substring('7')); // Strips off the 'Sun-XP-'
					for(i = endnum; i <= 6; i++) {
						log('Setting Sun-XP-'+i+"=0")
						a['Sun-XP-'+i] = 0;
					}
				} else {
					log(id+"=0");
					a[id] = "1";
					// We want to fill others up to the one turned on
					var endnum = Number(id.substring('7')); // Strips off the 'Sun-XP-'
					for(i = 1; i < endnum; i++) {
						log('Setting Sun-XP-'+i+"=1")
						a['Sun-XP-'+i] = 1;
					}
				}
				var st = 0;
				for(i = 1; i <= 6; i++) {
					st = st + Number(a['Sun-XP-'+i]);
				}
				a['Sun-XP-Total'] = st;
				log(a);
				setAttrs(a);
			});
		});

		on("#{moonclicks}", function(e) {
			log(e);
			var id = "";
			id = (e.htmlAttributes.name).substring(4); // Strips off the 'act_'
			log("Moon-XP Toggle Handler: " + id);
			getAttrs(!{moonfields}, function(a) {
				if ( Number(a[id]) === 1 ) {
					log(id+"=1");
					a[id] = "0";
					// We want to empty others past the one turned on
					var endnum = Number(id.substring('8')); // Strips off the 'Moon-XP-'
					for(i = endnum; i <= 6; i++) {
						log('Setting Moon-XP-'+i+"=0")
						a['Moon-XP-'+i] = 0;
					}
				} else {
					log(id+"=0");
					a[id] = "1";
					// We want to fill others up to the one turned on
					var endnum = Number(id.substring('8')); // Strips off the 'Moon-XP-'
					for(i = 1; i < endnum; i++) {
						log('Setting Moon-XP-'+i+"=1")
						a['Moon-XP-'+i] = 1;
					}
				}
				var st = 0;
				for(i = 1; i <= 6; i++) {
					st = st + Number(a['Moon-XP-'+i]);
				}
				a['Moon-XP-Total'] = st;
				log(a);
				setAttrs(a);
			});
		});

		on("#{starsclicks}", function(e) {
			log(e);
			var id = "";
			id = (e.htmlAttributes.name).substring(4); // Strips off the 'act_'
			log("Stars-XP Toggle Handler: " + id);
			getAttrs(!{starsfields}, function(a) {
				if ( Number(a[id]) === 1 ) {
					log(id+"=1");
					a[id] = "0";
					// We want to empty others past the one turned on
					var endnum = Number(id.substring('9')); // Strips off the 'Stars-XP-'
					for(i = endnum; i <= 6; i++) {
						log('Setting Stars-XP-'+i+"=0")
						a['Stars-XP-'+i] = 0;
					}
				} else {
					log(id+"=0");
					a[id] = "1";
					// We want to fill others up to the one turned on
					var endnum = Number(id.substring('9')); // Strips off the 'Stars-XP-'
					for(i = 1; i < endnum; i++) {
						log('Setting Stars-XP-'+i+"=1")
						a['Stars-XP-'+i] = 1;
					}
				}
				var st = 0;
				for(i = 1; i <= 6; i++) {
					st = st + Number(a['Stars-XP-'+i]);
				}
				a['Stars-XP-Total'] = st;
				log(a);
				setAttrs(a);
			});
		});

